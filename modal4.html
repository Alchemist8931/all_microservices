<!-- ========= modal4.html  (Проект 4) =========   -->
<div id="modal4-container" class="modal4-shell">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    #modal4-container {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      width: 100%;
      height: 100vh;
      padding: 20px 0;
      margin: 0;
      box-sizing: border-box;
      color: var(--content-color, #212121);
      font-family: 'Comfortaa', sans-serif;
    }
    #modal4-container .glass-panel {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--content-color, #212121);
      border-radius: 12px;
      box-shadow:
        0 0 0.75px hsl(205 20% 10% / 0.24),
        0.7px 0.8px 1.2px -0.4px hsl(205 20% 10% / 0.16),
        1.3px 1.5px 2.2px -0.8px hsl(205 20% 10% / 0.16),
        2.3px 2.6px 3.9px -1.2px hsl(205 20% 10% / 0.16),
        3.9px 4.4px 6.6px -1.7px hsl(205 20% 10% / 0.16),
        6.5px 7.2px 10.9px -2.1px hsl(205 20% 10% / 0.18);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
    }

    #modal4-container .modal-top {
      width: 1930px;
      max-width: 90vw;
      height: 255px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: -20px;
      padding: 10px;
      box-sizing: border-box;
      color: var(--black-color, var(--content-color, #212121));
      position: relative;
    }

    #modal4-container .modal4-signature {
      position: absolute;
      top: 10px;
      left: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    #modal4-container .modal4-signature h2 {
      margin: 0;
      font-size: 1.4em;
      color: #212121;
      text-transform: uppercase;
      display: flex;
      gap: 2px;
    }

    #modal4-container .modal4-signature h2 span {
      transition: 1.5s;
      display: inline-block;
    }

    #modal4-container .modal4-signature h2:hover span {
      filter: blur(20px);
      opacity: 0;
      transform: scale(2);
    }

    #modal4-container .modal4-signature h2 span:nth-child(1) { transition-delay: 0s; }
    #modal4-container .modal4-signature h2 span:nth-child(2) { transition-delay: 0.1s; }
    #modal4-container .modal4-signature h2 span:nth-child(3) { transition-delay: 0.2s; }
    #modal4-container .modal4-signature h2 span:nth-child(4) { transition-delay: 0.3s; }
    #modal4-container .modal4-signature h2 span:nth-child(5) { transition-delay: 0.4s; }
    #modal4-container .modal4-signature h2 span:nth-child(6) { transition-delay: 0.5s; }
    #modal4-container .modal4-signature h2 span:nth-child(7) { transition-delay: 0.6s; }
    #modal4-container .modal4-signature h2 span:nth-child(8) { transition-delay: 0.7s; }
    #modal4-container .modal4-signature h2 span:nth-child(9) { transition-delay: 0.8s; }
    #modal4-container .modal4-signature h2 span:nth-child(10) { transition-delay: 0.9s; }
    #modal4-container .modal4-signature h2 span:nth-child(11) { transition-delay: 1s; }
    #modal4-container .modal4-signature h2 span:nth-child(12) { transition-delay: 1.1s; }
    #modal4-container .modal4-signature h2 span:nth-child(13) { transition-delay: 1.2s; }
    #modal4-container .modal4-signature h2 span:nth-child(14) { transition-delay: 1.3s; }
    #modal4-container .modal4-signature h2 span:nth-child(15) { transition-delay: 1.4s; }
    #modal4-container .modal4-signature h2 span:nth-child(16) { transition-delay: 1.5s; }

    #modal4-container .modal-bottom {
      width: 1930px;
      max-width: 90vw;
      padding: 20px;
      padding-right: 10px;
      box-sizing: border-box;
      margin-right: 0;
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 260px;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-height: calc(100vh - 220px);
      color: var(--black-color, var(--content-color, #212121));
    }

    #modal4-container .modalVNUT-content {
      height: 100%;
      width: 100%;
      overflow-y: auto;
      padding-right: 10px;
      margin-right: -10px;
      box-sizing: border-box;
    }

    #modal4-container .modalVNUT-content::-webkit-scrollbar {
      width: 6px;
      background-color: rgba(0, 0, 0, 0.08);
      border-radius: 20px;
    }
    #modal4-container .modalVNUT-content::-webkit-scrollbar-thumb {
      background-color: var(--content-color, #212121);
      border-radius: 20px;
    }

    #modal4-container .modalRow {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 14px;
    }

    #modal4-container .modalRow [data-field="date-time"] {
      text-align: right;
    }

    #modal4-container .stats-row {
      justify-content: space-between;
      gap: 16px;
    }

    #modal4-container .stat-card {
      flex: 1;
      min-width: 240px;
      padding: 18px 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
    }

    #modal4-container .stat-title {
      text-transform: uppercase;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--content-color, #212121);
    }

    #modal4-container .stat-value {
      font-size: 32px;
      font-weight: 700;
      line-height: 1.2;
      margin-top: 12px;
      color: var(--content-color, #212121);
    }

    #modal4-container .action-bar {
      justify-content: flex-end;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-6px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    #modal4-container .action-bar.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    #modal4-container .form-row {
      align-items: stretch;
      gap: 18px;
    }

    #modal4-container .form-fields {
      flex: 1;
      padding: 18px 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #modal4-container .form-fields .modalRow {
      gap: 12px;
    }

    #modal4-container .modalVNUT-content .modalBLOCK {
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      margin-bottom: 12px;
    }

    #modal4-container .modalVNUT-content .modalBLOCK:hover {
      /* transform: translateY(-2px); */
    }

    #modal4-container .modalVNUT-content .modalBLOCK.appear {
      opacity: 0;
      transform: translateY(-16px);
    }

    #modal4-container .modalVNUT-content .modalBLOCK.appear-active {
      opacity: 1;
      transform: translateY(0);
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    #modal4-container .inputT,
    #modal4-container .input,
    #modal4-container .inputSUM {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid #212121;
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--content-color, #212121);
      transition: border-color 0.3s ease, transform 0.2s ease;
      font-variant-numeric: tabular-nums;
    }

    #modal4-container .inputT:focus,
    #modal4-container .input:focus,
    #modal4-container .inputSUM:focus {
      border-color: var(--content-color, #30333C);
      background: rgba(255, 255, 255, 0.12);
    }

    #modal4-container .inputSUM {
      text-align: right;
      width: 116px;
    }

    #modal4-container .code-field { width: 130px; text-transform: uppercase; }
    #modal4-container .name-field { width: 340px; }
    #modal4-container .url-field { width: 200px; }
    #modal4-container .supplier-field { width: 220px; }
    #modal4-container .select-wrapper { width: 100px; position: relative; }

    #modal4-container .button-form {
      position: relative;
      min-width: 220px;
      height: 33px;
      background: var(--content-color, #212121);
      border: 1px solid var(--content-color, #212121);
      color: var(--fon, #f5f5f5);
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-top: 15px;
    }

    #modal4-container .button-form:hover {
      color: var(--content-color, #212121);
      background: rgba(255, 255, 255, 0.12);
    }

    #modal4-container .button-form.primary {
      min-width: 280px;
    }

    #modal4-container .spec-icon {
      color: var(--content-color, #212121);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    #modal4-container .spec-icon:hover {
      color: rgba(98, 90, 86, 0.85);
      transform: scale(1.05);
    }

    #modal4-container label.checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #modal4-container .checkbox input[type="checkbox"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid var(--content-color, #212121);
      border-radius: 4px;
      position: relative;
      cursor: pointer;
      background: transparent;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    #modal4-container .checkbox input[type="checkbox"]:checked {
      background: var(--content-color, #212121);
    }

    #modal4-container .checkbox input[type="checkbox"]::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 8px;
      height: 8px;
      transform: translate(-50%, -50%) scale(0);
      background: var(--fon, #f5f5f5);
      border-radius: 2px;
      transition: transform 0.2s ease;
    }

    #modal4-container .checkbox input[type="checkbox"]:checked::after {
      transform: translate(-50%, -50%) scale(1);
    }

    #modal4-select-overlay {
      position: absolute;
      inset: 0;
      background: transparent;
      z-index: 9998;
      display: none;
    }

    #modal4-global-select-dropdown,
    #modal4-autocomplete-dropdown {
      position: absolute;
      max-height: 240px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: opacity 1s ease, transform 1s ease, visibility 0s linear 1s;
      z-index: 9999;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #212121;
      border-radius: 10px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
      color: var(--content-color, #212121);
      backdrop-filter: blur(6px);
      padding: 6px 0;
    }

    #modal4-global-select-dropdown.show,
    #modal4-autocomplete-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      transition: opacity 1s ease, transform 1s ease, visibility 0s linear 0s;
    }

    #modal4-global-select-dropdown::-webkit-scrollbar,
    #modal4-autocomplete-dropdown::-webkit-scrollbar {
      width: 6px;
      background: transparent;
    }

    #modal4-global-select-dropdown::-webkit-scrollbar-track,
    #modal4-autocomplete-dropdown::-webkit-scrollbar-track {
      background: transparent;
    }

    #modal4-global-select-dropdown::-webkit-scrollbar-thumb,
    #modal4-autocomplete-dropdown::-webkit-scrollbar-thumb {
      background: var(--content-color, #212121);
      border-radius: 10px;
    }

    #modal4-global-select-dropdown .select-group-title {
      padding: 6px 12px 4px;
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(33, 33, 33, 0.65);
    }

    #modal4-global-select-dropdown .select-option,
    #modal4-autocomplete-dropdown .ac-option {
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #modal4-global-select-dropdown .select-option:hover,
    #modal4-autocomplete-dropdown .ac-option:hover {
      background: rgba(0, 0, 0, 0.08);
    }

    #modal4-global-select-dropdown .select-option .select-option-title {
      font-weight: 600;
      color: var(--content-color, #212121);
    }

    #modal4-global-select-dropdown .select-option .select-option-hint {
      font-size: 11px;
      color: rgba(33, 33, 33, 0.65);
      font-variant-numeric: tabular-nums;
    }

    #modal4-autocomplete-dropdown .ac-option {
      justify-content: flex-start;
    }

    @keyframes digit-glow {
      0% {
        opacity: 0;
        transform: translateY(-0.4em);
        text-shadow: 0 0 2px rgba(0, 0, 0, 0.15);
      }
      60% {
        opacity: 1;
        transform: translateY(0);
        text-shadow: 0 0 8px rgba(0, 0, 0, 0.25);
      }
      100% {
        opacity: 1;
        text-shadow: none;
      }
    }

    #modal4-container .stat-value span {
      display: inline-block;
      animation: digit-glow 0.6s cubic-bezier(0.19, 1, 0.22, 1) both;
    }
  </style>

  <div id="modal4-select-overlay"></div>
  <div id="modal4-global-select-dropdown"></div>
  <div id="modal4-autocomplete-dropdown"></div>

  <div class="modal-top glass-panel">
    <section class="modal4-signature">
      <h2>
        <span>R</span>
        <span>I</span>
        <span>V</span>
        <span>A</span>
        <span>&nbsp;&nbsp;</span>
        <span>D</span>
        <span>E</span>
        <span>V</span>
        <span>E</span>
        <span>L</span>
        <span>O</span>
        <span>P</span>
        <span>M</span>
        <span>E</span>
        <span>N</span>
        <span>T</span>
      </h2>
    </section>

    <div class="modalRow action-bar">
      <button class="button-form" id="move-warehouse">переместить на склад</button>
      <button class="button-form" id="delete-selected">удалить выбранное</button>
    </div>

    <div class="modalRow form-row" style="margin-top: 116px;">
      <div class="modalBLOCK form-fields">
        <div class="modalRow" style="margin-left: -20px;">
          <input class="inputT code-field" placeholder="RIV-0881" />
          <input class="input name-field" placeholder="наименование позиции" />
          <input class="inputT url-field" placeholder="URL" />
          <input class="inputT supplier-field" placeholder="поставщик" />
          <div class="select-wrapper">
            <input class="input select-input" style="width: 100px;" placeholder="изм." readonly />
          </div>
          <input class="inputSUM qty-field" placeholder="000 000" />
          <input class="inputSUM price-field" placeholder="000 000 000" />
        </div>
      </div>
      <button class="button-form primary" id="create-order">создать позицию заказа</button>
    </div>
  </div>

  <div class="modal-bottom glass-panel">
    <div class="modalVNUT-content"></div>
  </div>

  <template id="modal4-order-template">
    <div class="modalBLOCK" data-id="" data-price="">
      <div class="modalRow">
        <label class="checkbox">
          <input type="checkbox" />
        </label>
        <input class="inputT code-field" data-field="order_code" style="width: 100px;" placeholder="RIV-0881" readonly />
        <input class="input name-field" data-field="item_name" placeholder="наименование" readonly />
        <input class="input" data-field="status" style="width: 110px;" placeholder="статус" readonly />
        <input class="input" data-field="date-time" placeholder="дата и время" readonly />
        <input class="inputT supplier-field" data-field="supplier" placeholder="поставщик" readonly />
        <span class="spec-icon" data-field="spec-url" data-url="">
          <i class="material-symbols-outlined">captive_portal</i>
        </span>
        <input class="input" style="width: 60px;" data-field="base_unit" placeholder="изм." readonly />
        <input class="inputSUM" style="width: 90px;" data-field="base_qty" placeholder="000 000" readonly />
        <input class="inputSUM" style="width: 120px;" data-field="base_price" placeholder="000 000 000" readonly />
        <input class="inputSUM" style="width: 120px;" data-field="total" placeholder="000 000 000" readonly />
      </div>
    </div>
  </template>
</div>

<script type="module">
export function initModal4() {
  const supabase = window.supabase;
  const rawUserKey = window.USER_KEY;
  const authUserId = window.AUTH_ID;
  const DB_USER_KEY = authUserId || rawUserKey;
  let DB_COMPANY_ID = window.companyId || window.companyID || null;
  let resolvingCompanyIdPromise = null;
  const TABLE_NAME = 'modal4_orders';
  const ORDER_STATUS = 'заказано';

  const modal = document.getElementById('modal4-container');
  if (!modal) return;

  if (!supabase) {
    console.warn('[modal4.html] Supabase client не найден');
    return;
  }
  if (!DB_USER_KEY && !DB_COMPANY_ID) {
    console.warn('[modal4.html] отсутствует идентификатор пользователя или компании');
    return;
  }

  const resolveCompanyId = async () => {
    if (DB_COMPANY_ID) return DB_COMPANY_ID;
    if (resolvingCompanyIdPromise) return resolvingCompanyIdPromise;
    if (!supabase) return null;

    const localId = window.LOCAL_USER_ID;
    const isAdmin = Boolean(window.IS_ADMIN);
    const tablesToCheck = isAdmin
      ? ['administrators', 'employees']
      : ['employees', 'administrators'];

    resolvingCompanyIdPromise = (async () => {
      for (const table of tablesToCheck) {
        try {
          let query = supabase
            .from(table)
            .select('company_id')
            .limit(1);

          if (localId) {
            query = query.eq('id', localId);
          } else if (DB_USER_KEY) {
            query = query.eq('user_key', DB_USER_KEY);
          } else if (rawUserKey) {
            query = query.eq('user_key', rawUserKey);
          } else {
            continue;
          }

          const { data, error } = await query;
          if (error) {
            console.warn(`[modal4.html] не удалось получить company_id из ${table}:`, error);
            continue;
          }

          if (Array.isArray(data) && data.length) {
            const companyId = data[0]?.company_id ?? null;
            if (companyId) {
              DB_COMPANY_ID = companyId;
              if (!window.companyId) window.companyId = companyId;
              return companyId;
            }
          }
        } catch (err) {
          console.warn(`[modal4.html] исключение при получении company_id из ${table}:`, err);
        }
      }

      return DB_COMPANY_ID;
    })();

    try {
      return await resolvingCompanyIdPromise;
    } finally {
      resolvingCompanyIdPromise = null;
    }
  };

  console.log('[modal4.html] PAGE 4 активирован');

  const ordersContainer = modal.querySelector('.modalVNUT-content');
  const orderTemplate = modal.querySelector('#modal4-order-template');
  const statEls = modal.querySelectorAll('.stat-value');
  const countEl = statEls[0] ?? null;
  const sumEl = statEls[1] ?? null;
  const actionRow = modal.querySelector('.action-bar');
  const selectOverlay = modal.querySelector('#modal4-select-overlay');
  const selectDropdown = modal.querySelector('#modal4-global-select-dropdown');
  const autocompleteDropdown = modal.querySelector('#modal4-autocomplete-dropdown');
  const formRow = modal.querySelector('.form-fields .modalRow');
  const createButton = modal.querySelector('#create-order');
  const deleteButton = modal.querySelector('#delete-selected');
  const moveButton = modal.querySelector('#move-warehouse');
  const selectInput = modal.querySelector('.select-input');
  const DROPDOWN_POINTER_TOLERANCE = 0.1;

  const fmtNum = value => {
    if (value === null || value === undefined || value === '') return '';
    const num = Number(value);
    if (!Number.isFinite(num)) return '';
    return num.toLocaleString('ru-RU');
  };

  const MONTHS_RU = [
    'января',
    'февраля',
    'марта',
    'апреля',
    'мая',
    'июня',
    'июля',
    'августа',
    'сентября',
    'октября',
    'ноября',
    'декабря',
  ];

  const formatCreatedAt = value => {
    if (!value) return '';
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) return '';
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const month = MONTHS_RU[date.getMonth()] ?? '';
    const year = date.getFullYear();
    if (!month) return '';
    return `${hours}:${minutes} ${day} ${month} ${year} г.`;
  };

  const parseNumberNullable = str => {
    const normalized = String(str ?? '')
      .replace(/[\s\u202f]/g, '')
      .replace(',', '.')
      .trim();
    if (!normalized) return null;
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? parsed : null;
  };

  const numberToStorageString = num => {
    if (num === null || num === undefined) return '';
    return Number(num).toString();
  };

  const isUniversalGroup = group => String(group ?? '')
    .trim()
    .toLowerCase() === 'универсальные';


  const parseFloatSafe = str =>
    parseFloat(String(str ?? '').replace(/[\s\u202f]/g, '').replace(',', '.')) || 0;

  const sumInputs = formRow?.querySelectorAll('.inputSUM') ?? [];
  sumInputs.forEach(el => {
    if (el.dataset.bindSum === '1') return;
    el.addEventListener('focus', () => {
      const raw = el.dataset.raw ?? parseFloatSafe(el.value);
      if (!isNaN(raw)) el.value = Number(raw).toFixed(2);
    });
    el.addEventListener('blur', () => {
      const raw = parseFloatSafe(el.value);
      if (isNaN(raw)) {
        el.value = '';
        delete el.dataset.raw;
        return;
      }
      el.dataset.raw = raw;
      el.value = fmtNum(raw);
    });
    el.dataset.bindSum = '1';
  });

  function animateStat(el, newVal) {
    if (!el) return;
    const formatted = fmtNum(newVal);
    if (el.dataset.value === formatted) return;

    el.dataset.value = formatted;
    el.innerHTML = '';
    [...formatted].forEach((ch, idx) => {
      const span = document.createElement('span');
      span.textContent = ch;
      span.style.animationDelay = `${idx * 50}ms`;
      el.appendChild(span);
    });
  }

  function recalcStats() {
    if (!countEl && !sumEl) return;
    const blocks = ordersContainer.querySelectorAll('.modalBLOCK');
    const totalQty = blocks.length;
    const totalCost = [...blocks].reduce((sum, block) => {
      return sum + parseFloatSafe(block.dataset.price);
    }, 0);

    animateStat(countEl, totalQty);
    animateStat(sumEl, totalCost);
  }

  const findUnit = (value, units) => {
    if (!value) return undefined;
    return units.find(u => u.unit_short === value) || units.find(u => u.unit_name === value);
  };


  async function loadUnitsMeasure() {
    const { data, error } = await supabase
      .from('units_measure')
      .select('unit_name, unit_short, unit_group, multiplier, base_unit_short')
      .order('unit_group', { ascending: true })
      .order('multiplier', { ascending: true });

    if (error) {
      console.error(error);
      return [];
    }
    return data ?? [];
  }

  let cachedUnits = [];
  const unitsPromise = loadUnitsMeasure().then(units => {
    cachedUnits = units ?? [];
    return cachedUnits;
  });

  let hintsCache = [];

  async function loadHints() {
    if (hintsCache.length) return hintsCache;
    let query = supabase
      .from(TABLE_NAME)
      .select('order_code, item_name, url, supplier, modification, quantity_value, price_value');

    const companyId = await resolveCompanyId();
    if (companyId) {
      query = query.eq('company_id', companyId);
    } else if (DB_USER_KEY) {
      query = query.eq('user_key', DB_USER_KEY);
    }

    const { data, error } = await query;

    if (error) {
      console.error(error);
      hintsCache = [];
      return hintsCache;
    }

    hintsCache = data ?? [];
    return hintsCache;
  }

  function getBaseUnit(unitShort, units) {
    const current = findUnit(unitShort, units);
    if (!current) return unitShort;
    if (isUniversalGroup(current.unit_group)) return unitShort;
    return current.base_unit_short ?? unitShort;
  }

  function applyUnitDataset(unitShort, units) {
    if (!selectInput) return;
    const match = findUnit(unitShort, units);
    if (!match) {
      delete selectInput.dataset.unitGroup;
      delete selectInput.dataset.multiplier;
      delete selectInput.dataset.baseUnit;
      delete selectInput.dataset.displayName;
      return;
    }

    selectInput.dataset.unitGroup = match.unit_group ?? '';
    selectInput.dataset.multiplier = String(match.multiplier ?? 1);
    selectInput.dataset.baseUnit = match.base_unit_short ?? unitShort;
    selectInput.dataset.displayName = match.unit_name ?? '';
  }

  async function loadExistingOrders() {
    const units = await unitsPromise;
    let query = supabase
      .from(TABLE_NAME)
      .select('*')
      .eq('status', ORDER_STATUS)
      .order('created_at', { ascending: false });

    const companyId = await resolveCompanyId();
    if (companyId) {
      query = query.eq('company_id', companyId);
    } else if (DB_USER_KEY) {
      query = query.eq('user_key', DB_USER_KEY);
    }

    const { data: orders, error } = await query;

    if (error) {
      console.error(error);
      return;
    }
    if (!orders?.length) return;

    orders.forEach(order => {
      const qty = parseNumberNullable(order.quantity_value);
      const price = parseNumberNullable(order.price_value);
      const baseUnit = getBaseUnit(order.modification, units);
      const baseQty = qty;
      const basePrice = price;
      const total = (baseQty ?? 0) * (basePrice ?? 0);

      const rendered = createOrderElement({
        id: order.id,
        order_code: order.order_code,
        item_name: order.item_name,
        url: order.url,
        supplier: order.supplier,
        modification: order.modification,
        created_at: order.created_at,
        qtySel: baseQty,
        priceSel: basePrice,
        base_unit: baseUnit,
        baseQty,
        priceBase: basePrice,
        total,
      });
      ordersContainer.appendChild(rendered);
      const created = rendered;
      created.dataset.price = total;
      if (order.url) {
        created.querySelector('.spec-icon')?.addEventListener('click', () => {
          window.open(order.url, '_blank');
        });
      }
    });

    recalcStats();
    updateActionButtons();
  }

  function createOrderElement(o) {
    const totalPrice = o.total ?? o.priceSel ?? 0;
    const templateContent = orderTemplate?.content?.firstElementChild;
    const baseElement = templateContent instanceof HTMLElement
      ? templateContent.cloneNode(true)
      : null;

    if (!(baseElement instanceof HTMLElement)) {
      throw new Error('modal4-order-template не найден или пуст');
    }

    baseElement.dataset.id = String(o.id ?? '');
    baseElement.dataset.price = String(totalPrice ?? 0);

    const assignValue = (field, value) => {
      const normalized = value ?? '';
      const target = baseElement.querySelector(`[data-field="${field}"]`);
      if (!target) return;
      if (target instanceof HTMLInputElement) {
        target.value = normalized;
      } else if (target instanceof HTMLElement && field === 'spec-url') {
        target.dataset.url = normalized;
      }
    };

    assignValue('order_code', o.order_code ?? '');
    assignValue('item_name', o.item_name ?? '');
    assignValue('status', ORDER_STATUS);
    assignValue('date-time', formatCreatedAt(o.created_at));
    assignValue('spec-url', o.url ?? '');
    assignValue('supplier', o.supplier ?? '');
    assignValue('base_unit', o.base_unit ?? '');
    assignValue('base_qty', fmtNum(o.baseQty));
    assignValue('base_price', fmtNum(o.priceBase));
    assignValue('total', fmtNum(o.total));

    return baseElement;
  }

  function clearForm() {
    const inputs = formRow?.querySelectorAll('input') ?? [];
    inputs.forEach(input => {
      input.value = '';
      if (input.classList.contains('inputSUM')) {
        delete input.dataset.raw;
      }
    });
    if (selectInput) {
      delete selectInput.dataset.unitGroup;
      delete selectInput.dataset.multiplier;
      delete selectInput.dataset.baseUnit;
      delete selectInput.dataset.displayName;
    }
  }

  async function insertOrderToDB(record) {
    const { data, error } = await supabase
      .from(TABLE_NAME)
      .insert([record])
      .select('id')
      .single();

    if (error) throw error;
    return data.id;
  }

  function updateActionButtons() {
    const hasChecked = !!ordersContainer.querySelector('input[type="checkbox"]:checked');
    actionRow?.classList.toggle('visible', hasChecked);
  }

  ordersContainer.addEventListener('change', event => {
    if (event.target instanceof HTMLInputElement && event.target.type === 'checkbox') {
      updateActionButtons();
    }
  });

  selectOverlay?.addEventListener('click', () => {
    closeDropdowns();
  });

  let pointerMonitorActive = false;
  let lastPointerPosition = null;

  const getActiveDropdown = () => {
    if (selectDropdown?.classList.contains('show')) return selectDropdown;
    if (autocompleteDropdown?.classList.contains('show')) return autocompleteDropdown;
    return null;
  };

  const isPointerWithinTolerance = position => {
    const dropdown = getActiveDropdown();
    if (!dropdown) return true;
    const rect = dropdown.getBoundingClientRect();
    const toleranceX = rect.width * DROPDOWN_POINTER_TOLERANCE;
    const toleranceY = rect.height * DROPDOWN_POINTER_TOLERANCE;
    return (
      position.x >= rect.left - toleranceX &&
      position.x <= rect.right + toleranceX &&
      position.y >= rect.top - toleranceY &&
      position.y <= rect.bottom + toleranceY
    );
  };

  const handlePointerMove = event => {
    const { clientX, clientY } = event;
    lastPointerPosition = { x: clientX, y: clientY };
    if (!isPointerWithinTolerance(lastPointerPosition)) {
      closeDropdowns();
    }
  };

  const handleDropdownScroll = () => {
    if (!lastPointerPosition) return;
    if (!isPointerWithinTolerance(lastPointerPosition)) {
      closeDropdowns();
    }
  };

  const startDropdownMonitoring = initialEvent => {
    if (initialEvent && typeof initialEvent.clientX === 'number' && typeof initialEvent.clientY === 'number') {
      lastPointerPosition = { x: initialEvent.clientX, y: initialEvent.clientY };
    }
    if (pointerMonitorActive) return;
    pointerMonitorActive = true;
    document.addEventListener('pointermove', handlePointerMove);
    document.addEventListener('scroll', handleDropdownScroll, true);
  };

  const stopDropdownMonitoring = () => {
    if (!pointerMonitorActive) {
      lastPointerPosition = null;
      return;
    }
    pointerMonitorActive = false;
    lastPointerPosition = null;
    document.removeEventListener('pointermove', handlePointerMove);
    document.removeEventListener('scroll', handleDropdownScroll, true);
  };

  function closeDropdowns() {
    stopDropdownMonitoring();
    selectDropdown?.classList.remove('show');
    autocompleteDropdown?.classList.remove('show');
    if (selectOverlay) selectOverlay.style.display = 'none';
  }

  let customSelectListenersBound = false;

  async function setupCustomSelect() {
    if (!selectInput || !selectDropdown || !selectOverlay) return;
    const units = await unitsPromise;

    if (!units.length) {
      console.warn('[modal4.html] список единиц измерения пуст');
      return;
    }

    const groupOrder = ['ДЛИННА', 'ОБЪЕМ', 'МАССА', 'УНИВЕРСАЛЬНЫЕ'];
    const normalizeGroupKey = group => String(group ?? '').trim();

    if (!selectDropdown.hasChildNodes()) {
      const fragment = document.createDocumentFragment();
      const groups = new Map();
      
      units.forEach(unit => {
        const key = normalizeGroupKey(unit.unit_group);
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(unit);
      });

      const sortedGroups = [...groups.entries()].sort((a, b) => {
        const [groupA] = a;
        const [groupB] = b;
        const idxA = groupOrder.indexOf(groupA.toUpperCase());
        const idxB = groupOrder.indexOf(groupB.toUpperCase());
        const safeA = idxA === -1 ? Number.MAX_SAFE_INTEGER : idxA;
        const safeB = idxB === -1 ? Number.MAX_SAFE_INTEGER : idxB;
        if (safeA !== safeB) return safeA - safeB;
        return groupA.localeCompare(groupB, 'ru');
      });
      sortedGroups.forEach(([groupName, groupUnits]) => {
        const title = document.createElement('div');
        title.className = 'select-group-title';
        title.textContent = groupName;
        fragment.appendChild(title);

        groupUnits
          .slice()
          .sort((a, b) => Number(a.multiplier ?? 1) - Number(b.multiplier ?? 1))
          .forEach(unit => {
            const option = document.createElement('div');
            option.className = 'select-option';
            option.innerHTML = `
              <span class="select-option-title">${unit.unit_name}</span>
              <span class="select-option-hint">${unit.unit_short}</span>
            `;
            option.dataset.short = unit.unit_short ?? '';
            option.dataset.group = unit.unit_group ?? '';
            option.dataset.multiplier = String(unit.multiplier ?? 1);
            option.dataset.baseUnit = unit.base_unit_short ?? (unit.unit_short ?? '');
            fragment.appendChild(option);
          });
      });
      
      selectDropdown.appendChild(fragment);
    }

    selectInput.addEventListener('click', event => {
  event.stopPropagation();
      const rect = selectInput.getBoundingClientRect();
      const modalRect = modal.getBoundingClientRect();
      const offsetLeft = rect.left - modalRect.left + modal.scrollLeft;
      const offsetTop = rect.bottom - modalRect.top + modal.scrollTop + 10;
      const dropdownWidth = rect.width * 2;
      selectDropdown.style.left = `${offsetLeft}px`;
      selectDropdown.style.top = `${offsetTop}px`;
      selectDropdown.style.width = `${dropdownWidth}px`;
      selectDropdown.classList.add('show');
      selectOverlay.style.display = 'block';
      startDropdownMonitoring(event);
    });

    selectDropdown.addEventListener('click', event => {
      const target = event.target;
      const option = target?.closest('.select-option');
      if (!(option instanceof HTMLElement)) return;
      const unitShort = option.dataset.short ?? '';
      selectInput.value = unitShort;
      applyUnitDataset(unitShort, units);
      closeDropdowns();
    });
    if (!customSelectListenersBound) {
      document.addEventListener('keydown', event => {
        if (event.key === 'Escape') {
          closeDropdowns();
        }
      });

      window.addEventListener('resize', closeDropdowns);
      customSelectListenersBound = true;
    }
  }

  async function setupAutocomplete() {
    if (!formRow || !autocompleteDropdown || !selectOverlay) return;
    await loadHints();
    const [codeInput, nameInput, urlInput, supplierInput, , qtyInput, priceInput] =
      formRow.querySelectorAll('input');

    if (!codeInput || !nameInput) return;

    const handleInput = event => {
      const src = event.target;
      if (!(src instanceof HTMLInputElement)) return;
      const value = src.value.trim().toLowerCase();
      if (value.length < 1) {
        closeDropdowns();
        return;
      }

      const list = src === codeInput
        ? hintsCache.filter(h => (h.order_code ?? '').toLowerCase().includes(value))
        : hintsCache.filter(h => (h.item_name ?? '').toLowerCase().includes(value));

      if (!list.length) {
        closeDropdowns();
        return;
      }

      autocompleteDropdown.innerHTML = '';
      list.forEach(record => {
        const option = document.createElement('div');
        option.className = 'ac-option';
        option.textContent = src === codeInput ? record.order_code : record.item_name;
        option.dataset.record = JSON.stringify(record);
        autocompleteDropdown.appendChild(option);
      });

      const modalRect = modal.getBoundingClientRect();
      const offsetLeft = rect.left - modalRect.left + modal.scrollLeft;
      const offsetTop = rect.bottom - modalRect.top + modal.scrollTop + 10;
      autocompleteDropdown.style.left = `${offsetLeft}px`;
      autocompleteDropdown.style.top = `${offsetTop}px`;
      autocompleteDropdown.style.width = `${rect.width}px`;
      autocompleteDropdown.classList.add('show');
      selectOverlay.style.display = 'block';
      startDropdownMonitoring();
    };

    autocompleteDropdown.addEventListener('click', event => {
      const target = event.target;
      if (!(target instanceof HTMLElement) || !target.classList.contains('ac-option')) return;
      const record = JSON.parse(target.dataset.record ?? '{}');
      codeInput.value = record.order_code ?? '';
      nameInput.value = record.item_name ?? '';
      if (urlInput) urlInput.value = record.url ?? '';
      if (supplierInput) supplierInput.value = record.supplier ?? '';
      if (selectInput) selectInput.value = record.modification ?? '';
      applyUnitDataset(selectInput?.value ?? '', cachedUnits);
      if (qtyInput) {
        if (record.quantity_value === null || record.quantity_value === undefined || record.quantity_value === '') {
          delete qtyInput.dataset.raw;
          qtyInput.value = '';
        } else {
          const qtyVal = parseFloatSafe(record.quantity_value);
          qtyInput.dataset.raw = String(qtyVal);
          qtyInput.value = fmtNum(qtyVal);
        }
      }
      if (priceInput) {
        if (record.price_value === null || record.price_value === undefined || record.price_value === '') {
          delete priceInput.dataset.raw;
          priceInput.value = '';
        } else {
          const priceVal = parseFloatSafe(record.price_value);
          priceInput.dataset.raw = String(priceVal);
          priceInput.value = fmtNum(priceVal);
        }
      }
      closeDropdowns();
    });

    codeInput.addEventListener('input', handleInput);
    nameInput.addEventListener('input', handleInput);
  }

  createButton?.addEventListener('click', async () => {
    if (!formRow) return;
    const inputs = formRow.querySelectorAll('input');
    const units = await unitsPromise;

    const quantityInput = inputs[5];
    const priceInput = inputs[6];
    const quantityRaw = quantityInput?.dataset.raw ?? quantityInput?.value.trim() ?? '';
    const priceRaw = priceInput?.dataset.raw ?? priceInput?.value.trim() ?? '';

    const companyIdForUser = await resolveCompanyId();

    const orderData = {
      user_key: DB_USER_KEY,
      company_id: companyIdForUser,
      order_code: inputs[0].value.trim(),
      item_name: inputs[1].value.trim(),
      url: inputs[2].value.trim(),
      supplier: inputs[3].value.trim(),
      modification: inputs[4].value.trim(),
      quantity_value: quantityRaw,
      price_value: priceRaw,
      status: ORDER_STATUS,
    };

    if (!orderData.order_code || !orderData.item_name) {
      alert('Заполните обязательные поля (код и наименование)');
      return;
    }

    const quantityOriginal = parseNumberNullable(orderData.quantity_value);
    const priceOriginal = parseNumberNullable(orderData.price_value);
    const selectedUnit = findUnit(orderData.modification, units);
    const canConvert = selectedUnit && !isUniversalGroup(selectedUnit.unit_group);
    const multiplierSelected = canConvert ? Number(selectedUnit.multiplier ?? 1) || 1 : 1;
    const baseUnit = canConvert
      ? (selectedUnit?.base_unit_short ?? orderData.modification)
      : orderData.modification;

    const qtyStored = quantityOriginal === null
      ? null
      : (canConvert ? quantityOriginal * multiplierSelected : quantityOriginal);
    const priceStored = priceOriginal === null
      ? null
      : (canConvert && multiplierSelected ? priceOriginal / multiplierSelected : priceOriginal);

    const qtyStoredStr = numberToStorageString(qtyStored);
    const priceStoredStr = numberToStorageString(priceStored);
    const total = (qtyStored ?? 0) * (priceStored ?? 0);

    try {
      const dbPayload = {
        order_code: orderData.order_code,
        item_name: orderData.item_name,
        url: orderData.url,
        supplier: orderData.supplier,
        modification: baseUnit,
        quantity_value: qtyStoredStr,
        price_value: priceStoredStr,
        status: orderData.status,
      };

      if (orderData.user_key) {
        dbPayload.user_key = orderData.user_key;
      }
      const payloadCompanyId = orderData.company_id || await resolveCompanyId();
      if (payloadCompanyId) {
        dbPayload.company_id = payloadCompanyId;
      }

      const id = await insertOrderToDB(dbPayload);

      const rendered = createOrderElement({
        id,
        order_code: orderData.order_code,
        item_name: orderData.item_name,
        url: orderData.url,
        supplier: orderData.supplier,
        modification: baseUnit,
        created_at: new Date().toISOString(),
        qtySel: qtyStored,
        priceSel: priceStored,
        base_unit: baseUnit,
        baseQty: qtyStored,
        priceBase: priceStored,
        total,
      });

      ordersContainer.prepend(rendered);
      const created = rendered;
      created.dataset.price = total;
      created.classList.add('appear');
      requestAnimationFrame(() => {
        created.classList.add('appear-active');
        created.classList.remove('appear');
      });

      if (orderData.url) {
        created.querySelector('.spec-icon')?.addEventListener('click', () => {
          window.open(orderData.url, '_blank');
        });
      }

      hintsCache.push({
        order_code: orderData.order_code,
        item_name: orderData.item_name,
        url: orderData.url,
        supplier: orderData.supplier,
        modification: baseUnit,
        quantity_value: qtyStoredStr,
        price_value: priceStoredStr,
      });

      updateActionButtons();
      recalcStats();
      clearForm();
    } catch (error) {
      alert('Ошибка при создании заказа: ' + error.message);
      console.error(error);
    }
  });

  deleteButton?.addEventListener('click', async () => {
    const checked = ordersContainer.querySelectorAll('input[type="checkbox"]:checked');
    if (!checked.length) return;

    const ids = [...checked]
      .map(cb => cb.closest('.modalBLOCK')?.dataset.id)
      .filter(Boolean);

    try {
      if (ids.length) {
        let deleteQuery = supabase
          .from(TABLE_NAME)
          .delete()
          .in('id', ids);

        const deleteCompanyId = await resolveCompanyId();
        if (deleteCompanyId) {
          deleteQuery = deleteQuery.eq('company_id', deleteCompanyId);
        } else if (DB_USER_KEY) {
          deleteQuery = deleteQuery.eq('user_key', DB_USER_KEY);
        }

        const { error } = await deleteQuery;
        if (error) throw error;
      }

      checked.forEach(cb => cb.closest('.modalBLOCK')?.remove());
      updateActionButtons();
      recalcStats();
    } catch (error) {
      alert('Ошибка удаления: ' + error.message);
      console.error(error);
    }
  });

  moveButton?.addEventListener('click', () => {
    console.log('Перемещение на склад');
  });

  loadHints();
  setupCustomSelect();
  setupAutocomplete();
  loadExistingOrders();
  recalcStats();
}

initModal4();
</script>
