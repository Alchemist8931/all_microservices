<!-- ========= modal4.html (Проект 4) ========= -->
<div id="modal4-container" class="modal4-shell">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    #modal4-container {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      width: 100%;
      height: 100vh;
      padding: 20px 0;
      margin: 0;
      box-sizing: border-box;
      color: var(--content-color, #212121);
      font-family: 'Comfortaa', sans-serif;
    }
    #modal4-container .glass-panel {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--content-color, #212121);
      border-radius: 12px;
      box-shadow:
        0 0 0.75px hsl(205 20% 10% / 0.24),
        0.7px 0.8px 1.2px -0.4px hsl(205 20% 10% / 0.16),
        1.3px 1.5px 2.2px -0.8px hsl(205 20% 10% / 0.16),
        2.3px 2.6px 3.9px -1.2px hsl(205 20% 10% / 0.16),
        3.9px 4.4px 6.6px -1.7px hsl(205 20% 10% / 0.16),
        6.5px 7.2px 10.9px -2.1px hsl(205 20% 10% / 0.18);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
    }

    #modal4-container .modal-top {
      width: 1930px;
      max-width: 90vw;
      height: 255px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: -20px;
      padding: 10px;
      box-sizing: border-box;
      color: var(--black-color, var(--content-color, #212121));
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    #modal4-container #modal4-ambient-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      pointer-events: none;
      z-index: 0;
    }

    #modal4-container .modal-top > *:not(#modal4-ambient-canvas) {
      position: relative;
      z-index: 1;
    }

    #modal4-container .modal4-signature {
      position: absolute;
      top: 20px;
      left: 20px;
      margin-top: -20px;
      margin-left: -1480px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    #modal4-container .modal4-signature h2 {
      margin: 0;
      font-size: 1.4em;
      color: #212121;
      text-transform: uppercase;
      display: flex;
      gap: 2px;
    }

    #modal4-container .modal4-signature h2 span {
      transition: 1.5s;
      display: inline-block;
    }

    #modal4-container .modal4-signature h2:hover span {
      filter: blur(20px);
      opacity: 0;
      transform: scale(2);
    }

    #modal4-container .modal4-signature h2 span:nth-child(1) { transition-delay: 0s; }
    #modal4-container .modal4-signature h2 span:nth-child(2) { transition-delay: 0.1s; }
    #modal4-container .modal4-signature h2 span:nth-child(3) { transition-delay: 0.2s; }
    #modal4-container .modal4-signature h2 span:nth-child(4) { transition-delay: 0.3s; }
    #modal4-container .modal4-signature h2 span:nth-child(5) { transition-delay: 0.4s; }
    #modal4-container .modal4-signature h2 span:nth-child(6) { transition-delay: 0.5s; }
    #modal4-container .modal4-signature h2 span:nth-child(7) { transition-delay: 0.6s; }
    #modal4-container .modal4-signature h2 span:nth-child(8) { transition-delay: 0.7s; }
    #modal4-container .modal4-signature h2 span:nth-child(9) { transition-delay: 0.8s; }
    #modal4-container .modal4-signature h2 span:nth-child(10) { transition-delay: 0.9s; }
    #modal4-container .modal4-signature h2 span:nth-child(11) { transition-delay: 1s; }
    #modal4-container .modal4-signature h2 span:nth-child(12) { transition-delay: 1.1s; }
    #modal4-container .modal4-signature h2 span:nth-child(13) { transition-delay: 1.2s; }
    #modal4-container .modal4-signature h2 span:nth-child(14) { transition-delay: 1.3s; }
    #modal4-container .modal4-signature h2 span:nth-child(15) { transition-delay: 1.4s; }
    #modal4-container .modal4-signature h2 span:nth-child(16) { transition-delay: 1.5s; }

    #modal4-container .modal4-signature h2 span:nth-child(17) { transition-delay: 1.6s; }
    #modal4-container .modal4-signature h2 span:nth-child(18) { transition-delay: 1.7s; }
    #modal4-container .modal4-signature h2 span:nth-child(19) { transition-delay: 1.8s; }
    #modal4-container .modal4-signature h2 span:nth-child(20) { transition-delay: 1.9s; }
    #modal4-container .modal4-signature h2 span:nth-child(21) { transition-delay: 2s; }
    #modal4-container .modal4-signature h2 span:nth-child(22) { transition-delay: 2.1s; }
    #modal4-container .modal4-signature h2 span:nth-child(23) { transition-delay: 2.2s; }
    #modal4-container .modal4-signature h2 span:nth-child(24) { transition-delay: 2.3s; }
    #modal4-container .modal4-signature h2 span:nth-child(25) { transition-delay: 2.4s; }
    #modal4-container .modal4-signature h2 span:nth-child(26) { transition-delay: 2.5s; }

    #modal4-container .modal4-signature h2 span.warehouse-letter {
      font-size: 0.85em;
      margin-top: 2px;
      color: #9EA793;
    }

    #modal4-container .modal4-scroll-wrapper {
      width: 1950px;
      max-width: 90vw;
      flex: 1;
      padding-bottom: 20px;
      overflow: visible;
    }

    #modal4-container .modal4-window {
      color: var(--black-color, var(--content-color, #212121));
      width: 1930px;
      max-width: 90vw;
      padding-top: 20px;
      padding-bottom: 20px;
      padding-left: 20px;
      padding-right: 10px;
      box-sizing: border-box;
      margin: 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 275px;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-height: calc(100vh - 220px);
      overflow-x: visible;
    }

    #modal4-container .modal4-content {
      width: 1930px;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      padding-right: 10px;
      margin-right: -10px;
      transition: opacity 0.3s ease;
      opacity: 1;
    }

    #modal4-container .modal4-content.is-faded {
      opacity: 0;
    }

    #modal4-container .modal4-content::-webkit-scrollbar {width: 6px;}
    #modal4-container .modal4-content::-webkit-scrollbar-track {background: transparent;}
    #modal4-container .modal4-content::-webkit-scrollbar-thumb {background-color: var(--content-color, #212121); border-radius: 10px;}

    #modal4-container .modalRow {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 14px;
    }

    #modal4-container .notes-field-wrapper {
      position: relative;
      flex: 0 0 auto;
      height: 33px;
      overflow: visible;
      z-index: 1;
    }

    #modal4-container .notes-field {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      min-height: 33px;
      max-height: 240px;
      height: 33px;
      font-size: 12px;
      resize: none;
      overflow: hidden;
      padding: 8px 10px;
      line-height: 1.4;
      border-radius: 8px;
      transition: height 0.25s ease, box-shadow 0.25s ease, transform 0.25s ease;
      background: #ffffff;
      z-index: 100;
    }

    #modal4-container .notes-field::placeholder {
      color: rgba(33, 33, 33, 0.4);
    }

    #modal4-container .notes-field-wrapper.is-expanded {
      z-index: 2000;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.12), 0 12px 20px rgba(0, 0, 0, 0.08);
    }

    #modal4-container .notes-field-wrapper.is-expanded::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 240px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: none;
      pointer-events: none;
      z-index: -1;
    }

    #modal4-container .notes-field-wrapper.is-expanded .notes-field {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 240px;
      overflow: auto;
      background: #ffffff;
      box-shadow: none;
      transform: translateY(0);
      z-index: 1;
    }

    #modal4-container .notes-field.is-busy {
      opacity: 0.65;
      pointer-events: none;
    }


    #modal4-container .date-time-field {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      min-width: 180px;
      font-variant-numeric: tabular-nums;
    }

    #modal4-container .date-time-field__time {
      flex: 0 0 auto;
      text-align: left;
    }

    #modal4-container .date-time-field__date {
      flex: 1 1 auto;
      text-align: right;
    }

    #modal4-container .stats-row {
      justify-content: space-between;
      gap: 16px;
    }

    #modal4-container .stat-card {
      flex: 1;
      min-width: 240px;
      padding: 18px 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
    }

    #modal4-container .stat-title {
      text-transform: uppercase;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--content-color, #212121);
    }

    #modal4-container .stat-value {
      font-size: 32px;
      font-weight: 700;
      line-height: 1.2;
      margin-top: 12px;
      color: var(--content-color, #212121);
    }

    #modal4-container .action-bar {
      justify-content: flex-end;
      gap: 12px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(-6px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    #modal4-container .action-bar.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }

    #modal4-container .form-row {
      align-items: stretch;
      gap: 18px;
    }

     #modal4-container .form-row.is-hidden {
      visibility: hidden;
      pointer-events: none;
    }

    #modal4-container .form-fields {
      flex: 1;
      padding: 18px 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #modal4-container .form-fields .modalRow {
      gap: 12px;
    }

    #modal4-container .modalVNUT-content .modalBLOCK {
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      margin-bottom: 12px;
    }

    #modal4-container .modalVNUT-content .modalBLOCK:hover {
      /* transform: translateY(-2px); */
    }

    #modal4-container .modalVNUT-content .modalBLOCK.appear {
      opacity: 0;
      transform: translateY(-16px);
    }

    #modal4-container .modalVNUT-content .modalBLOCK.appear-active {
      opacity: 1;
      transform: translateY(0);
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    #modal4-container .inputT,
    #modal4-container .input,
    #modal4-container .inputSUM {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid #212121;
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--content-color, #212121);
      transition: border-color 0.3s ease, transform 0.2s ease;
      font-variant-numeric: tabular-nums;
    }

    #modal4-container .inputT:focus,
    #modal4-container .input:focus,
    #modal4-container .inputSUM:focus {
      border-color: var(--content-color, #30333C);
      background: rgba(255, 255, 255, 0.12);
    }

    #modal4-container .inputSUM {
      text-align: right;
      width: 116px;
    }

    #modal4-container .code-field { width: 130px; text-transform: uppercase; }
    #modal4-container .name-field { width: 340px; }
    #modal4-container .url-field { width: 200px; }
    #modal4-container .supplier-field { width: 220px; }
    #modal4-container .select-wrapper {
      width: 100px;
      position: relative;
    }

    #modal4-container .select-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      transition: border-color 0.3s ease, background 0.3s ease;
    }

    #modal4-container .select-input:focus {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.32);
    }

    #modal4-container .radio-inputs {
      position: relative;
      display: flex;
      flex-wrap: wrap;
      border-radius: 0.5rem;
      
      background: var(--content-color, #212121);
      border: 1px solid var(--content-color, #212121);
      color: var(--fon, #f5f5f5);
      padding: 2px 2px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      
      box-sizing: border-box;
      box-shadow: 0 0 0px 1px rgba(0, 0, 0, 0.06);
      width: 600px;
      height: 30px;
      align-self: center;
      gap: 0.25rem;
    }

    #modal4-container .radio-inputs .radio {
      flex: 1 1 auto;
      text-align: center;
    }

    #modal4-container .radio-inputs .radio input {
      display: none;
    }

    #modal4-container .radio-inputs .radio .name {
      display: flex;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      border: none;
      padding: .5rem 0;
      color: #f5f5f5;
      transition: all .15s ease-in-out;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 500;
    }

    #modal4-container .radio-inputs .radio input:checked + .name {
      color: #212121;
      background: #f5f5f5;
      border-radius: 5px;
      height: 23px;
    }

    #modal4-container .button-form {
      position: relative;
      min-width: 220px;
      height: 30px;
      background: var(--content-color, #212121);
      border: 1px solid var(--content-color, #212121);
      color: #f5f5f5;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-top: 15px;
    }

    #modal4-container .button-form:hover {
      color: var(--content-color, #212121);
      background: rgba(255, 255, 255, 0.12);
    }

    #modal4-container .button-form.primary {
      min-width: 200px;
    }

    #modal4-container .spec-icon {
      color: var(--content-color, #212121);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    #modal4-container .spec-icon:hover {
      color: rgba(98, 90, 86, 0.85);
      transform: scale(1.05);
    }

    #modal4-container label.checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #modal4-container .checkbox input[type="checkbox"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid var(--content-color, #212121);
      border-radius: 4px;
      position: relative;
      cursor: pointer;
      background: transparent;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    #modal4-container .checkbox input[type="checkbox"]:checked {
      background: var(--content-color, #212121);
    }

    #modal4-container .checkbox input[type="checkbox"]::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 8px;
      height: 8px;
      transform: translate(-50%, -50%) scale(0);
      background: var(--fon, #f5f5f5);
      border-radius: 2px;
      transition: transform 0.2s ease;
    }

    #modal4-container .checkbox input[type="checkbox"]:checked::after {
      transform: translate(-50%, -50%) scale(1);
    }

    #modal4-select-overlay {
      position: absolute;
      inset: 0;
      background: transparent;
      z-index: 9998;
      display: none;
    }

    #modal4-global-select-dropdown {
      position: absolute;
      max-height: 240px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-2px);
      transition: opacity 1s ease, transform 1s ease, visibility 0s linear 1s;
      z-index: 10000;
      background: transparent;
      border-radius: 12px;
      box-shadow: none;
      color: var(--content-color, #212121);
      padding: 6px 12px 6px 0;
      margin-right: -12px;
      border: none;
    }

    #modal4-global-select-frame {
      position: absolute;
      opacity: 0;
      visibility: hidden;
      margin-top: 2px;
      transform: translateY(-2px);
      transition: opacity 1s ease, transform 1s ease, visibility 0s linear 1s;
      z-index: 9999;
      pointer-events: none;
      border: 1px solid rgba(255, 255, 255, 0.28);
      border-radius: 12px;
      box-shadow:
        0 0 0.75px hsl(205 20% 10% / 0.24),
        0.7px 0.8px 1.2px -0.4px hsl(205 20% 10% / 0.16),
        1.3px 1.5px 2.2px -0.8px hsl(205 20% 10% / 0.16),
        2.3px 2.6px 3.9px -1.2px hsl(205 20% 10% / 0.16),
        3.9px 4.4px 6.6px -1.7px hsl(205 20% 10% / 0.16),
        6.5px 7.2px 10.9px -2.1px hsl(205 20% 10% / 0.18);
      background: rgba(255, 255, 255, 0.08);
    }
    #modal4-autocomplete-dropdown {
      position: absolute;
      max-height: 240px;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-2px);
      transition: opacity 1s ease, transform 1s ease, visibility 0s linear 1s;
      z-index: 9999;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      box-shadow:
        0 0 0.75px hsl(205 20% 10% / 0.24),
        0.7px 0.8px 1.2px -0.4px hsl(205 20% 10% / 0.16),
        1.3px 1.5px 2.2px -0.8px hsl(205 20% 10% / 0.16),
        2.3px 2.6px 3.9px -1.2px hsl(205 20% 10% / 0.16),
        3.9px 4.4px 6.6px -1.7px hsl(205 20% 10% / 0.16),
        6.5px 7.2px 10.9px -2.1px hsl(205 20% 10% / 0.18);
      color: var(--content-color, #212121);
      backdrop-filter: blur(6px);
      padding: 6px 12px 6px 0;
      margin-right: -12px;
    }

    #modal4-global-select-dropdown.show,
    #modal4-global-select-frame.show,
    #modal4-autocomplete-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
      transition: opacity 1s ease, transform 1s ease, visibility 0s linear 0s;
    }

    #modal4-global-select-dropdown::-webkit-scrollbar,
    #modal4-autocomplete-dropdown::-webkit-scrollbar {
      width: 6px;
      background: transparent;
    }

    #modal4-global-select-dropdown::-webkit-scrollbar-track,
    #modal4-autocomplete-dropdown::-webkit-scrollbar-track {
      background: transparent;
    }

    #modal4-global-select-dropdown::-webkit-scrollbar-thumb,
    #modal4-autocomplete-dropdown::-webkit-scrollbar-thumb {
      background: var(--content-color, #212121);
      border-radius: 10px;
    }

    #modal4-global-select-dropdown .select-group-title {
      padding: 6px 12px 4px;
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(33, 33, 33, 0.65);
    }

    #modal4-global-select-dropdown .select-option,
    #modal4-autocomplete-dropdown .ac-option {
      padding: 8px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #modal4-global-select-dropdown .select-option:hover,
    #modal4-autocomplete-dropdown .ac-option:hover {
      background: rgba(0, 0, 0, 0.08);
    }

    #modal4-global-select-dropdown .select-option .select-option-title {
      font-weight: 600;
      color: var(--content-color, #212121);
    }

    #modal4-global-select-dropdown .select-option .select-option-hint {
      font-size: 11px;
      color: rgba(33, 33, 33, 0.65);
      font-variant-numeric: tabular-nums;
    }

    #modal4-autocomplete-dropdown .ac-option {
      justify-content: flex-start;
    }

    @keyframes digit-glow {
      0% {
        opacity: 0;
        transform: translateY(-0.4em);
        text-shadow: 0 0 2px rgba(0, 0, 0, 0.15);
      }
      60% {
        opacity: 1;
        transform: translateY(0);
        text-shadow: 0 0 8px rgba(0, 0, 0, 0.25);
      }
      100% {
        opacity: 1;
        text-shadow: none;
      }
    }

    #modal4-container .stat-value span {
      display: inline-block;
      animation: digit-glow 0.6s cubic-bezier(0.19, 1, 0.22, 1) both;
    }
  </style>

  <div id="modal4-select-overlay"></div>
  <div id="modal4-global-select-dropdown"></div>
  <div id="modal4-global-select-frame" class="glass-panel"></div>
  <div id="modal4-autocomplete-dropdown"></div>

  <div class="modal-top glass-panel">
    <!-- <canvas id="modal4-ambient-canvas" aria-hidden="true"></canvas> -->
    <section class="modal4-signature">
      <h2>
        <span>R</span>
        <span>I</span>
        <span>V</span>
        <span>A</span>
        <span>&nbsp;&nbsp;</span>
        <span>D</span>
        <span>E</span>
        <span>V</span>
        <span>E</span>
        <span>L</span>
        <span>O</span>
        <span>P</span>
        <span>M</span>
        <span>E</span>
        <span>N</span>
        <span>T</span>
        <span>&nbsp;&nbsp;</span>
        <span class="warehouse-letter">W</span>
        <span class="warehouse-letter">A</span>
        <span class="warehouse-letter">R</span>
        <span class="warehouse-letter">E</span>
        <span class="warehouse-letter">H</span>
        <span class="warehouse-letter">O</span>
        <span class="warehouse-letter">U</span>
        <span class="warehouse-letter">S</span>
        <span class="warehouse-letter">E</span>
      </h2>
    </section>

    <div class="modalRow form-row" style="margin-top: 85px;">
      <div class="modalBLOCK form-fields">
        <div class="modalRow" style="margin-left: -10px;">
          <input class="inputT code-field" style="width: 110px;" placeholder="RIV-0881" />
          <input class="input name-field" style="width: 280px;" placeholder="наименование позиции" />
          <input class="input category-field" style="width: 200px;" placeholder="категория" />
          <input class="inputT url-field" placeholder="URL" />
          <input class="inputT supplier-field" style="width: 120px;" placeholder="поставщик" />
          <div class="select-wrapper">
            <input class="input select-input" style="width: 100px; border: 1px solid #212121;" placeholder="изм." readonly />
          </div>
          <input class="inputSUM qty-field" style="width: 70px;" placeholder="000 000" />
          <input class="inputSUM price-field" style="width: 100px;" placeholder="000 000 000" />
        </div>
      </div>
      <button class="button-form primary" style="margin-top: 18px; margin-left: 0px;" id="create-order">создать позицию</button>
    </div>
  <div class="modalRow">
    <div class="radio-inputs" style="margin-top: -15px; margin-left: 10px;" role="radiogroup" aria-label="режим отображения">
        <label class="radio">
          <input type="radio" name="modal4-mode" value="orders" checked />
          <span class="name">мои заказы</span>
        </label>
        <label class="radio">
          <input type="radio" name="modal4-mode" value="warehouse" />
          <span class="name">склад, материалы</span>
        </label>
        <label class="radio">
          <input type="radio" name="modal4-mode" value="stocks" />
          <span class="name">склад, остатки</span>
        </label>
        <label class="radio">
          <input type="radio" name="modal4-mode" value="manufactured products" />
          <span class="name">готовая продукция</span>
        </label>
    </div>

    <div class="modalRow action-bar" style="margin-top: -27px; margin-left: 20px;">
      <button class="button-form" id="move-warehouse">переместить на склад</button>
      <button class="button-form" id="delete-selected">удалить выбранное</button>
    </div>
    
  </div>
</div>

  <div class="modal4-scroll-wrapper">
    <div class="modal-bottom glass-panel modal4-window">
      <div class="modalVNUT-content modal4-content"></div>
    </div>
  </div>

  <template id="modal4-order-template">
    <div class="modalBLOCK" data-id="" data-price="">
      <div class="modalRow">
        <label class="checkbox">
          <input type="checkbox" />
        </label>
        <input class="inputT code-field" data-field="order_code" style="width: 110px;" placeholder="RIV-0881" readonly />
        <input class="input name-field" data-field="item_name" style="width: 280px;" placeholder="наименование" readonly />
        <input class="input category-field" data-field="item_category" style="width: 200px;" placeholder="категория" readonly />
        <input class="input" data-field="status" style="width: 100px; text-align: center;" placeholder="статус" readonly />
        <div class="input date-time-field" style="width: 190px;" data-field="date-time" aria-label="дата и время">
          <span class="date-time-field__time"></span>
          <span class="date-time-field__date"></span>
        </div>
        <input class="inputT supplier-field" style="width: 120px;" data-field="supplier" placeholder="поставщик" readonly />
        <span class="spec-icon" data-field="spec-url" data-url="">
          <i class="material-symbols-outlined">captive_portal</i>
        </span>
        <input class="input" style="width: 60px; text-align: center;" data-field="base_unit" placeholder="изм." readonly />
        <input class="inputSUM" style="width: 70px;" data-field="base_qty" placeholder="000 000" readonly />
        <input class="inputSUM" style="width: 70px;" data-field="base_price" placeholder="000 000 000" readonly />
        <input class="inputSUM" style="width: 100px;" data-field="total" placeholder="000 000 000" readonly />
        <div class="notes-field-wrapper" style="width: 375px;">
          <textarea class="input notes-field" data-field="notes" placeholder="для заметок"></textarea>
        </div>
      </div>
    </div>
  </template>

  <template id="modal4-order-template-uni">
    <div class="modalBLOCK" data-id="" data-price="">
      <div class="modalRow">
        <label class="checkbox">
          <input type="checkbox" />
        </label>
        <input class="inputT code-field" data-field="order_code" style="width: 110px;" placeholder="RIV-0881" readonly />
        <input class="input name-field" data-field="item_name" style="width: 280px;" placeholder="наименование" readonly />
        <input class="input category-field" data-field="item_category" style="width: 200px;" placeholder="категория" readonly />
          <i class="material-symbols-outlined">captive_portal</i>
        </span>
        <input class="input" style="width: 60px; text-align: center;" data-field="base_unit" placeholder="изм." readonly />
        <input class="inputSUM" style="width: 70px;" data-field="base_qty" placeholder="000 000" readonly />
        <input class="inputSUM" style="width: 70px;" data-field="base_price" placeholder="000 000 000" readonly />
        <input class="inputSUM" style="width: 100px;" data-field="total" placeholder="000 000 000" readonly />
      </div>
    </div>
  </template>
  
</div>


<script>
  (function () {
    const modal = document.getElementById('modal4-container');
    if (!modal) return;

    const topPanel = modal.querySelector('.modal-top');
    const canvas = topPanel && topPanel.querySelector('#modal4-ambient-canvas');
    if (!topPanel || !canvas) return;

    class ClassicalNoise {
      constructor(randomSource) {
        const randomFn = typeof randomSource === 'function'
          ? randomSource
          : (randomSource && typeof randomSource.random === 'function'
            ? randomSource.random.bind(randomSource)
            : Math.random);

        this.grad3 = [
          [1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0],
          [1, 0, 1], [-1, 0, 1], [1, 0, -1], [-1, 0, -1],
          [0, 1, 1], [0, -1, 1], [0, 1, -1], [0, -1, -1]
        ];

        this.p = new Uint8Array(256);
        for (let i = 0; i < 256; i++) {
          this.p[i] = Math.floor(randomFn() * 256);
        }

        this.perm = new Uint8Array(512);
        for (let i = 0; i < 512; i++) {
          this.perm[i] = this.p[i & 255];
        }
      }

      fade(t) {
        return t * t * t * (t * (t * 6 - 15) + 10);
      }

      lerp(a, b, t) {
        return (1 - t) * a + t * b;
      }

      dot(g, x, y, z) {
        return g[0] * x + g[1] * y + g[2] * z;
      }

      noise(x, y, z) {
        const perm = this.perm;
        const grad3 = this.grad3;

        const X = Math.floor(x) & 255;
        const Y = Math.floor(y) & 255;
        const Z = Math.floor(z) & 255;

        x -= Math.floor(x);
        y -= Math.floor(y);
        z -= Math.floor(z);

        const u = this.fade(x);
        const v = this.fade(y);
        const w = this.fade(z);

        const A = perm[X] + Y;
        const AA = perm[A] + Z;
        const AB = perm[A + 1] + Z;
        const B = perm[X + 1] + Y;
        const BA = perm[B] + Z;
        const BB = perm[B + 1] + Z;

        return this.lerp(
          this.lerp(
            this.lerp(
              this.dot(grad3[perm[AA] % 12], x, y, z),
              this.dot(grad3[perm[BA] % 12], x - 1, y, z),
              u
            ),
            this.lerp(
              this.dot(grad3[perm[AB] % 12], x, y - 1, z),
              this.dot(grad3[perm[BB] % 12], x - 1, y - 1, z),
              u
            ),
            v
          ),
          this.lerp(
            this.lerp(
              this.dot(grad3[perm[AA + 1] % 12], x, y, z - 1),
              this.dot(grad3[perm[BA + 1] % 12], x - 1, y, z - 1),
              u
            ),
            this.lerp(
              this.dot(grad3[perm[AB + 1] % 12], x, y - 1, z - 1),
              this.dot(grad3[perm[BB + 1] % 12], x - 1, y - 1, z - 1),
              u
            ),
            v
          ),
          w
        );
      }
    }

    const ctx = canvas.getContext('2d');
    const perlin = new ClassicalNoise();

    const variation = 0.0025;
    const baseSpeed = 0.000275;
    const speedSpread = 0.00014;
    const speedDampening = 0.2;

    let width = 0;
    let height = 0;
    let startY = 0;
    let deviceRatio = window.devicePixelRatio || 1;
    let lineCount = 0;
    let variators = new Float32Array(0);
    let speeds = new Float32Array(0);
    let phaseOffsets = new Float32Array(0);
    let depthOffsets = new Float32Array(0);
    let directions = new Int8Array(0);

    const rebuildLines = () => {
      const desiredLines = Math.max(9, Math.min(28, Math.round(width / 28)));
      if (desiredLines === lineCount) return;

      const nextVariators = new Float32Array(desiredLines);
      const nextSpeeds = new Float32Array(desiredLines);
      const nextPhaseOffsets = new Float32Array(desiredLines);
      const nextDepthOffsets = new Float32Array(desiredLines);
      const nextDirections = new Int8Array(desiredLines);

      for (let i = 0; i < desiredLines; i++) {
        nextVariators[i] = i < variators.length ? variators[i] : Math.random() * 1000;
        const speedBase = baseSpeed + (i / Math.max(1, desiredLines - 1)) * speedSpread;
        nextSpeeds[i] = speedBase * (0.85 + Math.random() * 0.45);
        nextPhaseOffsets[i] = i < phaseOffsets.length ? phaseOffsets[i] : Math.random() * Math.PI * 2;
        nextDepthOffsets[i] = i < depthOffsets.length ? depthOffsets[i] : Math.random() * 600;
        nextDirections[i] = i < directions.length ? directions[i] || 1 : (Math.random() > 0.5 ? 1 : -1);
      }

      variators = nextVariators;
      speeds = nextSpeeds;
      phaseOffsets = nextPhaseOffsets;
      depthOffsets = nextDepthOffsets;
      directions = nextDirections;
      lineCount = desiredLines;
    };

    const resize = () => {
      const rect = topPanel.getBoundingClientRect();
      width = Math.max(0, Math.floor(rect.width));
      height = Math.max(0, Math.floor(rect.height));
      startY = height / 2;
      deviceRatio = window.devicePixelRatio || 1;

      canvas.width = width * deviceRatio;
      canvas.height = height * deviceRatio;
      canvas.style.width = `${width}px`;
      canvas.style.height = `${height}px`;

      ctx.setTransform(deviceRatio, 0, 0, deviceRatio, 0, 0);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      rebuildLines();
    };

    const handleResize = () => {
      resize();
    };

    let lastTime = null;

    const draw = (delta) => {
      if (!width || !height || lineCount === 0) return;

      ctx.setTransform(deviceRatio, 0, 0, deviceRatio, 0, 0);
      ctx.clearRect(0, 0, width, height);

      const baseAmplitude = Math.min(height * 0.6, 160);
      const lineSeparation = baseAmplitude * 0.05;
      const step = Math.max(1, Math.round(width / 420));

      ctx.shadowColor = '#212121';
      ctx.shadowBlur = 17;

      for (let i = 0; i < lineCount; i++) {
        ctx.beginPath();

        const depthOffset = depthOffsets[i];
        const phaseOffset = phaseOffsets[i];
        const direction = directions[i] || 1;
        const verticalOffset = (i - (lineCount - 1) / 2) * lineSeparation;
        const localAmplitude = baseAmplitude * (0.55 + Math.sin(phaseOffset) * 0.1 + (i / Math.max(1, lineCount - 1)) * 0.3);

        let peakNoise = 0;

        for (let x = 0; x <= width; x += step) {
          const noiseSample = x * variation;
          const noiseValue = perlin.noise(
            noiseSample + variators[i],
            noiseSample * 0.65 + depthOffset * 0.2,
            variators[i] * 0.4 + phaseOffset * 0.25
          );
          const y = startY + verticalOffset + noiseValue * localAmplitude;

          if (x === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
          peakNoise = Math.max(peakNoise, Math.abs(noiseValue));
        }
        const baseAlpha = 0.12;
        const alpha = Math.min(0.7, baseAlpha + peakNoise * 0.4);

        ctx.globalAlpha = alpha;
        ctx.lineWidth = Math.max(0.55, 1.45 - i * 0.022);
        ctx.strokeStyle = `rgba(${158 - i * 1.8}, ${167 - i * 1.5}, 147, 1)`;

        ctx.stroke();
        ctx.closePath();

        const dampenedDelta = delta * speedDampening;
        variators[i] += speeds[i] * dampenedDelta * direction;
        phaseOffsets[i] += speeds[i] * dampenedDelta * 0.25 * direction;
        depthOffsets[i] += speeds[i] * dampenedDelta * 0.05 * direction;
      }

      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;
    };

    const render = (timestamp) => {
      if (lastTime === null) {
        lastTime = timestamp;
      }

      const delta = Math.min(64, Math.max(16, timestamp - lastTime));
      lastTime = timestamp;

      draw(delta);
      requestAnimationFrame(render);
    };

    handleResize();
    requestAnimationFrame(render);

    window.addEventListener('resize', handleResize);
    if (window.ResizeObserver) {
      const observer = new ResizeObserver(handleResize);
      observer.observe(topPanel);
    }
  })();
</script>


<script type="module">
export function initModal4() {
  const supabase = window.supabase;
  const rawUserKey = window.USER_KEY;
  const authUserId = window.AUTH_ID;
  const DB_USER_KEY = authUserId || rawUserKey;
  let DB_COMPANY_ID = window.companyId || window.companyID || null;
  let resolvingCompanyIdPromise = null;
  const ORDER_STATUS = 'заказано';

  const modal = document.getElementById('modal4-container');
  if (!modal) return;

  if (!supabase) {
    console.warn('[modal4.html] Supabase client не найден');
    return;
  }
  if (!DB_USER_KEY && !DB_COMPANY_ID) {
    console.warn('[modal4.html] отсутствует идентификатор пользователя или компании');
    return;
  }

  const resolveCompanyId = async () => {
    if (DB_COMPANY_ID) return DB_COMPANY_ID;
    if (resolvingCompanyIdPromise) return resolvingCompanyIdPromise;
    if (!supabase) return null;

    const localId = window.LOCAL_USER_ID;
    const isAdmin = Boolean(window.IS_ADMIN);
    const tablesToCheck = isAdmin
      ? ['administrators', 'employees']
      : ['employees', 'administrators'];

    resolvingCompanyIdPromise = (async () => {
      for (const table of tablesToCheck) {
        try {
          let query = supabase
            .from(table)
            .select('company_id')
            .limit(1);

          if (localId) {
            query = query.eq('id', localId);
          } else if (DB_USER_KEY) {
            query = query.eq('user_key', DB_USER_KEY);
          } else if (rawUserKey) {
            query = query.eq('user_key', rawUserKey);
          } else {
            continue;
          }

          const { data, error } = await query;
          if (error) {
            console.warn(`[modal4.html] не удалось получить company_id из ${table}:`, error);
            continue;
          }

          if (Array.isArray(data) && data.length) {
            const companyId = data[0]?.company_id ?? null;
            if (companyId) {
              DB_COMPANY_ID = companyId;
              if (!window.companyId) window.companyId = companyId;
              return companyId;
            }
          }
        } catch (err) {
          console.warn(`[modal4.html] исключение при получении company_id из ${table}:`, err);
        }
      }

      return DB_COMPANY_ID;
    })();

    try {
      return await resolvingCompanyIdPromise;
    } finally {
      resolvingCompanyIdPromise = null;
    }
  };

  console.log('[modal4.html] PAGE 4 активирован');

  const ordersContainer = modal.querySelector('.modalVNUT-content');
  const statEls = modal.querySelectorAll('.stat-value');
  const countEl = statEls[0] ?? null;
  const sumEl = statEls[1] ?? null;
  const actionRow = modal.querySelector('.action-bar');
  const selectOverlay = modal.querySelector('#modal4-select-overlay');
  const selectDropdown = modal.querySelector('#modal4-global-select-dropdown');
  const selectFrame = modal.querySelector('#modal4-global-select-frame');
  const autocompleteDropdown = modal.querySelector('#modal4-autocomplete-dropdown');
  const formRow = modal.querySelector('.form-fields .modalRow');
  const formRowContainer = formRow?.closest('.modalRow.form-row');
  const createButton = modal.querySelector('#create-order');
  const deleteButton = modal.querySelector('#delete-selected');
  const moveButton = modal.querySelector('#move-warehouse');
  const selectInput = modal.querySelector('.select-input');
  const modeRadios = modal.querySelectorAll('input[name="modal4-mode"]');
  const DROPDOWN_POINTER_TOLERANCE = 0.1;

  const MODE_ORDERS = 'orders';
  const MODE_WAREHOUSE = 'warehouse';
  const MODE_STOCKS = 'stocks';
  const MODE_MANUFACTURED = 'manufactured products';

  const modeConfigs = {
    [MODE_ORDERS]: {
      table: 'modal4_orders',
      template: modal.querySelector('#modal4-order-template'),
      statuses: ['заказано'],
    },
    [MODE_WAREHOUSE]: {
      table: 'modal4_orders',
      template: modal.querySelector('#modal4-order-template'),
      statuses: ['на складе', 'списание'],
    },
    [MODE_STOCKS]: {
      table: 'modal4_orders_uni',
      template: modal.querySelector('#modal4-order-template-uni'),
    },
    [MODE_MANUFACTURED]: {
      table: 'modal4_orders',
      template: modal.querySelector('#modal4-order-template'),
      statuses: ['изготовлено'],
    },
  };

  let activeMode = MODE_ORDERS;

  const isStocksMode = (mode = activeMode) => String(mode ?? '').toLowerCase() === MODE_STOCKS;

  const hintsCache = {
    [MODE_ORDERS]: null,
    [MODE_WAREHOUSE]: null,
    [MODE_STOCKS]: null,
    [MODE_MANUFACTURED]: null,
  };

  const getModeConfig = (mode = activeMode) => modeConfigs[mode] ?? modeConfigs[MODE_WAREHOUSE];
  const getModeTable = (mode = activeMode) => getModeConfig(mode)?.table ?? modeConfigs[MODE_WAREHOUSE].table;
  const canUseUserKeyFilter = (mode = activeMode) => !isStocksMode(mode);
  const getModeTemplate = (mode = activeMode) => getModeConfig(mode)?.template ?? modeConfigs[MODE_WAREHOUSE].template;

  const getModeStatuses = (mode = activeMode) => {
    const statuses = getModeConfig(mode)?.statuses;
    return Array.isArray(statuses) && statuses.length ? statuses : null;
  };

  const createStatusVariants = statuses => {
    if (!Array.isArray(statuses)) return [];
    const variants = new Set();
    statuses
      .map(status => String(status ?? '').trim())
      .filter(Boolean)
      .forEach(status => {
        const lower = status.toLowerCase();
        const upper = status.toUpperCase();
        const capitalized = lower
          .split(' ')
          .map(part => part ? part[0].toUpperCase() + part.slice(1) : part)
          .join(' ');
        variants.add(status);
        variants.add(lower);
        variants.add(upper);
        variants.add(capitalized);
      });
    return Array.from(variants).filter(Boolean);
  };

  const applyStatusFilterToQuery = (query, statuses) => {
    if (!query) return query;
    const variants = createStatusVariants(statuses);
    if (!variants.length) return query;
    
    const sanitized = [...new Set(
      variants
        .map(status => String(status ?? '')
          .replace(/\u00a0/g, ' ')
          .replace(/\s+/g, ' ')
          .trim())
        .filter(Boolean)
    )];

    if (!sanitized.length) return query;
    try {
       let builder = query.in('status', sanitized);

      const likeConditions = sanitized
        .map(status => status
          .replace(/%/g, '\\%')
          .replace(/_/g, '\\_')
          .replace(/,/g, '\\,'))
        .map(status => `status.ilike.%${status}%`)
        .join(',');

      if (likeConditions) {
        builder = builder.or(likeConditions);
      }

      return builder;
    } catch (err) {
      console.warn('[modal4.html] не удалось применить фильтр статусов через query.in', err);
      return query;
    }
  };

  const toggleFade = (element, fade) => {
    if (!element) return Promise.resolve();
    const className = 'is-faded';
    const shouldApply = Boolean(fade);
    if (element.classList.contains(className) === shouldApply) {
      return Promise.resolve();
    }
    return new Promise(resolve => {
      const handle = event => {
        if (event?.target === element) {
          element.removeEventListener('transitionend', handle);
          resolve();
        }
      };
      element.addEventListener('transitionend', handle, { once: true });
      requestAnimationFrame(() => {
        element.classList.toggle(className, shouldApply);
      });
      setTimeout(() => {
        element.removeEventListener('transitionend', handle);
        resolve();
      }, 360);
    });
  };

  const fadeOut = element => toggleFade(element, true);
  const fadeIn = element => toggleFade(element, false);

  const fmtNum = value => {
    if (value === null || value === undefined || value === '') return '';
    const num = Number(value);
    if (!Number.isFinite(num)) return '';
    return num.toLocaleString('ru-RU');
  };

  const sanitizeNoteValue = value => {
    if (value === null || value === undefined) return '';
    return String(value).replace(/\r\n/g, '\n');
  };

  const isNoteEffectivelyEmpty = value => sanitizeNoteValue(value).trim() === '';

  const NOTES_DEBOUNCE_MS = 500;
  const noteUpdateTimers = new Map();

  const getNoteTimerKey = (mode, id) => {
    const table = getModeTable(mode);
    return `${table ?? 'modal4_orders'}::${id ?? ''}`;
  };

  const setNoteBusyState = (field, busy) => {
    if (!(field instanceof HTMLTextAreaElement)) return;
    field.classList.toggle('is-busy', Boolean(busy));
  };

  const saveNoteValue = async (mode, id, value, field) => {
    if (!id) return;
    const normalized = sanitizeNoteValue(value);
    const lastSaved = field?.dataset?.lastSaved ?? '';
    if (normalized === lastSaved) return;

    setNoteBusyState(field, true);
    try {
      const payloadValue = isNoteEffectivelyEmpty(normalized) ? null : normalized;
      let updateQuery = supabase
        .from(getModeTable(mode))
        .update({
          notes: payloadValue,
          updated_at: new Date().toISOString(),
        })
        .eq('id', id);

      const companyId = await resolveCompanyId();
      if (companyId) {
        updateQuery = updateQuery.eq('company_id', companyId);
      } else if (canUseUserKeyFilter(mode) && DB_USER_KEY) {
        updateQuery = updateQuery.eq('user_key', DB_USER_KEY);
      }

      const { error } = await updateQuery;
      if (error) throw error;

      if (field) {
        field.dataset.lastSaved = normalized;
        if (field.value !== normalized) {
          field.value = normalized;
        }
      }
    } catch (error) {
      console.error('[modal4.html] ошибка сохранения заметок', error);
      if (field) {
        const fallback = field.dataset.lastSaved ?? '';
        if (field.value !== fallback) {
          field.value = fallback;
        }
      }
    } finally {
      setNoteBusyState(field, false);
    }
  };

  const scheduleNoteUpdate = (mode, id, value, field) => {
    if (!id) return;
    const normalized = sanitizeNoteValue(value);
    const lastSaved = field?.dataset?.lastSaved ?? '';
    if (normalized === lastSaved) return;

    const key = getNoteTimerKey(mode, id);
    if (noteUpdateTimers.has(key)) {
      clearTimeout(noteUpdateTimers.get(key));
    }

    noteUpdateTimers.set(key, window.setTimeout(() => {
      noteUpdateTimers.delete(key);
      saveNoteValue(mode, id, normalized, field);
    }, NOTES_DEBOUNCE_MS));
  };

  const flushNoteUpdate = async (mode, id, value, field) => {
    if (!id) return;
    const key = getNoteTimerKey(mode, id);
    if (noteUpdateTimers.has(key)) {
      clearTimeout(noteUpdateTimers.get(key));
      noteUpdateTimers.delete(key);
    }
    await saveNoteValue(mode, id, value, field);
  };

  const setupNotesField = (block, mode, record) => {
    if (!(block instanceof HTMLElement)) return;
    const wrapper = block.querySelector('.notes-field-wrapper');
    const field = wrapper?.querySelector('.notes-field');
    if (!(field instanceof HTMLTextAreaElement)) return;

    const orderId = block.dataset.id ?? '';
    const initial = sanitizeNoteValue(record?.notes ?? field.value ?? '');
    field.value = initial;
    field.dataset.lastSaved = initial;

    const expand = () => {
      if (wrapper) {
        wrapper.classList.add('is-expanded');
      }
    };

    const collapse = () => {
      if (wrapper) {
        wrapper.classList.remove('is-expanded');
      }
    };

    field.addEventListener('focus', () => {
      expand();
    });

    field.addEventListener('click', () => {
      expand();
    });

    field.addEventListener('blur', () => {
      collapse();
      flushNoteUpdate(mode, orderId, field.value, field);
    });

    field.addEventListener('pointerleave', () => {
      if (document.activeElement !== field) {
        collapse();
      }
    });

    field.addEventListener('input', () => {
      scheduleNoteUpdate(mode, orderId, field.value, field);
    });
  };

  const MONTHS_RU = [
    'января',
    'февраля',
    'марта',
    'апреля',
    'мая',
    'июня',
    'июля',
    'августа',
    'сентября',
    'октября',
    'ноября',
    'декабря',
  ];

  const formatCreatedAt = value => {
    if (!value) {
      return { time: '', date: '' };
    }
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) {
      return { time: '', date: '' };
    }
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const month = MONTHS_RU[date.getMonth()] ?? '';
    const year = date.getFullYear();
    if (!month) {
      return { time: '', date: '' };
    }
    return {
      time: `${hours}:${minutes}`,
      date: `${day} ${month} ${year} г.`,
    };
  };

  const parseNumberNullable = str => {
    const normalized = String(str ?? '')
      .replace(/[\s\u202f]/g, '')
      .replace(',', '.')
      .trim();
    if (!normalized) return null;
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? parsed : null;
  };

  const numberToStorageString = num => {
    if (num === null || num === undefined) return null;
    const numeric = Number(num);
    return Number.isFinite(numeric) ? numeric.toString() : null;
  };

  const isUniversalGroup = group => String(group ?? '')
    .trim()
    .toLowerCase() === 'универсальные';


  const parseFloatSafe = str =>
    parseFloat(String(str ?? '').replace(/[\s\u202f]/g, '').replace(',', '.')) || 0;

  const sumInputs = formRow?.querySelectorAll('.inputSUM') ?? [];
  sumInputs.forEach(el => {
    if (el.dataset.bindSum === '1') return;
    el.addEventListener('focus', () => {
      const hasStoredRaw = Object.prototype.hasOwnProperty.call(el.dataset, 'raw');
      const trimmed = el.value.trim();
      if (!hasStoredRaw && !trimmed) {
        el.value = '';
        return;
      }
      const rawCandidate = hasStoredRaw ? Number(el.dataset.raw) : parseFloatSafe(el.value);
      if (!Number.isNaN(rawCandidate)) {
        el.value = Number(rawCandidate).toFixed(2);
      }
    });
    el.addEventListener('blur', () => {
      const trimmed = el.value.trim();
      if (!trimmed) {
        el.value = '';
        delete el.dataset.raw;
        return;
      }
      const raw = parseFloatSafe(el.value);
      if (isNaN(raw)) {
        el.value = '';
        delete el.dataset.raw;
        return;
      }
      el.dataset.raw = raw;
      el.value = fmtNum(raw);
    });
    el.dataset.bindSum = '1';
  });

  function animateStat(el, newVal) {
    if (!el) return;
    const formatted = fmtNum(newVal);
    if (el.dataset.value === formatted) return;

    el.dataset.value = formatted;
    el.innerHTML = '';
    [...formatted].forEach((ch, idx) => {
      const span = document.createElement('span');
      span.textContent = ch;
      span.style.animationDelay = `${idx * 50}ms`;
      el.appendChild(span);
    });
  }

  function recalcStats() {
    if (!countEl && !sumEl) return;
    const blocks = ordersContainer.querySelectorAll('.modalBLOCK');
    const totalQty = blocks.length;
    const totalCost = [...blocks].reduce((sum, block) => {
      return sum + parseFloatSafe(block.dataset.price);
    }, 0);

    animateStat(countEl, totalQty);
    animateStat(sumEl, totalCost);
  }

  const findUnit = (value, units) => {
    if (!value) return undefined;
    return units.find(u => u.unit_short === value) || units.find(u => u.unit_name === value);
  };


  async function loadUnitsMeasure() {
    const { data, error } = await supabase
      .from('units_measure')
      .select('unit_name, unit_short, unit_group, multiplier, base_unit_short')
      .order('unit_group', { ascending: true })
      .order('multiplier', { ascending: true });

    if (error) {
      console.error(error);
      return [];
    }
    return data ?? [];
  }

  let cachedUnits = [];
  const unitsPromise = loadUnitsMeasure().then(units => {
    cachedUnits = units ?? [];
    return cachedUnits;
  });

  const normalizeHintRecord = (mode, record) => {
    if (!record) return {};
    if (isStocksMode(mode)) {
      return {
        order_code: record.order_code ?? '',
        item_name: record.item_name ?? '',
        item_category: record.item_category ?? '',
        url: record.url ?? '',
        supplier: record.supplier ?? '',
        modification: record.base_unit ?? '',
        quantity_value: record.total_quantity ?? '',
        price_value: record.avg_cost ?? '',
        total_amount: record.stock_value ?? '',
      };
    }
    return { ...record };
  };

  async function loadHints(mode = activeMode, { force = false } = {}) {
    const config = getModeConfig(mode);
    if (!config) return [];
    if (!force && Array.isArray(hintsCache[mode])) return hintsCache[mode];

    let query = supabase.from(getModeTable(mode));

    const statuses = getModeStatuses(mode);
    const normalizedStatuses = Array.isArray(statuses)
      ? statuses.map(status => String(status ?? '').trim().toLowerCase()).filter(Boolean)
      : null;

    if (isStocksMode(mode)) {
      query = query
        .select('order_code, item_name, item_category, total_quantity, avg_cost, stock_value, base_unit');
    } else {
      query = query
        .select('order_code, item_name, item_category, url, supplier, modification, quantity_value, price_value, status');
      query = applyStatusFilterToQuery(query, statuses);
    }

    const companyId = await resolveCompanyId();
    if (companyId) {
      query = query.eq('company_id', companyId);
    } else if (canUseUserKeyFilter(mode) && DB_USER_KEY) {
      query = query.eq('user_key', DB_USER_KEY);
    }

    const { data, error } = await query;

    if (error) {
      console.error(error);
      hintsCache[mode] = [];
      return hintsCache[mode];
    }

    const filtered = Array.isArray(data)
      ? data.filter(item => {
        if (!normalizedStatuses) return true;
        const itemStatus = String(item?.status ?? '').trim().toLowerCase();
        if (itemStatus && normalizedStatuses.includes(itemStatus)) {
          return true;
        }
        if (Array.isArray(item?.statuses)) {
          return item.statuses
            .map(status => String(status ?? '').trim().toLowerCase())
            .some(status => status && normalizedStatuses.includes(status));
        }
        return false;
      })
      : [];

    const normalized = filtered.map(item => normalizeHintRecord(mode, item));

    hintsCache[mode] = normalized;
    return hintsCache[mode];
  }

  function getBaseUnit(unitShort, units) {
    const current = findUnit(unitShort, units);
    if (!current) return unitShort;
    if (isUniversalGroup(current.unit_group)) return unitShort;
    return current.base_unit_short ?? unitShort;
  }

  const normalizeOrderRecord = (mode, order, units) => {
    if (!order) return null;

    const stocksMode = isStocksMode(mode);
    const qtyRaw = stocksMode ? order.total_quantity : order.quantity_value;
    const priceRaw = stocksMode ? order.avg_cost : order.price_value;
    const qty = parseNumberNullable(qtyRaw);
    const price = parseNumberNullable(priceRaw);
    const baseUnitSource = order.base_unit ?? order.modification ?? '';
    const baseUnit = stocksMode
      ? (baseUnitSource ? String(baseUnitSource).trim() : '')
      : getBaseUnit(order.modification, units);
    const totalCandidate = stocksMode
      ? parseNumberNullable(order.stock_value)
      : (qty ?? 0) * (price ?? 0);
    const total = totalCandidate ?? ((qty ?? 0) * (price ?? 0));
    const createdAt = order.created_at ?? order.last_created_at ?? order.last_updated_at ?? null;
    const statusText = (() => {
      const combineStatuses = statuses => Array.isArray(statuses) && statuses.length
        ? statuses.map(status => String(status ?? '')).filter(Boolean).join(', ')
        : '';
      if (stocksMode) {
        return '';
      }
      const normalizedStatus = String(order.status ?? '').trim();
      if (normalizedStatus) {
        return normalizedStatus;
      }

      const statusesFromArray = combineStatuses(order.statuses);
      return statusesFromArray || ORDER_STATUS;
    })();

    return {
      id: order.id ?? order.order_code ?? order.item_name ?? '',
      order_code: order.order_code ?? '',
      item_name: order.item_name ?? '',
      item_category: order.item_category ?? '',
      url: order.url ?? '',
      supplier: order.supplier ?? '',
      modification: stocksMode ? baseUnit : (order.modification ?? ''),
      created_at: createdAt,
      qtySel: qty,
      priceSel: price,
      base_unit: baseUnit,
      baseQty: qty,
      priceBase: price,
      total,
      status: statusText,
      notes: order.notes ?? '',
    };
  };

  function applyUnitDataset(unitShort, units) {
    if (!selectInput) return;
    const match = findUnit(unitShort, units);
    if (!match) {
      delete selectInput.dataset.unitGroup;
      delete selectInput.dataset.multiplier;
      delete selectInput.dataset.baseUnit;
      delete selectInput.dataset.displayName;
      return;
    }

    selectInput.dataset.unitGroup = match.unit_group ?? '';
    selectInput.dataset.multiplier = String(match.multiplier ?? 1);
    selectInput.dataset.baseUnit = match.base_unit_short ?? unitShort;
    selectInput.dataset.displayName = match.unit_name ?? '';
  }

  async function loadExistingOrders(mode = activeMode, { replace = false } = {}) {
    const config = getModeConfig(mode);
    if (!config) return [];
    if (replace && ordersContainer) {
      ordersContainer.innerHTML = '';
    }
    const units = await unitsPromise;
    const stocksMode = isStocksMode(mode);
    const statuses = getModeStatuses(mode);
    const normalizedStatuses = Array.isArray(statuses)
      ? statuses.map(status => String(status ?? '').trim().toLowerCase()).filter(Boolean)
      : null;
    let query = supabase.from(getModeTable(mode));

    if (stocksMode) {
      query = query
        .select('order_code, item_name, item_category, total_quantity, avg_cost, stock_value, base_unit, company_id');
      query = query.order('order_code', { ascending: true });
    } else {
      query = query
        .select('*')
        .order('created_at', { ascending: false });
      query = applyStatusFilterToQuery(query, statuses);
    }

    const companyId = await resolveCompanyId();
    if (companyId) {
      query = query.eq('company_id', companyId);
    } else if (canUseUserKeyFilter(mode) && DB_USER_KEY) {
      query = query.eq('user_key', DB_USER_KEY);
    }

    const { data: orders, error } = await query;

    if (error) {
      console.error(error);
      updateActionButtons();
      recalcStats();
      return [];
    }
    const filteredOrders = Array.isArray(orders)
      ? orders.filter(order => {
        if (!normalizedStatuses) return true;
        const orderStatus = String(order?.status ?? '').trim().toLowerCase();
        if (orderStatus && normalizedStatuses.includes(orderStatus)) {
          return true;
        }
        if (Array.isArray(order?.statuses)) {
          const normalizedOrderStatuses = order.statuses
            .map(status => String(status ?? '').trim().toLowerCase())
            .filter(Boolean);
          return normalizedOrderStatuses.some(status => normalizedStatuses.includes(status));
        }
        return false;
      })
      : [];

    if (!filteredOrders.length) {
      updateActionButtons();
      recalcStats();
      return [];
    }

    filteredOrders.forEach(order => {
      const normalized = normalizeOrderRecord(mode, order, units);
      if (!normalized) return;

      const rendered = createOrderElement(mode, normalized);
      ordersContainer.appendChild(rendered);
      const created = rendered;
      const totalValue = Number(normalized.total ?? 0);
      created.dataset.price = Number.isFinite(totalValue) ? String(totalValue) : '0';
      if (normalized.url) {
        created.querySelector('.spec-icon')?.addEventListener('click', () => {
          window.open(normalized.url, '_blank');
        });
      }
    });

    recalcStats();
    updateActionButtons();
    return orders;
  }

  function createOrderElement(mode, o) {
    const totalPrice = o.total ?? o.priceSel ?? 0;
    const template = getModeTemplate(mode);
    const templateContent = template?.content?.firstElementChild;
    const baseElement = templateContent instanceof HTMLElement
      ? templateContent.cloneNode(true)
      : null;

    if (!(baseElement instanceof HTMLElement)) {
      throw new Error(`шаблон для режима ${mode} не найден или пуст`);
    }

    baseElement.dataset.id = String(o.id ?? '');
    baseElement.dataset.price = String(totalPrice ?? 0);
    baseElement.dataset.mode = String(mode ?? '');

    const assignValue = (field, value) => {
      const target = baseElement.querySelector(`[data-field="${field}"]`);
      if (!target) return;

      if (field === 'date-time' && target.classList.contains('date-time-field')) {
        const timeValue = value && typeof value === 'object' ? value.time ?? '' : '';
        const dateValue = value && typeof value === 'object' ? value.date ?? '' : '';
        const timeEl = target.querySelector('.date-time-field__time');
        const dateEl = target.querySelector('.date-time-field__date');
        if (timeEl) timeEl.textContent = timeValue;
        if (dateEl) dateEl.textContent = dateValue;
        target.dataset.time = timeValue;
        target.dataset.date = dateValue;
        return;
      }

      const normalized = value ?? '';
      if (target instanceof HTMLInputElement || target instanceof HTMLTextAreaElement) {
        target.value = normalized;
      } else if (target instanceof HTMLElement && field === 'spec-url') {
        target.dataset.url = normalized;
        } else if (target instanceof HTMLElement) {
        target.textContent = normalized;
      }
    };

    assignValue('order_code', o.order_code ?? '');
    assignValue('item_name', o.item_name ?? '');
    assignValue('item_category', o.item_category ?? '');
    assignValue('status', o.status ?? ORDER_STATUS);
    assignValue('date-time', formatCreatedAt(o.created_at));
    assignValue('spec-url', o.url ?? '');
    assignValue('supplier', o.supplier ?? '');
    assignValue('base_unit', o.base_unit ?? '');
    assignValue('base_qty', fmtNum(o.baseQty));
    assignValue('base_price', fmtNum(o.priceBase));
    assignValue('total', fmtNum(o.total));
    assignValue('notes', o.notes ?? '');

    setupNotesField(baseElement, mode, o);

    return baseElement;
  }

  function clearForm() {
    const inputs = formRow?.querySelectorAll('input') ?? [];
    inputs.forEach(input => {
      input.value = '';
      if (input.classList.contains('inputSUM')) {
        delete input.dataset.raw;
      }
    });
    if (selectInput) {
      delete selectInput.dataset.unitGroup;
      delete selectInput.dataset.multiplier;
      delete selectInput.dataset.baseUnit;
      delete selectInput.dataset.displayName;
    }
  }

  async function insertOrderToDB(record, mode = activeMode) {
    const { data, error } = await supabase
      .from(getModeTable(mode))
      .insert([record])
      .select('id')
      .single();

    if (error) throw error;
    return data.id;
  }

  function updateActionButtons() {
    const hasChecked = !!ordersContainer.querySelector('input[type="checkbox"]:checked');
    const showMove = hasChecked && activeMode === MODE_ORDERS;
    const showDelete = hasChecked && activeMode !== MODE_STOCKS;
    const shouldShowActionRow = hasChecked && (showMove || showDelete);
    actionRow?.classList.toggle('visible', shouldShowActionRow);
    if (moveButton) {
      if (showMove) {
        moveButton.removeAttribute('hidden');
      } else {
        moveButton.setAttribute('hidden', '');
      }
    }

    if (deleteButton) {
      if (showDelete) {
        deleteButton.removeAttribute('hidden');
      } else {
        deleteButton.setAttribute('hidden', '');
      }
    }
  }

  ordersContainer.addEventListener('change', event => {
    if (event.target instanceof HTMLInputElement && event.target.type === 'checkbox') {
      updateActionButtons();
    }
  });

  selectOverlay?.addEventListener('click', () => {
    closeDropdowns();
  });

  let pointerMonitorActive = false;
  let lastPointerPosition = null;

  const getActiveDropdown = () => {
    if (selectDropdown?.classList.contains('show')) return selectDropdown;
    if (autocompleteDropdown?.classList.contains('show')) return autocompleteDropdown;
    return null;
  };

  const isPointerWithinTolerance = position => {
    const dropdown = getActiveDropdown();
    if (!dropdown) return true;
    const rect = dropdown.getBoundingClientRect();
    const toleranceX = rect.width * DROPDOWN_POINTER_TOLERANCE;
    const toleranceY = rect.height * DROPDOWN_POINTER_TOLERANCE;
    return (
      position.x >= rect.left - toleranceX &&
      position.x <= rect.right + toleranceX &&
      position.y >= rect.top - toleranceY &&
      position.y <= rect.bottom + toleranceY
    );
  };

  const handlePointerMove = event => {
    const { clientX, clientY } = event;
    lastPointerPosition = { x: clientX, y: clientY };
    if (!isPointerWithinTolerance(lastPointerPosition)) {
      closeDropdowns();
    }
  };

  const handleDropdownScroll = () => {
    if (!lastPointerPosition) return;
    if (!isPointerWithinTolerance(lastPointerPosition)) {
      closeDropdowns();
    }
  };

  const startDropdownMonitoring = initialEvent => {
    if (initialEvent && typeof initialEvent.clientX === 'number' && typeof initialEvent.clientY === 'number') {
      lastPointerPosition = { x: initialEvent.clientX, y: initialEvent.clientY };
    }
    if (pointerMonitorActive) return;
    pointerMonitorActive = true;
    document.addEventListener('pointermove', handlePointerMove);
    document.addEventListener('scroll', handleDropdownScroll, true);
  };

  const stopDropdownMonitoring = () => {
    if (!pointerMonitorActive) {
      lastPointerPosition = null;
      return;
    }
    pointerMonitorActive = false;
    lastPointerPosition = null;
    document.removeEventListener('pointermove', handlePointerMove);
    document.removeEventListener('scroll', handleDropdownScroll, true);
  };

  function closeDropdowns() {
    stopDropdownMonitoring();
    selectDropdown?.classList.remove('show');
    autocompleteDropdown?.classList.remove('show');
    if (selectFrame) {
      selectFrame.classList.remove('show');
      selectFrame.style.left = '';
      selectFrame.style.top = '';
      selectFrame.style.width = '';
      selectFrame.style.height = '';
    }
    if (selectOverlay) selectOverlay.style.display = 'none';
  }

  let customSelectListenersBound = false;

  const syncSelectFrame = () => {
    if (!selectFrame || !selectDropdown?.classList.contains('show')) return;
    const dropdownRect = selectDropdown.getBoundingClientRect();
    const modalRect = modal.getBoundingClientRect();
    const offsetLeft = dropdownRect.left - modalRect.left + modal.scrollLeft;
    const offsetTop = dropdownRect.top - modalRect.top + modal.scrollTop;
    const visibleHeight = selectDropdown.offsetHeight;
    const scrollReveal = 12;
    const frameWidth = Math.max(dropdownRect.width - scrollReveal, 40);
    selectFrame.style.left = `${offsetLeft}px`;
    selectFrame.style.top = `${offsetTop}px`;
    selectFrame.style.width = `${frameWidth}px`;
    selectFrame.style.height = `${visibleHeight}px`;
    selectFrame.classList.add('show');
  };

  async function setupCustomSelect() {
    if (!selectInput || !selectDropdown || !selectOverlay) return;
    const units = await unitsPromise;

    if (!units.length) {
      console.warn('[modal4.html] список единиц измерения пуст');
      return;
    }

    const groupOrder = ['ДЛИННА', 'ОБЪЕМ', 'МАССА', 'УНИВЕРСАЛЬНЫЕ'];
    const normalizeGroupKey = group => String(group ?? '').trim();

    if (!selectDropdown.hasChildNodes()) {
      const fragment = document.createDocumentFragment();
      const groups = new Map();
      
      units.forEach(unit => {
        const key = normalizeGroupKey(unit.unit_group);
        if (!groups.has(key)) groups.set(key, []);
        groups.get(key).push(unit);
      });

      const sortedGroups = [...groups.entries()].sort((a, b) => {
        const [groupA] = a;
        const [groupB] = b;
        const idxA = groupOrder.indexOf(groupA.toUpperCase());
        const idxB = groupOrder.indexOf(groupB.toUpperCase());
        const safeA = idxA === -1 ? Number.MAX_SAFE_INTEGER : idxA;
        const safeB = idxB === -1 ? Number.MAX_SAFE_INTEGER : idxB;
        if (safeA !== safeB) return safeA - safeB;
        return groupA.localeCompare(groupB, 'ru');
      });
      sortedGroups.forEach(([groupName, groupUnits]) => {
        const title = document.createElement('div');
        title.className = 'select-group-title';
        title.textContent = groupName;
        fragment.appendChild(title);

        groupUnits
          .slice()
          .sort((a, b) => Number(a.multiplier ?? 1) - Number(b.multiplier ?? 1))
          .forEach(unit => {
            const option = document.createElement('div');
            option.className = 'select-option';
            option.innerHTML = `
              <span class="select-option-title">${unit.unit_name}</span>
              <span class="select-option-hint">${unit.unit_short}</span>
            `;
            option.dataset.short = unit.unit_short ?? '';
            option.dataset.group = unit.unit_group ?? '';
            option.dataset.multiplier = String(unit.multiplier ?? 1);
            option.dataset.baseUnit = unit.base_unit_short ?? (unit.unit_short ?? '');
            fragment.appendChild(option);
          });
      });
      
      selectDropdown.appendChild(fragment);
    }

    selectInput.addEventListener('click', event => {
      event.stopPropagation();
      const rect = selectInput.getBoundingClientRect();
      const modalRect = modal.getBoundingClientRect();
      const offsetLeft = rect.left - modalRect.left + modal.scrollLeft;
      const offsetTop = rect.bottom - modalRect.top + modal.scrollTop + 10;
      const dropdownWidth = rect.width * 2;
      selectDropdown.style.left = `${offsetLeft}px`;
      selectDropdown.style.top = `${offsetTop}px`;
      selectDropdown.style.width = `${dropdownWidth}px`;
      selectDropdown.classList.add('show');
      requestAnimationFrame(syncSelectFrame);
      selectOverlay.style.display = 'block';
      startDropdownMonitoring(event);
    });

    selectDropdown.addEventListener('click', event => {
      const target = event.target;
      const option = target?.closest('.select-option');
      if (!(option instanceof HTMLElement)) return;
      const unitShort = option.dataset.short ?? '';
      selectInput.value = unitShort;
      applyUnitDataset(unitShort, units);
      closeDropdowns();
    });
    if (!customSelectListenersBound) {
      document.addEventListener('keydown', event => {
        if (event.key === 'Escape') {
          closeDropdowns();
        }
      });

      window.addEventListener('resize', closeDropdowns);
      customSelectListenersBound = true;
    }
  }

  async function setupAutocomplete() {
    if (!formRow || !autocompleteDropdown || !selectOverlay) return;
    await loadHints(activeMode);
    const codeInput = formRow.querySelector('.code-field');
    const nameInput = formRow.querySelector('.name-field');
    const categoryInput = formRow.querySelector('.category-field');
    const urlInput = formRow.querySelector('.url-field');
    const supplierInput = formRow.querySelector('.supplier-field');
    const qtyInput = formRow.querySelector('.qty-field');
    const priceInput = formRow.querySelector('.price-field');

    if (!codeInput || !nameInput) return;

    const handleInput = event => {
      const src = event.target;
      if (!(src instanceof HTMLInputElement)) return;
      const value = src.value.trim().toLowerCase();
      if (value.length < 1) {
        closeDropdowns();
        return;
      }

      const currentHints = Array.isArray(hintsCache[activeMode])
        ? hintsCache[activeMode]
        : [];

      const list = src === codeInput
        ? currentHints.filter(h => (h.order_code ?? '').toLowerCase().includes(value))
        : currentHints.filter(h => (h.item_name ?? '').toLowerCase().includes(value));

      if (!list.length) {
        closeDropdowns();
        return;
      }

      autocompleteDropdown.innerHTML = '';
      list.forEach(record => {
        const option = document.createElement('div');
        option.className = 'ac-option';
        option.textContent = src === codeInput ? record.order_code : record.item_name;
        option.dataset.record = JSON.stringify(record);
        autocompleteDropdown.appendChild(option);
      });

      const rect = src.getBoundingClientRect();
      const modalRect = modal.getBoundingClientRect();
      const offsetLeft = rect.left - modalRect.left + modal.scrollLeft;
      const offsetTop = rect.bottom - modalRect.top + modal.scrollTop + 10;
      autocompleteDropdown.style.left = `${offsetLeft}px`;
      autocompleteDropdown.style.top = `${offsetTop}px`;
      autocompleteDropdown.style.width = `${rect.width}px`;
      autocompleteDropdown.classList.add('show');
      selectOverlay.style.display = 'block';
      startDropdownMonitoring();
    };

    autocompleteDropdown.addEventListener('click', event => {
      const target = event.target;
      if (!(target instanceof HTMLElement) || !target.classList.contains('ac-option')) return;
      const record = JSON.parse(target.dataset.record ?? '{}');
      codeInput.value = record.order_code ?? '';
      nameInput.value = record.item_name ?? '';
      if (categoryInput) categoryInput.value = record.item_category ?? '';
      if (urlInput) urlInput.value = record.url ?? '';
      if (supplierInput) supplierInput.value = record.supplier ?? '';
      if (selectInput) selectInput.value = record.modification ?? '';
      applyUnitDataset(selectInput?.value ?? '', cachedUnits);
      if (qtyInput) {
        if (record.quantity_value === null || record.quantity_value === undefined || record.quantity_value === '') {
          delete qtyInput.dataset.raw;
          qtyInput.value = '';
        } else {
          const qtyVal = parseFloatSafe(record.quantity_value);
          qtyInput.dataset.raw = String(qtyVal);
          qtyInput.value = fmtNum(qtyVal);
        }
      }
      if (priceInput) {
        if (record.price_value === null || record.price_value === undefined || record.price_value === '') {
          delete priceInput.dataset.raw;
          priceInput.value = '';
        } else {
          const priceVal = parseFloatSafe(record.price_value);
          priceInput.dataset.raw = String(priceVal);
          priceInput.value = fmtNum(priceVal);
        }
      }
      closeDropdowns();
    });

    codeInput.addEventListener('input', handleInput);
    nameInput.addEventListener('input', handleInput);
  }

  createButton?.addEventListener('click', async () => {
    if (isStocksMode()) {
      alert('Создание позиций недоступно в режиме "остатки".');
      return;
    }
    if (!formRow) return;
    const codeInput = formRow.querySelector('.code-field');
    const nameInput = formRow.querySelector('.name-field');
    const categoryInput = formRow.querySelector('.category-field');
    const urlInput = formRow.querySelector('.url-field');
    const supplierInput = formRow.querySelector('.supplier-field');
    const qtyInput = formRow.querySelector('.qty-field');
    const priceInput = formRow.querySelector('.price-field');
    const modificationInput = selectInput;
    if (!codeInput || !nameInput || !qtyInput || !priceInput) return;
    const units = await unitsPromise;

    const quantityRaw = qtyInput.dataset.raw ?? qtyInput.value.trim() ?? '';
    const priceRaw = priceInput.dataset.raw ?? priceInput.value.trim() ?? '';

    const companyIdForUser = await resolveCompanyId();

    const orderData = {
      user_key: DB_USER_KEY,
      company_id: companyIdForUser,
      order_code: codeInput.value.trim(),
      item_name: nameInput.value.trim(),
      item_category: categoryInput?.value.trim() ?? '',
      url: urlInput?.value.trim() ?? '',
      supplier: supplierInput?.value.trim() ?? '',
      modification: modificationInput?.value.trim() ?? '',
      quantity_value: quantityRaw,
      price_value: priceRaw,
      status: ORDER_STATUS,
      notes: '',
    };

    if (!orderData.order_code || !orderData.item_name) {
      alert('Заполните обязательные поля (код и наименование)');
      return;
    }

    const quantityOriginal = parseNumberNullable(orderData.quantity_value);
    const priceOriginal = parseNumberNullable(orderData.price_value);
    const selectedUnit = findUnit(orderData.modification, units);
    const canConvert = selectedUnit && !isUniversalGroup(selectedUnit.unit_group);
    const multiplierSelected = canConvert ? Number(selectedUnit.multiplier ?? 1) || 1 : 1;
    const baseUnit = canConvert
      ? (selectedUnit?.base_unit_short ?? orderData.modification)
      : orderData.modification;

    const qtyStored = quantityOriginal === null
      ? null
      : (canConvert ? quantityOriginal * multiplierSelected : quantityOriginal);
    const priceStored = (() => {
      if (priceOriginal === null) return null;
      const effectiveMultiplier = canConvert ? multiplierSelected : 1;
      if (quantityOriginal === null || quantityOriginal === 0) {
        if (!effectiveMultiplier) return null;
        return priceOriginal / effectiveMultiplier;
      }
      return priceOriginal / quantityOriginal / (effectiveMultiplier || 1);
    })();

    const qtyStoredStr = numberToStorageString(qtyStored);
    const priceStoredStr = numberToStorageString(priceStored);
    const total = (() => {
      if (priceStored !== null && qtyStored !== null) {
        return qtyStored * priceStored;
      }
      return priceOriginal ?? 0;
    })();

    try {
      const noteSanitized = sanitizeNoteValue(orderData.notes ?? '');
      const dbPayload = {
        order_code: orderData.order_code,
        item_name: orderData.item_name,
        item_category: orderData.item_category,
        url: orderData.url,
        supplier: orderData.supplier,
        modification: baseUnit,
        quantity_value: qtyStoredStr,
        price_value: priceStoredStr,
        status: orderData.status,
        notes: isNoteEffectivelyEmpty(noteSanitized) ? null : noteSanitized,
      };

      if (orderData.user_key) {
        dbPayload.user_key = orderData.user_key;
      }
      const payloadCompanyId = orderData.company_id || await resolveCompanyId();
      if (payloadCompanyId) {
        dbPayload.company_id = payloadCompanyId;
      }

      const id = await insertOrderToDB(dbPayload, activeMode);

      const rendered = createOrderElement(activeMode, {
        id,
        order_code: orderData.order_code,
        item_name: orderData.item_name,
        item_category: orderData.item_category,
        url: orderData.url,
        supplier: orderData.supplier,
        modification: baseUnit,
        created_at: new Date().toISOString(),
        qtySel: qtyStored,
        priceSel: priceStored,
        base_unit: baseUnit,
        baseQty: qtyStored,
        priceBase: priceStored,
        total,
        notes: noteSanitized,
      });

      ordersContainer.prepend(rendered);
      const created = rendered;
      created.dataset.price = total;
      created.classList.add('appear');
      requestAnimationFrame(() => {
        created.classList.add('appear-active');
        created.classList.remove('appear');
      });

      if (orderData.url) {
        created.querySelector('.spec-icon')?.addEventListener('click', () => {
          window.open(orderData.url, '_blank');
        });
      }

      if (!Array.isArray(hintsCache[activeMode])) {
        hintsCache[activeMode] = [];
      }
      hintsCache[activeMode].push({
        order_code: orderData.order_code,
        item_name: orderData.item_name,
        item_category: orderData.item_category,
        url: orderData.url,
        supplier: orderData.supplier,
        modification: baseUnit,
        quantity_value: qtyStoredStr,
        price_value: priceStoredStr,
      });

      updateActionButtons();
      recalcStats();
      clearForm();
    } catch (error) {
      alert('Ошибка при создании заказа: ' + error.message);
      console.error(error);
    }
  });

  deleteButton?.addEventListener('click', async () => {
    const checked = ordersContainer.querySelectorAll('input[type="checkbox"]:checked');
    if (!checked.length) return;

    const ids = [...checked]
      .map(cb => cb.closest('.modalBLOCK')?.dataset.id)
      .filter(Boolean);

    try {
      if (ids.length) {
        let deleteQuery = supabase
          .from(getModeTable())
          .delete()
          .in('id', ids);

        const deleteCompanyId = await resolveCompanyId();
        if (deleteCompanyId) {
          deleteQuery = deleteQuery.eq('company_id', deleteCompanyId);
        } else if (canUseUserKeyFilter(activeMode) && DB_USER_KEY) {
          deleteQuery = deleteQuery.eq('user_key', DB_USER_KEY);
        }

        const { error } = await deleteQuery;
        if (error) throw error;
      }

      checked.forEach(cb => cb.closest('.modalBLOCK')?.remove());
      updateActionButtons();
      recalcStats();
    } catch (error) {
      alert('Ошибка удаления: ' + error.message);
      console.error(error);
    }
  });

  moveButton?.addEventListener('click', async () => {
    const checkedBlocks = [...ordersContainer.querySelectorAll('input[type="checkbox"]:checked')]
      .map(cb => cb.closest('.modalBLOCK'))
      .filter(block => block instanceof HTMLElement);

    if (!checkedBlocks.length) return;

    if (activeMode !== MODE_WAREHOUSE && activeMode !== MODE_ORDERS) {
      alert('Перемещение доступно только в режимах "Мои заказы" и "Склад".');
      return;
    }

    const ids = checkedBlocks
      .map(block => block?.dataset?.id)
      .filter(Boolean);

    const nowISO = new Date().toISOString();

    try {
      if (ids.length) {
        let updateQuery = supabase
          .from(getModeTable(activeMode))
          .update({
            status: 'на складе',
            created_at: nowISO,
          })
          .in('id', ids);

        const updateCompanyId = await resolveCompanyId();
        if (updateCompanyId) {
          updateQuery = updateQuery.eq('company_id', updateCompanyId);
        } else if (canUseUserKeyFilter(activeMode) && DB_USER_KEY) {
          updateQuery = updateQuery.eq('user_key', DB_USER_KEY);
        }

        const { error } = await updateQuery;
        if (error) throw error;
      }

      const formatted = formatCreatedAt(nowISO);

      checkedBlocks.forEach(block => {
        const checkbox = block.querySelector('input[type="checkbox"]');
        if (checkbox instanceof HTMLInputElement) {
          checkbox.checked = false;
        }

        const statusTarget = block.querySelector('[data-field="status"]');
        if (statusTarget instanceof HTMLInputElement) {
          statusTarget.value = 'на складе';
        } else if (statusTarget instanceof HTMLElement) {
          statusTarget.textContent = 'на складе';
        }

        const dateField = block.querySelector('[data-field="date-time"]');
        if (dateField instanceof HTMLElement && dateField.classList.contains('date-time-field')) {
          const timeEl = dateField.querySelector('.date-time-field__time');
          const dateEl = dateField.querySelector('.date-time-field__date');
          if (timeEl) timeEl.textContent = formatted.time;
          if (dateEl) dateEl.textContent = formatted.date;
          dateField.dataset.time = formatted.time ?? '';
          dateField.dataset.date = formatted.date ?? '';
        }
      });

      updateActionButtons();
    } catch (error) {
      alert('Ошибка перемещения: ' + error.message);
      console.error(error);
    }
  });

  async function applyMode(mode) {
    if (typeof mode !== 'string') return;
    const next = mode.toLowerCase();
    if (!modeConfigs[next]) return;
    if (next === activeMode) return;

    closeDropdowns();
    await fadeOut(ordersContainer);
    activeMode = next;
    if (formRowContainer) {
      const shouldShowForm = activeMode === MODE_ORDERS;
      formRowContainer.classList.toggle('is-hidden', !shouldShowForm);
      formRowContainer.setAttribute('aria-hidden', shouldShowForm ? 'false' : 'true');
    }
    if (createButton) {
      const disableCreate = isStocksMode(next);
      createButton.disabled = disableCreate;
      if (disableCreate) {
        createButton.setAttribute('aria-disabled', 'true');
      } else {
        createButton.removeAttribute('aria-disabled');
      }
    }
    await loadExistingOrders(activeMode, { replace: true });
    await loadHints(activeMode);
    recalcStats();
    updateActionButtons();
    await fadeIn(ordersContainer);
  }

  modeRadios.forEach(radio => {
    radio.addEventListener('change', () => {
      if (radio.checked) {
        applyMode(radio.value);
      }
    });
  });

  loadHints(activeMode);
  setupCustomSelect();
  setupAutocomplete();
  loadExistingOrders(activeMode, { replace: true });
  recalcStats();
}

initModal4();
</script>
