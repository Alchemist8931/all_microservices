<!-- ========= modal1.html  (Проект 2) ========= -->
<div id="modal1-container">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined');
    :root {
      --fon:#f5f5f5;
      --card-bg:#ffffff;
      --accent:#212121;
      --radius:10px;
      --black-color:#000;
      --white-color2:#ffffff;
      --scrollbar-color:#e0e0e0;
    }
    * {
      box-sizing:border-box;
      font-family:'Comfortaa', sans-serif;
    }
    #modal1-container { height:100%; padding:10px; background:var(--fon); }
    .board { display:flex; gap:15px; height:100%; }
    .column { flex:1; background:var(--fon); border:1px solid rgba(0,0,0,0.1); border-radius:var(--radius); padding:10px; display:flex; flex-direction:column; }
    .column h3 { margin:0 0 10px 0; font-size:18px; }
    .task-list { flex:1; overflow-y:auto; list-style:none; padding:0; margin:0; }
    .task { background:var(--card-bg); border-radius:var(--radius); padding:8px; margin-bottom:8px; cursor:pointer; box-shadow:0 1px 2px rgba(0,0,0,0.1); }
    .full-view { display:none; }
    .add-task { margin-top:5px; }
    .modal { position:fixed; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; background:rgba(0,0,0,0.5); }
    .modal.show { display:flex; }
    .modal-content { background:var(--card-bg); border-radius:var(--radius); padding:20px; width:300px; max-height:80%; overflow-y:auto; }
    #view-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(255,255,255,0.6);
      backdrop-filter: blur(4px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s;
      z-index: 1000;
    }
    #view-modal.show { opacity: 1; pointer-events: auto; }
    #view-modal .view-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 20px;
      width: 70%;
      max-height: 90%;
      overflow-y: auto;
    }
    .textarea-scroll { max-height:150px; overflow-y:auto; resize:vertical; }
    .textarea-scroll::-webkit-scrollbar { width:6px; }
    .textarea-scroll::-webkit-scrollbar-track { background:var(--fon); border-radius:var(--radius); }
    .textarea-scroll::-webkit-scrollbar-thumb { background:var(--accent); border-radius:var(--radius); }

    .textareaZADACH-content {
      width: auto;
      padding: 0.5vw;
      margin: 0.3vw;
      resize: none;
      color: var(--black-color);
      height: auto;
      border: none;
      border-top: 2px solid var(--black-color);
      border-bottom: 2px solid var(--black-color);
      outline: none;
      background-color: var(--white-color2);
      font-size: 0.7vw;
      overflow: hidden;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .textareaZADACH-content::-webkit-scrollbar {
      width: 4px;
      background-color: var(--scrollbar-color);
      height: 90%;
    }

    .textareaZADACH-content::-webkit-scrollbar-thumb {
      background-color: var(--black-color);
      border-radius: 10px;
    }

    .textareaZADACH-content::-webkit-scrollbar-track {
      background-color: var(--scrollbar-color);
    }

    .checklist-container {
      font-family: sans-serif;
      max-width: 500px;
      margin: 40px auto;
      padding: 20px;
      background-color: #f4f7f6;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .checklist-title {
      text-align: center;
      color: #333;
      margin-bottom: 25px;
      font-size: 1.5em;
      font-weight: bold;
    }

    .checklist-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e0e0e0;
      position: relative;
    }

    .checklist-item:last-child {
      border-bottom: none;
    }

    .checklist-checkbox {
      margin-right: 12px;
      cursor: pointer;
      flex-shrink: 0;
      transform: scale(1.2);
      accent-color: #2ecc71;
    }

    .checklist-label {
      color: #444;
      cursor: pointer;
      position: relative;
      transition: color 0.4s ease-in-out;
      display: inline-block;
      width: fit-content;
    }

    .checklist-label::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 2px;
      background-color: #e74c3c;
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease-out;
    }

    .checklist-checkbox:checked + .checklist-label {
      color: #aaa;
    }

    .checklist-checkbox:checked + .checklist-label::after {
      transform: scaleX(1);
    }

    .card-container {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin: 10px 0;
      overflow: hidden;
    }

    .card-header {
      display: flex;
      align-items: center;
      padding: 10px;
      background:#f4f7f6;
    }

    .img-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background:#ccc;
      margin-right: 10px;
    }

    .text-chat { font-weight: bold; }

    .card-body { padding: 10px; }

    .messages-container {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .message-box {
      max-width: 80%;
      padding: 8px 12px;
      border-radius: 10px;
      color: #fff;
    }

    .message-box.left { background: #7f8c8d; align-self: flex-start; }
    .message-box.right { background: #2ecc71; align-self: flex-end; }

    .message-input { display: flex; gap: 5px; margin-top: 10px; }

    .message-send { flex: 1; resize: none; }

    .button-send { padding: 4px 10px; }
    
  </style>
  <div class="board">
    <div class="column" data-status="created">
      <h3>created</h3>
      <button class="add-task" onclick="openTaskModal('created')">Add Task</button>
      <ul class="task-list"></ul>
    </div>
    <div class="column" data-status="at work">
      <h3>at work</h3>
      <ul class="task-list"></ul>
    </div>
    <div class="column" data-status="completed">
      <h3>completed</h3>
      <ul class="task-list"></ul>
    </div>
    <div class="column" data-status="canceled">
      <h3>canceled</h3>
      <ul class="task-list"></ul>
    </div>
  </div>
</div>
<div id="task-modal" class="modal">
  <div class="modal-content">
    <h3 id="modal-title">Task</h3>
    <form id="task-form">
      <input type="hidden" id="task-id" />
      <input type="text" id="task-title" placeholder="Title" required /><br/>
      <textarea id="task-description" class="textareaZADACH-content" placeholder="Description" cols="50" rows="10" name="textarea"></textarea><br/>
      <input type="text" id="task-author" placeholder="Author" /><br/>
      <select id="task-executor"></select><br/>
      <input type="date" id="task-due" /><br/>
      <input type="text" id="task-observer" placeholder="Observer" /><br/>
      <div id="subtask-input">
        <input type="text" id="new-subtask-text" placeholder="Add subtask" />
        <button type="button" id="add-subtask-btn">Add</button>
      </div>
      <div id="task-subtasks" class="checklist-container">
        <div class="checklist-title">Subtasks</div>
      </div><br/>
      <button type="submit">Save</button>
      <button type="button" onclick="closeTaskModal()">Cancel</button>
    </form>
  </div>
</div>
<div id="view-modal">
  <div class="view-content"></div>
</div>
<script type="module">
  let tasks = [];
  let currentViewId = null;

function loadTasks() {
  tasks = JSON.parse(localStorage.getItem('kanban-tasks') || '[]');
  tasks.forEach(t => {
    if (Array.isArray(t.subtasks) && typeof t.subtasks[0] === 'string') {
      t.subtasks = t.subtasks.map(s => ({ text: s, done: false }));
    }
    if (!Array.isArray(t.subtasks)) t.subtasks = [];
    if (!Array.isArray(t.chat)) t.chat = [];
  });
  redraw();
}

function saveTasks() {
  localStorage.setItem('kanban-tasks', JSON.stringify(tasks));
}

  function clearSubtaskList() {
  const cont = document.getElementById('task-subtasks');
  if (cont) cont.innerHTML = '<div class="checklist-title">Subtasks</div>';
}

function addSubtaskRow(text = '', done = false) {
  const cont = document.getElementById('task-subtasks');
  if (!cont) return;
  const idx = cont.querySelectorAll('.checklist-item').length;
  const id = `subtask-${Date.now()}-${idx}`;
  const div = document.createElement('div');
  div.className = 'checklist-item';
  div.innerHTML =
    `<input type="checkbox" id="${id}" class="checklist-checkbox" ${done ? 'checked' : ''}>` +
    `<label for="${id}" class="checklist-label" contenteditable="true">${text}</label>`;
  cont.appendChild(div);
}


async function loadExecutors() {
  const select = document.getElementById('task-executor');
  if (!select) return;
  select.innerHTML = '<option value=""></option>';
  if (!window.supabase || !window.companyId) return;
  const { data } = await window.supabase
    .from('employees')
    .select('id, login')
    .eq('company_id', window.companyId);
  if (Array.isArray(data)) {
    data.forEach(emp => {
      const opt = document.createElement('option');
      opt.value = emp.id;
      opt.textContent = emp.login || emp.id;
      select.appendChild(opt);
    });
  }
}

async function openTaskModal(status, id) {
  const modal = document.getElementById('task-modal');
  const form = document.getElementById('task-form');
  await loadExecutors();
  form.reset();
  form.dataset.status = status || 'created';
  document.getElementById('task-id').value = '';
  clearSubtaskList();
  addSubtaskRow();
  if (id) {
    const task = tasks.find(t => t.id === id);
    if (task) {
      document.getElementById('task-id').value = task.id;
      document.getElementById('task-title').value = task.title;
      document.getElementById('task-description').value = task.description;
      document.getElementById('task-author').value = task.author;
      document.getElementById('task-executor').value = task.executor;
      document.getElementById('task-due').value = task.dueDate || '';
      document.getElementById('task-observer').value = task.observer;
      clearSubtaskList();
      if (Array.isArray(task.subtasks) && task.subtasks.length) {
        task.subtasks.forEach(st => addSubtaskRow(st.text, st.done));
      } else {
        addSubtaskRow();
      }
      form.dataset.status = task.status;
    }
  }
  modal.classList.add('show');
}

function closeTaskModal() { document.getElementById('task-modal').classList.remove('show'); }

  window.openTaskModal = openTaskModal;
window.closeTaskModal = closeTaskModal;

  function openViewModal(id) {
  currentViewId = id;
  const modal = document.getElementById('view-modal');
  const content = modal.querySelector('.view-content');
  const task = tasks.find(t => t.id === id);
  if (!task) return;
  content.innerHTML = renderFull(task);
  modal.classList.add('show');
}

function closeViewModal() {
  const modal = document.getElementById('view-modal');
  modal.classList.remove('show');
  currentViewId = null;
}

document.getElementById('task-form').addEventListener('submit', e => {
  e.preventDefault();
  const id = document.getElementById('task-id').value;
  const status = e.target.dataset.status || 'created';
  const cont = document.getElementById('task-subtasks');
  const subtasks = [];
  cont.querySelectorAll('.checklist-item').forEach(item => {
    const cb = item.querySelector('.checklist-checkbox');
    const label = item.querySelector('.checklist-label');
    const text = label ? label.textContent.trim() : '';
    if (text) subtasks.push({ text, done: cb.checked });
  });

  const data = {
    id: id || Date.now().toString(),
    title: document.getElementById('task-title').value,
    description: document.getElementById('task-description').value,
    author: document.getElementById('task-author').value,
    executor: document.getElementById('task-executor').value,
    dueDate: document.getElementById('task-due').value,
    observer: document.getElementById('task-observer').value,
    subtasks,
    chat: [],
    createdAt: id ? tasks.find(t=>t.id===id).createdAt : Date.now(),
    status: status,
    statusHistory: id ? tasks.find(t=>t.id===id).statusHistory : { [status]: { date: Date.now(), duration: 0 } },
    expanded: false
  };
  const existingIndex = tasks.findIndex(t => t.id === data.id);
  if (existingIndex >= 0) tasks[existingIndex] = data; else tasks.push(data);
  saveTasks();
  closeTaskModal();
  redraw();
});

  document.getElementById('add-subtask-btn').addEventListener('click', () => {
  addSubtaskRow();
});

function renderShort(task) {
  const created = new Date(task.createdAt).toLocaleDateString();
  const subtasks = task.subtasks.map((s,i) =>
    `<div class="checklist-item"><input type="checkbox" class="checklist-checkbox" data-id="${task.id}" data-index="${i}" ${s.done ? 'checked' : ''}><label class="checklist-label">${s.text}</label></div>`
  ).join('');
  const sub = task.subtasks.map(s => `<li>${s}</li>`).join('');
  const due = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '';
  return `<div><strong>${task.title}</strong></div>
          <div class="meta">Author: ${task.author || ''}</div>
          <div class="meta">Executor: ${task.executor || ''}</div>
          <div class="meta">Created: ${created}</div>
          <div class="meta">Due: ${due}</div>
          <div class="checklist-container">${subtasks}</div>`;
}

function renderFull(task) {
  const history = Object.entries(task.statusHistory || {}).map(([st, d]) => `<div>${st}: ${new Date(d.date).toLocaleString()} (${Math.floor(d.duration/1000)}s)</div>`).join('');
  const chat = task.chat.map((c,i) => `<div class="message-box ${i%2?'right':'left'}"><p>${c}</p></div>`).join('');
  const subtasks = task.subtasks.map((s,i) =>
      `<div class="checklist-item"><input type="checkbox" class="checklist-checkbox" data-id="${task.id}" data-index="${i}" ${s.done ? 'checked' : ''}><label class="checklist-label">${s.text}</label></div>`
  ).join('');
  const due = task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '';
  return `<div><strong>${task.title}</strong></div>
          <textarea class="textareaZADACH-content" readonly>${task.description || ''}</textarea>
          <div>Author: ${task.author || ''}</div>
          <div>Executor: ${task.executor || ''}</div>
          <div>Due: ${due}</div>
          <div>Observer: ${task.observer || ''}</div>
          <div class="checklist-container">${subtasks}</div>
          <div class="card-container">
            <div class="card-header"><div class="img-avatar"></div><div class="text-chat">Chat</div></div>
            <div class="card-body">
              <div class="messages-container">${chat}</div>
              <div class="message-input">
                <form class="message-form" data-id="${task.id}">
                  <textarea placeholder="Type your message here" class="message-send"></textarea>
                  <button type="submit" class="button-send">Send</button>
                </form>
              </div>
            </div>
          </div>
          ${history}`;
}

function addTaskToColumn(task) {
  const list = document.querySelector(`.column[data-status="${task.status}"] .task-list`);
  if (!list) return;
  const li = document.createElement('li');
  li.className = 'task';
  li.dataset.id = task.id;
  li.innerHTML = `<div class="short-view">${renderShort(task)}</div><div class="full-view">${renderFull(task)}</div>`;
  li.draggable = true;
  li.addEventListener('click', () => toggleView(task.id));
  li.addEventListener('dragstart', dragStart);
  li.addEventListener('dragend', dragEnd);
  list.appendChild(li);
}

function redraw() {
  document.querySelectorAll('.task-list').forEach(l => l.innerHTML = '');
  tasks.forEach(addTaskToColumn);
}

function toggleView(id) {
  const task = tasks.find(t=>t.id===id);
  if (!task) return;
  task.expanded = !task.expanded;
  saveTasks();
  redraw();
  if (task.expanded) openViewModal(id); else closeViewModal();
}

function dragStart(e) {
  e.dataTransfer.setData('text/plain', e.target.dataset.id);
}
function dragEnd(e) { e.dataTransfer.clearData(); }
function allowDrop(e) { e.preventDefault(); }
function drop(e) {
  e.preventDefault();
  const id = e.dataTransfer.getData('text/plain');
  const task = tasks.find(t=>t.id===id);
  const newStatus = e.currentTarget.closest('.column').dataset.status;
  if (task && task.status !== newStatus) {
    const now = Date.now();
    const prevStatus = task.status;
    if (!task.statusHistory[prevStatus]) task.statusHistory[prevStatus] = {date:now,duration:0};
    task.statusHistory[prevStatus].duration += now - (task.statusHistory[prevStatus].date || now);
    task.status = newStatus;
    task.statusHistory[newStatus] = {date: now, duration: 0};
    saveTasks();
    redraw();
  }
}

window.addEventListener('load', () => {
  loadTasks();
  document.querySelectorAll('.column').forEach(col => {
    col.addEventListener('dragover', allowDrop);
    col.addEventListener('drop', drop);
  });
  document.querySelector('.board').addEventListener('change', e => {
    if (e.target.classList.contains('checklist-checkbox')) {
      const id = e.target.dataset.id;
      const idx = parseInt(e.target.dataset.index, 10);
      const task = tasks.find(t=>t.id===id);
      if (task && task.subtasks[idx]) {
        task.subtasks[idx].done = e.target.checked;
        saveTasks();
      }
    }
  });

  document.querySelector('.board').addEventListener('submit', e => {
    if (e.target.classList.contains('message-form')) {
      e.preventDefault();
      const id = e.target.dataset.id;
      const textEl = e.target.querySelector('.message-send');
      const text = textEl.value.trim();
      if (text) {
        const task = tasks.find(t=>t.id===id);
        if (task) {
          task.chat.push(text);
          task.expanded = true;
          saveTasks();
          redraw();
          openViewModal(id);
        }
      }
      textEl.value = '';
    }
  });

  const viewModal = document.getElementById('view-modal');
  viewModal.addEventListener('click', e => {
    if (e.target === viewModal) {
      const task = tasks.find(t => t.id === currentViewId);
      if (task) task.expanded = false;
      saveTasks();
      redraw();
      closeViewModal();
    }
  });

  viewModal.addEventListener('change', e => {
    if (e.target.classList.contains('checklist-checkbox')) {
      const id = e.target.dataset.id;
      const idx = parseInt(e.target.dataset.index, 10);
      const task = tasks.find(t=>t.id===id);
      if (task && task.subtasks[idx]) {
        task.subtasks[idx].done = e.target.checked;
        saveTasks();
        redraw();
      }
    }
  });

  viewModal.addEventListener('submit', e => {
    if (e.target.classList.contains('message-form')) {
      e.preventDefault();
      const id = e.target.dataset.id;
      const textEl = e.target.querySelector('.message-send');
      const text = textEl.value.trim();
      if (text) {
        const task = tasks.find(t=>t.id===id);
        if (task) {
          task.chat.push(text);
          task.expanded = true;
          saveTasks();
          redraw();
          openViewModal(id);
        }
      }
      textEl.value = '';
    }
  });
});
export function initModal1() {
  console.log('[modal1.html] PAGE 1 активирован');
}
initModal1();
</script>
