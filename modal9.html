<!-- ========= modal9.html (Проект 9) =========   -->
<div id="modal9-container" class="spec-modal">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    /* ---- базовые стили из modal5 ---- */
    .spec-modal {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      position: relative;
      height: 100vh;
      margin: 0;
      box-sizing: border-box;
    }

    .modal9-top-window {
      color: var(--black-color, var(--content-color));
      width: 1930px;
      height: 180px;
      padding: 20px;
      padding-top: 15px;
      padding-bottom: 15px;
      box-sizing: border-box;
    }
    .spec-tabs,
    nav.nav_copy { display:flex; gap:8px; margin-bottom:10px; }
    .spec-tab,
    nav.nav_copy .tab { padding:6px 12px; border:1px solid #ccc; border-radius:4px; cursor:pointer; transition:background-color 0.3s; user-select:none; }
    .spec-page { width:100%; }
    .spec-page:not(.active) { display:none; }
    .spec-history-list {
      width: 100%;
      margin-top: 10px;
      overflow-x: auto;
      overflow-y: hidden;
      height: 100%;
    }
    .spec-history-item { display:flex; justify-content:space-between; padding:4px 8px;}
    .spec-history-item .status { margin-left:8px; color:#6c757d; }
    .spec-history-item .time   { margin-left:8px; color:#b5b5b5; font-size:0.9em; }
    .spec-info-icon { margin-left:8px; cursor:pointer; color:#007bff; }
    .spec-info-icon.disabled { color:#6c757d; pointer-events:none; }
    .spec-done-icon { margin-left:8px; color:#28a745; }
    .spec-row { width:100%; max-width:600px; margin-bottom:10px; }
    .spec-input-group { display:flex; gap:8px; }
    .spec-upload-progress { width:100%; margin-top:6px; }
      .spec-upload-progress.running::-webkit-progress-value { transition: width 0.4s ease; background:#007bff; }
    .spec-upload-progress.done::-webkit-progress-value { background:#28a745; }
    .fade-out { opacity:0; transition: opacity 1s; }
    /* ------- новые стили для полей истории ------- */
    .input-container {
      position: relative;
      width: auto;
    }
    .input-container.overflow::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 20px;
      height: 100%;
      pointer-events: none;
      background: linear-gradient(to left, var(--fon, #f5f5f5), rgba(245,245,245,0));
    }
    .styled_input_bar {
      width: auto;
      padding: 10px;
      font-size: 14px;
      border: 1px solid var(--content-color);
      border-radius: 8px;
      background-color: transparent;
      color: var(--content-color);
      outline: none;
      transition: all 0.3s ease;
      box-sizing: border-box;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .styled_input_bar::placeholder { color: grey; transition: all 0.3s ease; }
    .styled_input_bar:hover { border-color: grey; }
    .styled_input_bar:hover::placeholder { color: transparent; }
    .input-label {
      position: absolute;
      left: 10px;
      top: 10px;
      transform: translateY(-50%);
      font-size: 10px;
      background-color: var(--fon, #f5f5f5);
      color: var(--content-color);
      pointer-events: none;
      transition: all 0.3s ease;
    }
    .styled_input_bar:hover + .input-label,
    .styled_input_bar:not(:placeholder-shown) + .input-label {
      top: -2px;
      left: 10px;
      font-size: 13px;
      color: var(--content-color);
      background-color: var(--fon, #f5f5f5);
      padding: 0 8px;
    }
    .styled_input_bar:not(:hover):not(:placeholder-shown) + .input-label { color: grey; }
    .spec-history-item.input-row {
      gap: 10px;
      flex-wrap: nowrap;
      width: max-content;
    }
    .copy-tooltip {
      position: fixed;
      background: #333;
      color: #f5f5f5;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      z-index: 1000;
    }
    .spec-context-menu {
      position: absolute;
      display: none;
      min-width: 220px;
      background: #f5f5f5;
      color: var(--black-color, #1f1f1f);
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
      padding: 6px 0;
      z-index: 4000;
    }
    .spec-context-menu.visible {
      display: block;
    }
    .spec-context-menu button {
      width: 100%;
      padding: 8px 16px;
      border: none;
      background: none;
      font-size: 14px;
      text-align: left;
      color: inherit;
      cursor: pointer;
    }
    .spec-context-menu button:hover,
    .spec-context-menu button:focus {
      background: rgba(0, 0, 0, 0.05);
      outline: none;
    }
    .tooltip-overlay { position:fixed; inset:0; background:var(--content-color); opacity:1; display:flex; align-items:center; justify-content:center; z-index:10000; }
    .tooltip-modal { position:relative; background:#f5f5f5; border:1px solid rgba(0,0,0,0.10); border-radius:10px; padding:10px; width:1320px; max-width:90vw; max-height:90vh; overflow-y:auto; margin:30px; display:inline-block; }
    .tooltip-modal::-webkit-scrollbar { width:6px; }
    .tooltip-modal::-webkit-scrollbar-track { background:#e0e0e0; }
    .tooltip-modal::-webkit-scrollbar-thumb { background:var(--content-color); border-radius:10px; }
    .ans5-close { position:absolute; top:4px; right:8px; font-size:24px; background:none; border:none; cursor:pointer; }

    .modalRow { display:flex; gap:10px; margin-top:10px; }
    .modalColumn { display:flex; flex-direction:column; gap:10px; }
    .modalCollumn { display:flex; flex-direction:column; gap:10px; }
    .registry-checkboxes { display:flex; flex-direction:column; margin-top:10px; }
    .registry-checkboxes .checkbox-item { display:flex; align-items:center; gap:6px; }
    .modalCONTEINERpost {
      display: flex;
      border-radius: 6px;
      background: transparent;
      border: 1px solid #f5f5f5;
    }
    .iconTYPE1 { font-size:18px; cursor:pointer; color:#007bff; }
    .card-container {
      background-color: #f5f5f5;
      border-radius: 10px;
      padding: 0;
      margin: 10px;
      display: flex;
      flex-direction: column;
      width: auto;
      height: auto;
    }
    .card-body {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }
    .messages_container-content {
      margin: 0;
      padding: 1px;
      color: var(--black-color);
      font-size: 12px;
      box-sizing: border-box;
      overflow-y: auto;
      width: 100%;
      border: none;
    }
    .messages_container-content::-webkit-scrollbar {
      width: 2.5px;
      background-color: var(--scrollbar-color);
      height: 90%;
    }
    .messages_container-content::-webkit-scrollbar-thumb {
      background-color: var(--black-color);
      border-radius: 30px;
    }
    .messages_container-content::-webkit-scrollbar-track {
      background-color: var(--scrollbar-color);
    }
    .status-display {
      width: auto;
      padding: 10px;
      font-size: 14px;
      border: 1px solid var(--content-color);
      border-radius: 8px;
      background-color: transparent;
      color: var(--content-color);
      box-sizing: border-box;
      text-align: left;
      transition: opacity 1s, filter 1s;
      text-transform: uppercase;
      text-align: center;
    }
   .status-display.error {
      border-color: red;
    }
    .status-display.fade {
      opacity: 0;
      filter: blur(2px);
    }
    .fade-toggle {
      transition: opacity 0.5s, filter 0.5s;
    }
    .fade-toggle.hidden {
      opacity: 0;
      filter: blur(2px);
      pointer-events: none;
    }
    .status-display + .input-label {
      top: -2px;
      left: 10px;
      font-size: 13px;
      color: grey;
      background-color: #f5f5f5;
      padding: 0 8px;
    }
    .input-container:hover .status-display + .input-label {
      color: var(--content-color);
    }
     .fade-in {
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* ---- окно модалки ---- */
    .modal9-scroll-wrapper {
      width:1950px;
      max-width:90vw;
      flex:1;
      padding-bottom:20px;
      overflow-x: visible;
    }

    .modal9-window {
      color:var(--black-color, var(--content-color));
      width: 1930px;
      padding-left:20px;
      padding-top:20px;
      padding-bottom:20px;      
      padding-right:10px;
      
      margin-right:0;
      box-sizing:border-box;
      margin-bottom:0;
      max-height:calc(100vh - 220px);
      position:fixed;
      top:200px;
      bottom:0px;
      left:50%;
      transform:translateX(-50%);
      overflow-x: visible;
    }

    .modal9-content {
      /* width:100%; */
      width: 1930px;
      height:100%;
      box-sizing:border-box;
      overflow-y:auto;
      padding-right:10px;
      margin-right:-10px;
     /* padding-bottom:10px; */
      /* margin-bottom:-10px; */
    }
    .modal9-content::-webkit-scrollbar{width:6px;}
    .modal9-content::-webkit-scrollbar-track{background:transparent;}
    .modal9-content::-webkit-scrollbar-thumb{background:var(--content-color);border-radius:10px;}

      /* ---- навигация nav_copy ---- */
    nav.nav_copy { position:relative; background:#333; border-radius:6px; overflow:hidden; width: 400px; }
    nav.nav_copy .slider { position:absolute; top:0; left:0; width:49%; height:100%; background:#f5f5f5; border-radius:6px; transition:left 0.3s; }
    nav.nav_copy .tab { flex:1; text-align:center; color:#f5f5f5; z-index:1; }
    nav.nav_copy .tab.active { color:var(--content-color); }

       /* ---- загрузка файлов ---- */
    .file-upload__modal { display:flex; align-items:flex-start; }
    .file-upload-form { width:fit-content; height:fit-content; display:flex; align-items:center; justify-content:center; }
    .file-upload-label input { display:none; }
    .file-upload-label { cursor:pointer; background-color:#ddd; padding:10px 20px; border-radius:8px; border:1px dashed rgb(82,82,82); }
    .file-upload-design { display:flex; flex-direction:column; align-items:center; justify-content:space-between; height:100%; }
    .file-upload-design .darkmatter-btn { width:100%; }
    .browse-button { width:100%; }
    .drag-text { margin:0; }
    .upload-status-wrapper { display:flex; flex-direction:column; align-items:flex-start; margin-left:10px; }
    .js-dropzone.drag { background: rgba(255,255,255,0.1); }

    .darkmatter-btn {
      background:var(--content-color);
      border:1px solid #333;
      color: #ddd;
      padding:5px 5px;
      width: 245px;
      border-radius:8px;
      font-size:16px;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      transition:all 0.3s ease;
      z-index:1;
    }
    .darkmatter-btn:hover { color:#fff; }
    .darkmatter-btn:active { transform:scale(0.95); }
    .darkmatter-btn::before {
      content:"";
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      background:radial-gradient(circle at center, rgba(181,106,255,0.1) 0%, transparent 70%);
      transform:scale(0);
      transition:transform 0.6s ease;
      z-index:-1;
    }
    .darkmatter-btn:hover::before { transform:scale(1.5); }
    .darkmatter-particle {
      position:absolute;
      width:3px; height:3px;
      border-radius:50%;
      background:#b56aff;
      opacity:0; z-index:-1;
    }
    .darkmatter-btn:hover .darkmatter-particle { animation:darkmatter-float 2s forwards; }
    @keyframes darkmatter-float {
      0% { transform:translate(0,0) scale(0); opacity:0; }
      20% { opacity:0.8; }
      100% { transform:translate(var(--tx), var(--ty)) scale(1); opacity:0; }
    }
    .darkmatter-btn .loader { display:none; position:absolute; inset:0; margin:auto; width:16px; height:16px; border:2px solid #b56aff; border-top-color:transparent; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { from{transform:rotate(0);} to{transform:rotate(360deg);} }
    .darkmatter-btn.loading .loader { display:block; }
    .darkmatter-btn.loading .button-text { visibility:hidden; }

     /* --- переключатель истории --- */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: #fff;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .toggle-slider {
      background-color: var(--content-color);
    }
    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

     /* --- блок результатов --- */
    .block1-wrapper{
      height:100%;
      overflow-y:auto;
      overflow-x:hidden;
    }
    .block1-wrapper::-webkit-scrollbar{ width:2.5px; background-color:var(--scrollbar-color); height:90%; }
    .block1-wrapper::-webkit-scrollbar-thumb{ background-color:var(--black-color); border-radius:30px; }
    .block1-wrapper::-webkit-scrollbar-track{ background-color:var(--scrollbar-color);}
    .spec-container { margin-bottom:10px; margin-right:50px; padding-top:10px;}
    .spec-progress.multistep {
      display:flex;
      gap:10px;
      margin:0 10px;
      width:calc(100% - 20px);
    }
    .spec-progress.multistep .step {
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
    }
    .spec-progress.multistep .step-body {
      display:flex;
      gap:8px;
      margin-left:20px;
    }
    .spec-progress.multistep .step-body .darkmatter-btn {
      height:auto;
      padding:0 5px;
      width:245px;
    }
    .spec-progress.multistep .step-body .darkmatter-btn:disabled,
    .spec-progress.multistep .step-body .darkmatter-btn.disabled {
      opacity:0.5;
      cursor:default;
      pointer-events:none;
    }
    .spec-progress.multistep .bar {
      width:100%;
      height:6px;
      background:#000;
      opacity:0.25;
      border-radius:2px;
      transition:opacity 0.3s, box-shadow 0.3s;
    }
    .spec-progress.multistep .step.active .bar {
      opacity:1;
      box-shadow:0 0 4px var(--content-color);
    }
    .spec-progress.multistep .label {
      font-size:12px;
      text-align:center;
    }
    .spec-progress.multistep .icons {
      display:flex;
      gap:4px;
      align-items:center;
    }
    .spec-progress.multistep .icons .material-symbols-outlined {
      font-size:18px;
      color:var(--content-color);
    }
    .spec-header { background:transparent; cursor:pointer; font-weight:700; }
    .spec-content { }
    .group-close { float:right; background:none; border:none; cursor:pointer; }

    .dynamic-modals {
      display:flex;
      gap:10px;
      align-items:flex-start;
      width:max-content;
      user-select:none;
      margin-left:0px;
      margin-top:0px;
    }
    .modal-block {
      position:relative;
      width:50px;
      min-height:100%;
      max-height:max-content;
      border:1px solid var(--content-color);
      border-radius:6px;
      background: var(--fon);
      overflow:hidden;
      transition:width 0.3s;
      box-sizing:border-box;
    }
    .modal-title {
      position:absolute;
      top:8px;
      left:50%;
      transform:translateX(-50%) rotate(180deg);
      writing-mode:vertical-rl;
      text-orientation:mixed;
      font:600 14px/1 Arial, sans-serif;
      color:#333;
      pointer-events:none;
      transition:0.3s;
    }
    .modal-content {
      opacity:0;
      padding:0;
      transition:0.5s;
      box-sizing:border-box;
    }
    .modal-block.open {
      width:max-content;
      border:none;
    }
    .modal-block.open .modal-content { opacity:1; }
    .modal-block.open .modal-title { opacity:0.15; }
    .dynamic-modals .modal-block { width:50px; }
    .dynamic-modals .modal-block.open { width:max-content; border:none; }
    /* раскрытие блоков только по двойному клику, убираем ховер-эффекты */
    /*
    .dynamic-modals:hover .modal-block { width:50px; }
    .dynamic-modals:hover .modal-block:hover {
      width:100%;
      border:none;
    }
    .dynamic-modals:hover .modal-block:hover .modal-content { opacity:1; }
    .dynamic-modals:hover .modal-block:hover .modal-title { opacity:0.15; }
    */

    #modal9-container .glass3d {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--content-color);
      backdrop-filter: blur(3px); 
      -webkit-backdrop-filter: blur(3px); 
      box-shadow:  
    0 0 0.75px hsl(205 20% 10% / 0.2), 
    0.7px 0.8px 1.2px -0.4px hsl(205 20% 10% / 0.1), 
    1.3px 1.5px 2.2px -0.8px hsl(205 20% 10% / 0.1), 
    2.3px 2.6px 3.9px -1.2px hsl(205 20% 10% / 0.1), 
    3.9px 4.4px 6.6px -1.7px hsl(205 20% 10% / 0.1), 
    6.5px 7.2px 10.9px -2.1px hsl(205 20% 10% / 0.1), 
    8px 9px 14px -2.5px hsl(205 20% 10% / 0.2);
    }
    
  </style>
  <div class="spec-context-menu" aria-hidden="true">
    <button type="button" data-action="copy">Скопировать спецификацию</button>
    <button type="button" data-action="excel">Скачать спецификацию Excel</button>
  </div>
  <div class="modal9-top-window glass3d">
   <div class="file-upload__modal">
     <form class="file-upload-form js-dropzone">
       <label class="file-upload-label">
         <div class="file-upload-design" style="width: 200px; height: 74px;">
           <button type="button" class="darkmatter-btn browse-button">выбрать файл</button>
           <button type="button" class="darkmatter-btn upload-btn">
             <span class="button-text">загрузить</span>
             <span class="loader"></span>
             <div class="darkmatter-particle" style="--tx: -20px; --ty: -15px; left: 25%; top: 25%;"></div>
             <div class="darkmatter-particle" style="--tx: 15px; --ty: -20px; left: 75%; top: 25%; animation-delay: 0.2s;"></div>
             <div class="darkmatter-particle" style="--tx: -15px; --ty: 15px; left: 25%; top: 75%; animation-delay: 0.4s;"></div>
             <div class="darkmatter-particle" style="--tx: 20px; --ty: 15px; left: 75%; top: 75%; animation-delay: 0.6s;"></div>
           </button>
         </div>
         <input type="file" class="js-file__input" />
       </label>
     </form>
     <div class="upload-status-wrapper">
       <progress class="upload-progress spec-upload-progress" value="0" max="100" style="width:100%;display:none;"></progress>
       <div class="upload-status"></div>
     </div>
   </div>
   <div class="button-group" style="margin-top: 15px; display:flex; align-items:center; gap:10px;">
     <div class="file-filter-container input-container" style="position: relative; margin-top: 0px; width: 300px;">
       <input id="file-filter-input" class="styled_input_bar" style="width: 100%;" />
       <label class="input-label">поиск совпадений</label>
       <button class="group-close ans5-close file-filter-clear" style="display:none;">×</button>
     </div>
     <label class="switch">
       <input type="checkbox" id="my-files-toggle">
       <span class="toggle-slider"></span>
     </label>
     <span class="toggle-text">демонстрация файлов компании</span>
   </div>
   <ul class="file-upload__list"></ul>
 </div>
 <div class="modal9-scroll-wrapper">
 <div class="modal9-window glass3d">
   <div class="modal9-content">
    <div class="page spec-page active" data-page="1">
      <div class="history-list spec-history-list"></div>
      
      <template id="history-row-template">
        <div class="history-item spec-history-item input-row" style="display: flex; flex-direction: row; padding-top: 5px;">
          <div class="input-container" style="margin-left: -6px;">
            <input type="text" class="styled_input_bar" data-field="file_number" readonly style="width: 100px;" placeholder="AK-000001">
            <label class="input-label">номер</label>
          </div>
          <div class="input-container">
            <input type="text" class="styled_input_bar" data-field="user_login" readonly style="width: 400px;" placeholder="rosatomicalchemist@gmail.com">
            <label class="input-label">login</label>
          </div>
          <div class="input-container">
            <input type="text" class="styled_input_bar" data-field="created_at" readonly style="width: 210px;" placeholder="15.07.2025, 14:23:47">
            <label class="input-label">дата</label>
          </div>
          <div class="input-container">
            <input type="text" class="styled_input_bar" data-field="file_name" readonly style="width: 710px;" placeholder="Техническое задание на поставку оборудования.docx">
            <label class="input-label">файл</label>
          </div>
          <div class="input-container">
            <input type="text" class="styled_input_bar" data-field="file_ext" style="width: 90px; text-transform: uppercase; text-align: center;" readonly placeholder="docx">
            <label class="input-label">ext</label>
          </div>
          <div class="input-container">
            <div class="status-display" data-field="status" style="width: 190px; text-transform: uppercase; text-align: center;">загружено</div>
            <label class="input-label">статус</label>
          </div>
          <div class="input-container">
            <input type="text" class="styled_input_bar" data-field="id" style="width: 80px; text-transform: uppercase; text-align: center;" readonly placeholder="1">
            <label class="input-label">spec #</label>
          </div>
        </div>
      </template>
      
    </div>

    <div class="page spec-page" data-page="2">
      <div class="block1-wrapper"></div>

      <template id="spec-template">
        <div class="spec-container">
          <div class="spec-header">
            <div class="spec-title"></div>
            <button class="group-close ans5-close" style="display:none;">×</button>
          </div>
          <div class="spec-content"></div>
        </div>
      </template>

<template id="spec-progress-template">
  <div class="spec-progress multistep" style="margin-bottom: 16px;">
    <!-- BLOCK 1 -->
    <div class="step" data-step="1">
      <div class="bar"></div>
      <div class="step-body" style="margin-top: 16px;">
        <div class="label" style="font-size: 14px;">BLOCK 1</div>
        <div class="icons">
          <span class="material-symbols-outlined status" style="font-size: 14px;">indeterminate_check_box</span>
        </div>
        <button class="darkmatter-btn refresh" title="Перезапустить парсер" style="border-radius: 4px;">
          <span class="button-text">запуск шага</span>
          <span class="loader"></span>
        </button>
      </div>
    </div>

    <!-- BLOCK 2 / 2.1 -->
    <div class="step" data-step="2">
      <div class="bar"></div>
      <div class="step-body" style="margin-top: 16px;">
        <div class="label" style="font-size: 14px;">BLOCK 2 / 2.1</div>
        <div class="icons">
          <span class="material-symbols-outlined status" style="font-size: 14px;">indeterminate_check_box</span>
        </div>
        <button class="darkmatter-btn refresh" title="Перезапустить селектор" style="border-radius: 4px;">
          <span class="button-text">запуск шага</span>
          <span class="loader"></span>
        </button>
      </div>
    </div>

    <!-- BLOCK 3 / 3.1 (пока без действий) -->
    <div class="step" data-step="3">
      <div class="bar"></div>
      <div class="step-body" style="margin-top: 16px;">
        <div class="label" style="font-size: 14px;">BLOCK 3 / 3.1</div>
        <div class="icons">
          <span class="material-symbols-outlined status" style="font-size: 14px;">indeterminate_check_box</span>
        </div>
        <button class="darkmatter-btn refresh" title="Недоступно" style="border-radius: 4px;" disabled>
          <span class="button-text">запуск шага</span>
          <span class="loader"></span>
        </button>
      </div>
    </div>
  </div>
</template>

      
      <template id="spec-row-template">
        <div class="modalCONTEINERpost modalRow">
          <div class="modalColumn">
            <div class="modalRow">
              <div class="input-container" style="margin-top: 10px;">
                <input type="text" style="width: 100px; text-align: center;" class="styled_input_bar" data-field="pos_number" readonly>
                <label class="input-label">№ в ТЗ</label>
              </div>
              <div class="input-container" style="margin-top: 10px;">
                <input type="text" style="width: 400px; text-align: left;" class="styled_input_bar" data-field="name" readonly>
                <label class="input-label">наименование</label>
              </div>
              <div class="input-container" style="margin-top: 10px;">
                <input type="text" style="width: 100px; text-align: center;" class="styled_input_bar" data-field="qty" readonly>
                <label class="input-label">кол-во</label>
              </div>
              <div class="input-container" style="margin-top: 10px;">
                <input type="text" style="width: 100px; text-align: center;" class="styled_input_bar" data-field="unit" readonly>
                <label class="input-label">ед. изм.</label>
              </div>
            </div>
            <div class="registry-checkboxes">
              <label class="checkbox-item"><input type="checkbox" data-field="rpp_878"> присутствие в реестре РПП 878</label>
              <label class="checkbox-item"><input type="checkbox" data-field="torp"> присутствие в реестре ТОРП</label>
              <label class="checkbox-item"><input type="checkbox" data-field="rrpo_1875"> присутствие в реестре РРПО 1875</label>
            </div>
          </div>
          <div class="dynamic-modals">
            <div class="modal-block block1">
              <div class="modal-title">1 BLOCK</div>
              <div class="modal-content"></div>
            </div>
            <div class="modal-block block2">
              <div class="modal-title">2 BLOCK</div>
              <div class="modal-content"></div>
            </div>
            <div class="modal-block block21">
              <div class="modal-title">2/1 BLOCK</div>
              <div class="modal-content"></div>
            </div>
            <div class="modal-block block3">
              <div class="modal-title">3 BLOCK</div>
              <div class="modal-content"></div>
            </div>
            <div class="modal-block block31">
              <div class="modal-title">3/1 BLOCK</div>
              <div class="modal-content"></div>
            </div>
          </div>
        </div>
      </template>
      
      <template id="spec-block2-template">
        <div class="modalRow">
          <div class="input-container">
            <input type="text" style="width: 140px;" class="styled_input_bar param-input" placeholder="артикул" readonly>
            <label class="input-label">артикул</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 300px;" class="styled_input_bar value-input" placeholder="наименование" readonly>
            <label class="input-label">наименование</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 80px; text-align: center;" class="styled_input_bar value-input" placeholder="кол-во" readonly>
            <label class="input-label">кол-во</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 80px; text-align: center;" class="styled_input_bar value-input" placeholder="ед. изм." readonly>
            <label class="input-label">ед. изм.</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 110px; text-align: center;" class="styled_input_bar value-input" placeholder="000 000 000" readonly>
            <label class="input-label">цена</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 110px; text-align: center;" class="styled_input_bar value-input" placeholder="000 000 000" readonly>
            <label class="input-label">сумма</label>
          </div>
         </div>
      </template>
      
      <!-- //фронтенд: шаблон BLOCK 2/1 под 3 оффера -->
<template id="spec-block21-template">
  <div class="modalRow">
    <!-- offer #1 -->
    <div class="input-container">
      <input type="text" style="width: 110px; text-align:center;" class="styled_input_bar" data-offer="1-price" placeholder="0 ₽" readonly>
      <label class="input-label">цена 1</label>
    </div>
    <div class="input-container">
      <input type="text" style="width: 90px;" class="styled_input_bar" data-offer="1-store" placeholder="магазин" readonly>
      <label class="input-label">магазин</label>
    </div>
    <a class="icons" data-offer="1-url" target="_blank" rel="noopener">
      <span class="material-symbols-outlined status">link</span>
    </a>

    <!-- offer #2 -->
    <div class="input-container">
      <input type="text" style="width: 110px; text-align:center;" class="styled_input_bar" data-offer="2-price" placeholder="0 ₽" readonly>
      <label class="input-label">цена 2</label>
    </div>
    <div class="input-container">
      <input type="text" style="width: 90px;" class="styled_input_bar" data-offer="2-store" placeholder="магазин" readonly>
      <label class="input-label">магазин</label>
    </div>
    <a class="icons" data-offer="2-url" target="_blank" rel="noopener">
      <span class="material-symbols-outlined status">link</span>
    </a>

    <!-- offer #3 -->
    <div class="input-container">
      <input type="text" style="width: 110px; text-align:center;" class="styled_input_bar" data-offer="3-price" placeholder="0 ₽" readonly>
      <label class="input-label">цена 3</label>
    </div>
    <div class="input-container">
      <input type="text" style="width: 90px;" class="styled_input_bar" data-offer="3-store" placeholder="магазин" readonly>
      <label class="input-label">магазин</label>
    </div>
    <a class="icons" data-offer="3-url" target="_blank" rel="noopener">
      <span class="material-symbols-outlined status">link</span>
    </a>
  </div>
</template>


      <template id="spec-block3-template">
        <div class="modalRow">
          <div class="input-container">
            <input type="text" style="width: 140px;" class="styled_input_bar param-input" placeholder="артикул" readonly>
            <label class="input-label">артикул</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 300px;" class="styled_input_bar value-input" placeholder="наименование" readonly>
            <label class="input-label">наименование</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 80px; text-align: center;" class="styled_input_bar value-input" placeholder="кол-во" readonly>
            <label class="input-label">кол-во</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 80px; text-align: center;" class="styled_input_bar value-input" placeholder="ед. изм." readonly>
            <label class="input-label">ед. изм.</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 110px; text-align: center;" class="styled_input_bar value-input" placeholder="000 000 000" readonly>
            <label class="input-label">цена</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 110px; text-align: center;" class="styled_input_bar value-input" placeholder="000 000 000" readonly>
            <label class="input-label">сумма</label>
          </div>
         </div>
      </template>
      
      <template id="spec-block31-template">
        <div class="modalRow">
          <div class="input-container">
            <input type="text" style="width: 146px;" class="styled_input_bar param-input" placeholder="артикул" readonly>
            <label class="input-label">артикул</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 90px;" class="styled_input_bar param-input" placeholder="артикул" readonly>
            <label class="input-label">магазин</label>
          </div>
          <div class="icons">
              <span class="material-symbols-outlined status">link</span>
          </div>
          <div class="input-container">
            <input type="text" style="width: 146px;" class="styled_input_bar param-input" placeholder="артикул" readonly>
            <label class="input-label">артикул</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 90px;" class="styled_input_bar param-input" placeholder="артикул" readonly>
            <label class="input-label">магазин</label>
          </div>
          <div class="icons">
              <span class="material-symbols-outlined status">link</span>
          </div>
          <div class="input-container">
            <input type="text" style="width: 146px;" class="styled_input_bar param-input" placeholder="артикул" readonly>
            <label class="input-label">артикул</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 90px;" class="styled_input_bar param-input" placeholder="артикул" readonly>
            <label class="input-label">магазин</label>
          </div>
          <div class="icons">
              <span class="material-symbols-outlined status">link</span>
          </div>
       </div>
      </template>
      
      <template id="spec-attr-template">
        <div class="modalRow">
          <div class="input-container">
            <input type="text" style="width: 580px;" class="styled_input_bar param-input" placeholder="параметр" readonly>
            <label class="input-label">параметр</label>
          </div>
          <div class="input-container">
            <input type="text" style="width: 280px;" class="styled_input_bar value-input" placeholder="значение" readonly>
            <label class="input-label">значение</label>
          </div>
        </div>
      </template>

      
    </div>
  </div>
</div>
</div>
</div>

<script type="module">
export async function initModal9() {
  console.log('[modal9.html] PAGE 9 активирован');
  
  const supabase = window.supabase;
  const BUCKET = 'modal9-page1-uploads';
  const TABLE = 'modal9_page1_uploads_registry';
  const POS_TABLE = 'modal9_page1_positions';
  const SELECT_TABLE = 'modal9_page1_positions_select';
  // URLs функций не используются напрямую; оставлены для совместимости
  const STATUS_TABLE = 'modal9_selector_status';
  const PARSER_URL = 'https://jviswahajwmwibedxcll.supabase.co/functions/v1/modal9-parser';
  const SELECTOR_URL = 'https://jviswahajwmwibedxcll.supabase.co/functions/v1/modal9-selector';
  const ALLOWED_EXTS = ['doc', 'docx', 'txt', 'xls', 'rtf', 'pdf', 'ods', 'csv', 'xlsx'];

  const root = document.getElementById('modal9-container');
  const tabs = root.querySelectorAll('.tab');
  const navSlider = root.querySelector('nav.nav_copy .slider');
  const pages = root.querySelectorAll('.page');
  const historyList = root.querySelector('.history-list');
  const dropzone = root.querySelector('.js-dropzone');
  const rowTemplate = root.querySelector('#history-row-template');
  const fileInput = root.querySelector('.js-file__input');
  const fileList = root.querySelector('.file-upload__list');
  const uploadBtn = root.querySelector('.upload-btn');
  const browseBtn = root.querySelector('.browse-button');
  const uploadProgress = root.querySelector('.upload-progress');
  const uploadStatus = root.querySelector('.upload-status');
  const myFilesToggle = root.querySelector('#my-files-toggle');
  const toggleText = root.querySelector('.toggle-text');
  const filterInput = root.querySelector('#file-filter-input');
  const filterClear = root.querySelector('.file-filter-clear');
  const block1List = root.querySelector('.block1-wrapper');
  const specTemplate = root.querySelector('#spec-template');
  const specProgressTemplate = root.querySelector('#spec-progress-template');
  const specRowTemplate = root.querySelector('#spec-row-template');
  const block2Template = root.querySelector('#spec-block2-template');
  const block21Template = root.querySelector('#spec-block21-template');
  const block3Template = root.querySelector('#spec-block3-template');
  const block31Template = root.querySelector('#spec-block31-template');
  const attrPairTemplate = root.querySelector('#spec-attr-template');
  const contextMenu = root.querySelector('.spec-context-menu');
  const BLOCK2_COLUMNS = ['артикул', 'наименование', 'кол-во', 'ед. изм.', 'цена', 'сумма'];
  const BLOCK3_COLUMNS = ['артикул', 'наименование', 'кол-во', 'ед. изм.', 'цена', 'сумма'];
  let realtimeSub = null;
  const block1OpenBlocks = {};
  const historyOpenBlocks = {};
  const hideTimers = new WeakMap();
  let openedSpecId = null;
  let contextSpecContent = null;

  let block1ReloadTimer = null;
  function scheduleLoadBlock1() {
    if (block1ReloadTimer) return;
    block1ReloadTimer = setTimeout(async () => {
      block1ReloadTimer = null;
      await loadBlock1();
    }, 500);
  }

  const DELIM = window.__DELIM || "###";

  const formatOfferPrice = (amount, currency) => {
    if (amount === null || amount === undefined || amount === '') return '';
    const prepared = typeof amount === 'number'
      ? amount
      : Number(String(amount).replace(/\s+/g, '').replace(',', '.'));
    const priceText = Number.isFinite(prepared)
      ? prepared.toLocaleString('ru-RU')
      : String(amount);
    const curr = (currency || 'RUB').toUpperCase();
    return curr ? `${priceText} ${curr}` : priceText;
  };

  function appendBlock21Content(target, selections = []) {
    if (!target || !block21Template) return;
    const frag = block21Template.content.cloneNode(true);
    const record = Array.isArray(selections) && selections.length ? selections[0] : {};
    const setOffer = (n, amount, curr, store, url) => {
      const priceEl = frag.querySelector(`[data-offer="${n}-price"]`);
      const storeEl = frag.querySelector(`[data-offer="${n}-store"]`);
      const urlEl = frag.querySelector(`[data-offer="${n}-url"]`);
      if (priceEl) priceEl.value = formatOfferPrice(amount, curr);
      if (storeEl) storeEl.value = store || '';
      if (urlEl) {
        const href = url || '';
        if (href) {
          urlEl.setAttribute('href', href);
          urlEl.removeAttribute('aria-disabled');
          urlEl.removeAttribute('tabindex');
          urlEl.classList.remove('disabled');
          urlEl.style.pointerEvents = '';
          urlEl.style.opacity = '';
        } else {
          urlEl.setAttribute('href', '#');
          urlEl.setAttribute('aria-disabled', 'true');
          urlEl.setAttribute('tabindex', '-1');
          urlEl.classList.add('disabled');
          urlEl.style.pointerEvents = 'none';
          urlEl.style.opacity = '0.5';
        }
      }
    };

    setOffer(1, record.price1_amount, record.price1_currency, record.price1_store, record.price1_url);
    setOffer(2, record.price2_amount, record.price2_currency, record.price2_store, record.price2_url);
    setOffer(3, record.price3_amount, record.price3_currency, record.price3_store, record.price3_url);

    target.appendChild(frag);
  }

  let selectedFile = null;
  filterInput.addEventListener('input', () => {
    applySecondFilter();
    filterClear.style.display = filterInput.value ? 'block' : 'none';
  });

  filterClear.addEventListener('click', () => {
    filterInput.value = '';
    filterClear.style.display = 'none';
    applySecondFilter();
  });
  myFilesToggle.addEventListener('change', async () => {
    toggleText.textContent = myFilesToggle.checked ? 'демонстрация только моих файлов' : 'демонстрация файлов компании';
    await loadHistory();
  });
  fileInput.addEventListener('change', () => {
    selectedFile = fileInput.files[0] || null;
    renderFileList();
  });

  browseBtn.addEventListener('click', () => fileInput.click());

  dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('drag');
  });
  dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag'));
  dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('drag');
    selectedFile = e.dataTransfer.files[0];
    renderFileList();
  });

  function renderFileList() {
    fileList.innerHTML = '';
    uploadStatus.textContent = selectedFile ? `Выбран: ${selectedFile.name}` : '';
    if (selectedFile) {
      const li = document.createElement('li');
      li.textContent = selectedFile.name;
      fileList.appendChild(li);
    }
  }

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      if (tab.classList.contains('active')) return;
      tabs.forEach(t => t.classList.remove('active'));
      pages.forEach(p => p.classList.remove('active'));
      tab.classList.add('active');
      root.querySelector(`.page[data-page="${tab.dataset.page}"]`).classList.add('active');
      if (navSlider) navSlider.style.left = tab.dataset.page === '1' ? '0%' : '50%';
      if (tab.dataset.page === '2') loadBlock1();
    });
  });

  const sanitize = (s) => s
    .normalize('NFKD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/[^a-z0-9._-]/gi, '_');

  function showCopyTip(el) {
    const tip = document.createElement('div');
    tip.className = 'copy-tooltip';
    tip.textContent = 'скопировано';
    document.body.appendChild(tip);
    const r = el.getBoundingClientRect();
    tip.style.left = r.left + r.width / 2 - tip.offsetWidth / 2 + 'px';
    tip.style.top = r.top - tip.offsetHeight - 6 + 'px';
    setTimeout(() => tip.remove(), 1000);
  }

  function updateStatus(el, status) {
    if (!el) return;
    const s = String(status || '');
    const match = s.match(/^BLOCK\s*2\s*\(\s*(\d+)\s*\/\s*(\d+)\s*\/\s*(\d+)\s*\)$/i);
    const display = match ? `${match[1]} / ${match[2]} / ${match[3]}` : s;
    el.textContent = display;
    if (display.trim().endsWith('!!!')) {
      el.classList.add('error');
    } else {
      el.classList.remove('error');
    }
}

  function animateStatus(el, newStatus) {
    if (!el) return;
    el.classList.add('fade');
    setTimeout(() => {
      updateStatus(el, newStatus);
      el.classList.remove('fade');
    }, 1000);
  }

  function startBtnLoad() {
    uploadBtn.classList.add('loading');
    uploadBtn.disabled = true;
  }

  function stopBtnLoad() {
    uploadBtn.classList.remove('loading');
    uploadBtn.disabled = false;
  }

  uploadBtn.addEventListener('click', async () => {
   if (!selectedFile || uploadBtn.classList.contains('loading')) return;
    startBtnLoad();

    const { data: { session } } = await supabase.auth.getSession();
    if (!session) { uploadStatus.textContent = 'Необходим вход'; stopBtnLoad(); return; }

    const ext = selectedFile.name.split('.').pop().toLowerCase();

    if (!ALLOWED_EXTS.includes(ext)) {
      uploadStatus.textContent = 'Недопустимый тип файла';
      stopBtnLoad();
      return;
    }

    const safeName = sanitize(selectedFile.name);
    const safeFolder = sanitize(session.user.id);
    const filePath = `${safeFolder}/${Date.now()}_${safeName}`;

    uploadProgress.style.display = 'block';
    uploadProgress.value = 0;
    uploadProgress.classList.remove('done', 'fade-out');
    uploadProgress.classList.add('running');
    uploadStatus.textContent = '0%';

    const xhr = new XMLHttpRequest();
    xhr.open('POST', `${window.SUPABASE_URL}/storage/v1/object/${BUCKET}/${filePath}`);
    xhr.setRequestHeader('Authorization', `Bearer ${session.access_token}`);
    xhr.setRequestHeader('apikey', window.SUPABASE_ANON_KEY);
    xhr.setRequestHeader('x-upsert', 'true');
    xhr.upload.onprogress = e => {
      if (e.lengthComputable) {
        const percent = Math.round((e.loaded / e.total) * 100);
        uploadProgress.value = percent;
        uploadStatus.textContent = percent + '%';
      }
    };
    const uploadPromise = new Promise((resolve, reject) => {
      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) resolve();
        else reject(new Error(xhr.statusText));
      };
      xhr.onerror = () => reject(new Error('Network error'));
    });
    xhr.send(selectedFile);

    try {
      await uploadPromise;
    } catch (e) {
      uploadStatus.textContent = 'Ошибка upload: ' + e.message;
      stopBtnLoad();
      return;
    }
    uploadProgress.value = 100;

    const { data: insertedRow, error: regErr } = await supabase
        .from(TABLE)
        .insert({
            user_login: window.USER_LOGIN || '',
            file_path: filePath,
            file_name: selectedFile.name,
            file_ext: ext,
             status: 'загружено'
        })
        .select('*')
        .single();

    if (regErr) {
        uploadStatus.textContent = 'Ошибка записи в реестр';
        stopBtnLoad();
        return;
      }

     uploadStatus.textContent = `Файл поставлен в очередь: ${insertedRow.file_number}`;
      uploadProgress.classList.remove('running');
      uploadProgress.classList.add('done', 'fade-out');
      setTimeout(() => {
        uploadProgress.style.display = 'none';
        uploadProgress.classList.remove('done', 'fade-out');
      }, 1000);
      stopBtnLoad();

     try {
        await supabase.from(TABLE).update({ status: 'BLOCK 1 ( в работе )' }).eq('id', insertedRow.id);
        await supabase.functions.invoke('modal9-parser', {
          body: { request_id: insertedRow.id },
        });
        await loadHistory();
      } catch (err) {
        console.error('modal9-parser error:', err);
      }

      selectedFile = null;
      fileInput.value = '';
      renderFileList();
  });

  let history = [];
  async function loadHistory() {
    const oldMap = {};
    history.forEach(h => (oldMap[h.id] = h.status));
     let query = supabase
      .from(TABLE)
      .select('id, file_number, user_login, created_at, file_name, file_ext, status')
      .order('created_at', { ascending: false });

    const { data: { session } } = await supabase.auth.getSession();
    if (myFilesToggle.checked && session?.user?.email) {
      query = query.eq('user_login', session.user.email);
    }

    const { data, error } = await query;

    if (error) { console.error(error); return; }
    history = data || [];
    renderHistory(oldMap);
    renderBlock1();
  }

  function renderHistory(oldMap = {}) {
    historyList.querySelectorAll('.spec-content').forEach(el => {
      const openBlock = el.querySelector('.modal-block.open');
      if (openBlock) {
        const cls = Array.from(openBlock.classList).find(c => c.startsWith('block'));
        if (cls) historyOpenBlocks[el.dataset.specId] = cls;
      }
    });
    const openIds = Array.from(historyList.querySelectorAll('.spec-content'))
      .filter(el => !el.classList.contains('hidden'))
      .map(el => el.dataset.specId);
    historyList.innerHTML = '';
    history.forEach(item => {
        const fragment = rowTemplate.content.cloneNode(true);
        const rowEl = fragment.querySelector('.history-item');
        rowEl.dataset.specId = item.id;
        rowEl.classList.add('fade-in');
        rowEl.addEventListener('click', () => openRowGroup(item.id, historyOpenBlocks[item.id]));
        fragment.querySelectorAll('[data-field]').forEach(el => {
          const field = el.dataset.field;
          let val = item[field];
          if (field === 'created_at') {
            val = new Date(item.created_at).toLocaleString();
          }
          if (el.tagName === 'INPUT') {
            el.value = val || '';
          } else {
            el.textContent = val || '';
          }
           if (field === 'id') {
            el.addEventListener('click', e => {
              e.stopPropagation();
              openRowGroup(item.id, historyOpenBlocks[item.id]);
            });
          } else {
            el.addEventListener('click', e => {
              e.stopPropagation();
              navigator.clipboard.writeText(el.value || el.textContent || '');
              showCopyTip(el);
            });
          }
          if (field === 'status') {
            updateStatus(el, val);
            if (oldMap[item.id] && oldMap[item.id] !== val) {
              animateStatus(el, val);
            }
          }
        });
      const specRows = specGroups[item.id] || [];
        if (specRows.length) {
          const specFrag = specTemplate.content.cloneNode(true);
          const container = specFrag.querySelector('.spec-container');
          container.dataset.specId = item.id;
          const content = specFrag.querySelector('.spec-content');
          const title = specFrag.querySelector('.spec-title');
          const btn = specFrag.querySelector('.group-close');
          const progressFrag = specProgressTemplate.content.cloneNode(true);
          const progress = progressFrag.querySelector('.spec-progress');
          progress.dataset.specId = item.id;
          progress.classList.add('fade-toggle', 'hidden');
          progress.style.display = 'none';
          container.insertBefore(progressFrag, content);
          initProgressHandlers(progress, item.id);
          setProgress(progress, item.status);
          if (btn) btn.remove();
          if (title) title.style.display = 'none';
          content.dataset.specId = item.id;
          content.classList.add('fade-toggle', 'hidden');
          content.style.display = 'none';
         specRows.sort((a, b) => (a.pos_number_int ?? 0) - (b.pos_number_int ?? 0)).forEach(r => {
            const rf = specRowTemplate.content.cloneNode(true);
            rf.querySelector('[data-field="pos_number"]').value = r.pos_number;
            rf.querySelector('[data-field="name"]').value = r.name;
            rf.querySelector('[data-field="qty"]').value = r.qty;
            const attrsWrap = rf.querySelector('.block1 .modal-content');
            (r.attrs || '').split('|').forEach(pair => {
              pair = pair.trim();
              if(!pair) return;
              const [p,v] = pair.split(/[:=]/);
              const fragPair = attrPairTemplate.content.cloneNode(true);
              const pInp = fragPair.querySelector('.param-input');
              const vInp = fragPair.querySelector('.value-input');
              if(pInp){ pInp.value = p || ''; pInp.readOnly = true; }
              if(vInp){ vInp.value = v || ''; vInp.readOnly = true; }
              attrsWrap.appendChild(fragPair);
            });
            const b2 = rf.querySelector('.block2 .modal-content');
            if (b2) {
              const sels = selectionMap[r.id] || [];
              if (sels.length) {
                sels.forEach(sel => {
                  const b2Frag = block2Template.content.cloneNode(true);
                  const b2El = b2Frag.firstElementChild;
                  if (b2El) b2El.classList.add('fade-in');
                  const inputs = b2Frag.querySelectorAll('input');
                  if (inputs[0]) inputs[0].value = sel.article || '';
                  if (inputs[1]) inputs[1].value = sel.model_name || '';
                  if (inputs[2]) inputs[2].value = sel.qty || '';
                  if (inputs[3]) inputs[3].value = sel.unit || '';
                  b2.appendChild(b2Frag);
                });
              } else {
                const b2Frag = block2Template.content.cloneNode(true);
                const b2El = b2Frag.firstElementChild;
                if (b2El) b2El.classList.add('fade-in');
                b2.appendChild(b2Frag);
              }
            }
            const b21 = rf.querySelector('.block21 .modal-content');
            if (b21) appendBlock21Content(b21, selectionMap[r.id] || []);
            rf.querySelector('.block1').classList.add('open');
            content.appendChild(rf);
          });
          fragment.appendChild(specFrag);
        }
        historyList.appendChild(fragment);
    });
    setupDynamicBlocks(historyList);
    openIds.forEach(id => {
      if (historyList.querySelector(`.spec-content[data-spec-id="${id}"]`)) {
       openRowGroup(id, historyOpenBlocks[id]);
      }
    });
    setupOverflowTooltips(historyList);
    applySecondFilter();
  }

  function applySecondFilter() {
    const q = filterInput.value.trim().toLowerCase();
    filterClear.style.display = q ? 'block' : 'none';
    historyList.querySelectorAll('.history-item').forEach(item => {
      let visible = true;
      if (q) {
        visible = ['file_number','user_login','created_at','file_name','file_ext','status','id'].some(field => {
          const el = item.querySelector(`[data-field="${field}"]`);
          if (!el) return false;
          const val = (el.value || el.textContent || '').toString().toLowerCase();
          return val.includes(q);
        });
      }
      item.style.display = visible ? '' : 'none';
      const spec = historyList.querySelector(`.spec-container[data-spec-id="${item.dataset.specId}"]`);
      if (spec) spec.style.display = visible ? '' : 'none';
    });
  }

  let block1Rows = [];
  let specGroups = {};
  let selectionMap = {};
  let loadingBlock1 = false;
  let pendingLoad = false;
  async function loadBlock1() {
    if (loadingBlock1) {
      pendingLoad = true;
      return;
    }
    loadingBlock1 = true;
    const { data, error } = await supabase
      .from(POS_TABLE)                                // ← заменили константу
      .select(
        'file_number, user_login, file_name, id, spec_id,' +
        'pos_number, pos_number_int, name, qty, unit, attrs'
      )
     .order('spec_id', { ascending: false })
      .order('pos_number_int', { ascending: true });

    if (error) { console.error(error); loadingBlock1 = false; if (pendingLoad) { pendingLoad = false; loadBlock1(); } return; }
    block1Rows = data || [];
    const posIds = block1Rows.map(r => r.id);
    selectionMap = {};
    if (posIds.length) {
      // //фронтенд: выборка с полями прайсера
const { data: sels, error: selErr } = await supabase
  .from(SELECT_TABLE)
  .select('pos_id, article, model_name, qty, unit, \
    price1_amount, price1_currency, price1_store, price1_url, \
    price2_amount, price2_currency, price2_store, price2_url, \
    price3_amount, price3_currency, price3_store, price3_url, \
    pricer_status')
  .in('pos_id', posIds);
      if (selErr) console.error(selErr);
      (sels || []).forEach(s => {
        (selectionMap[s.pos_id] = selectionMap[s.pos_id] || []).push(s);
      });
    }
    specGroups = {};
    block1Rows.forEach(r => {
      (specGroups[r.spec_id] = specGroups[r.spec_id] || []).push(r);
    });
    renderBlock1();
    loadingBlock1 = false;
    if (pendingLoad) {
      pendingLoad = false;
      loadBlock1();
    }
  }

  function renderBlock1() {
    block1List.querySelectorAll('.spec-content').forEach(el => {
      const openBlock = el.querySelector('.modal-block.open');
      if (openBlock) {
        const cls = Array.from(openBlock.classList).find(c => c.startsWith('block'));
        const posInput = openBlock.closest('.modalCONTEINERpost')?.querySelector('[data-field="pos_number"]');
        if (cls && posInput) {
          block1OpenBlocks[el.dataset.specId] = { block: cls, pos: posInput.value };
        }
      }
    });
    const openIds = Array.from(block1List.querySelectorAll('.spec-content'))
        .filter(el => !el.classList.contains('hidden'))
        .map(el => el.dataset.specId);
      block1List.innerHTML = '';
      const ids = Object.keys(specGroups).sort((a, b) => Number(b) - Number(a));
      ids.forEach(id => {
        const frag = specTemplate.content.cloneNode(true);
        const container = frag.querySelector('.spec-container');
        container.dataset.specId = id;
        const header = frag.querySelector('.spec-header');
        const btn = frag.querySelector('.group-close');
        const content = frag.querySelector('.spec-content');
        const progressFrag = specProgressTemplate.content.cloneNode(true);
        const progress = progressFrag.querySelector('.spec-progress');
        progress.dataset.specId = id;
        progress.classList.add('fade-toggle', 'hidden');
        progress.style.display = 'none';
        container.insertBefore(progressFrag, content);
        initProgressHandlers(progress, id);
        content.dataset.specId = id;
        btn.classList.add('fade-toggle', 'hidden');
        content.classList.add('fade-toggle', 'hidden');
        btn.style.display = 'none';
        content.style.display = 'none';
        const specStatus = history.find(h => h.id === Number(id))?.status;
        setProgress(progress, specStatus);
        header.addEventListener('click', () => {
          openGroup(id, block1OpenBlocks[id]);
        });
        btn.addEventListener('click', e => { e.stopPropagation(); closeGroup(id); });

       specGroups[id].sort((a, b) => (a.pos_number_int ?? 0) - (b.pos_number_int ?? 0)).forEach(row => {
          const rf = specRowTemplate.content.cloneNode(true);
          rf.querySelector('[data-field="pos_number"]').value = row.pos_number;
          rf.querySelector('[data-field="name"]').value = row.name;
          rf.querySelector('[data-field="qty"]').value = row.qty;
          const unitInput = rf.querySelector('[data-field="unit"]');
          if (unitInput) unitInput.value = row.unit || '';
          const attrsWrap = rf.querySelector('.block1 .modal-content');
          (row.attrs || '').split('|').forEach(pair => {
            pair = pair.trim();
            if(!pair) return;
            const [p, v] = pair.split(/[:=]/);
            const fragPair = attrPairTemplate.content.cloneNode(true);
            const pInp = fragPair.querySelector('.param-input');
            const vInp = fragPair.querySelector('.value-input');
            if(pInp) {
              pInp.value = p || '';
              pInp.readOnly = true;
            }
            if(vInp) {
              vInp.value = v || '';
              vInp.readOnly = true;
            }
            attrsWrap.appendChild(fragPair);
          });
          const b2 = rf.querySelector('.block2 .modal-content');
          if (b2) {
            const sels = selectionMap[row.id] || [];
            if (sels.length) {
              sels.forEach(sel => {
                const b2Frag = block2Template.content.cloneNode(true);
                const b2El = b2Frag.firstElementChild;
                const inputs = b2Frag.querySelectorAll('input');
                if (inputs[0]) inputs[0].value = sel.article || '';
                if (inputs[1]) inputs[1].value = sel.model_name || '';
                if (inputs[2]) inputs[2].value = sel.qty || '';
                if (inputs[3]) inputs[3].value = sel.unit || '';
                b2.appendChild(b2Frag);
                if (b2El) requestAnimationFrame(() => b2El.classList.add('fade-in'));
              });
            } else {
              const b2Frag = block2Template.content.cloneNode(true);
              const b2El = b2Frag.firstElementChild;
              if (b2El) b2El.classList.add('fade-in');
              b2.appendChild(b2Frag);
              if (b2El) requestAnimationFrame(() => b2El.classList.add('fade-in'));
            }
          }
          // //фронтенд: заполнение BLOCK 2/1
const b21 = rf.querySelector('.block21 .modal-content');
          if (b21) appendBlock21Content(b21, selectionMap[row.id] || []);

          rf.querySelector('.block1').classList.add('open');
          content.appendChild(rf);
        });
        block1List.appendChild(frag);
      });
    setupDynamicBlocks(block1List);
    openIds.forEach(id => {
      if (block1List.querySelector(`.spec-content[data-spec-id="${id}"]`)) {
        openGroup(id, block1OpenBlocks[id]);
      }
    });
    setupOverflowTooltips(block1List);
  }

  function openGroup(id, saved) {
    block1List.querySelectorAll('.spec-content').forEach(c => {
      if (c.dataset.specId !== String(id)) {
        c.classList.add('hidden');
        c.addEventListener('transitionend', () => { c.style.display = 'none'; }, { once: true });
      }
    });
    block1List.querySelectorAll('.group-close').forEach(b => {
      const sid = b.closest('.spec-container')?.dataset.specId;
      if (sid !== String(id)) {
        b.classList.add('hidden');
        b.addEventListener('transitionend', () => { b.style.display = 'none'; }, { once: true });
      }
    });
    block1List.querySelectorAll('.spec-progress').forEach(p => {
      if (p.dataset.specId !== String(id)) {
        p.classList.add('hidden');
        p.addEventListener('transitionend', () => { p.style.display = 'none'; }, { once: true });
      }
    });
    const cont = block1List.querySelector(`.spec-content[data-spec-id="${id}"]`);
    const btn = block1List.querySelector(`.spec-container[data-spec-id="${id}"] .group-close`);
    const prog = block1List.querySelector(`.spec-progress[data-spec-id="${id}"]`);
    if (cont) {
      resetDynamicBlocks(cont);
      cont.style.display = 'block';
      requestAnimationFrame(() => cont.classList.remove('hidden'));
      let current = null;
      let posInput = null;
      if (saved && saved.pos) {
        const rowInput = cont.querySelector(`[data-field="pos_number"][value="${saved.pos}"]`);
        const row = rowInput ? rowInput.closest('.modalCONTEINERpost') : null;
        if (row) {
          posInput = rowInput;
          if (saved.block) {
            row.querySelectorAll('.modal-block').forEach(b => b.classList.remove('open'));
            const target = row.querySelector(`.modal-block.${saved.block}`);
            if (target) target.classList.add('open');
          }
          current = row.querySelector('.modal-block.open');
        } else {
          current = cont.querySelector('.modal-block.open');
          posInput = current?.closest('.modalCONTEINERpost')?.querySelector('[data-field="pos_number"]');
        }
      } else {
        current = cont.querySelector('.modal-block.open');
        posInput = current?.closest('.modalCONTEINERpost')?.querySelector('[data-field="pos_number"]');
      }
      if (current && (posInput || saved?.pos)) {
        const cls = Array.from(current.classList).find(c => c.startsWith('block'));
        const pos = posInput ? posInput.value : saved.pos;
        if (cls && pos) block1OpenBlocks[id] = { block: cls, pos };
      }
    }
    if (btn) {
      btn.style.display = 'inline';
      requestAnimationFrame(() => btn.classList.remove('hidden'));
    }
    if (prog) {
      prog.style.display = 'flex';
      requestAnimationFrame(() => prog.classList.remove('hidden'));
    }
  }

  function closeGroup(id) {
    const cont = block1List.querySelector(`.spec-content[data-spec-id="${id}"]`);
    const btn = block1List.querySelector(`.spec-container[data-spec-id="${id}"] .group-close`);
    const prog = block1List.querySelector(`.spec-progress[data-spec-id="${id}"]`);
    if (cont) {
      cont.classList.add('hidden');
      cont.addEventListener('transitionend', () => { cont.style.display = 'none'; }, { once: true });
      resetDynamicBlocks(cont);
    }
    if (btn) {
      btn.classList.add('hidden');
      btn.addEventListener('transitionend', () => { btn.style.display = 'none'; }, { once: true });
    }
    if (prog) {
      prog.classList.add('hidden');
      prog.addEventListener('transitionend', () => { prog.style.display = 'none'; }, { once: true });
    }
    delete block1OpenBlocks[id];
  }

  function openRowGroup(id, blockClass) {
    if (openedSpecId && openedSpecId !== id) {
      closeRowGroup(openedSpecId);
    }
    openedSpecId = id;
    const cont = historyList.querySelector(`.spec-content[data-spec-id="${id}"]`);
    const prog = historyList.querySelector(`.spec-progress[data-spec-id="${id}"]`);
    if (cont) {
      const oldT = hideTimers.get(cont);
      if (oldT) {
        clearTimeout(oldT);
        hideTimers.delete(cont);
      }
      cont.style.display = 'block';
      requestAnimationFrame(() => cont.classList.remove('hidden'));
      if (blockClass) {
        const targets = cont.querySelectorAll(`.modal-block.${blockClass}`);
        if (targets.length) {
          cont.querySelectorAll('.modal-block').forEach(b => b.classList.remove('open'));
          targets.forEach(t => t.classList.add('open'));
        } else {
          resetDynamicBlocks(cont);
        }
      } else {
        resetDynamicBlocks(cont);
      }
      const current = cont.querySelector('.modal-block.open');
      if (current) {
        const cls = Array.from(current.classList).find(c => c.startsWith('block'));
        if (cls) historyOpenBlocks[id] = cls;
      }
    }
     if (prog) {
      const oldT = hideTimers.get(prog);
      if (oldT) {
        clearTimeout(oldT);
        hideTimers.delete(prog);
      }
      prog.style.display = 'flex';
      requestAnimationFrame(() => prog.classList.remove('hidden'));
    }

    historyList.querySelectorAll('.spec-progress').forEach(p => {
      if (p.dataset.specId !== String(id)) {
        p.classList.add('hidden');
        const t = setTimeout(() => {
          p.style.display = 'none';
          hideTimers.delete(p);
        }, 500);
        hideTimers.set(p, t);
      }
    });
    
    const row = historyList.querySelector(`.history-item[data-spec-id="${id}"]`);
    if (row) {
      const specCont = row.querySelector('[data-field="id"]').closest('.input-container');
      if (specCont) {
        specCont.style.position = 'relative';
        if (!specCont.querySelector('.spec-close-btn')) {
          const extraBtn = document.createElement('button');
          extraBtn.textContent = '×';
          extraBtn.className = 'group-close ans5-close spec-close-btn';
          extraBtn.style.position = 'absolute';
          extraBtn.style.right = '-25px';
          extraBtn.addEventListener('click', e => {
            e.stopPropagation();
            closeRowGroup(id);
          });
          specCont.appendChild(extraBtn);
        }
      }
    }
  }

  function closeRowGroup(id) {
    if (openedSpecId === id) openedSpecId = null;
    const cont = historyList.querySelector(`.spec-content[data-spec-id="${id}"]`);
    const btn = historyList.querySelector(`.spec-container[data-spec-id="${id}"] .group-close`);
    const extra = historyList.querySelector(`.history-item[data-spec-id="${id}"] .spec-close-btn`);
    const prog = historyList.querySelector(`.spec-progress[data-spec-id="${id}"]`);
    if (cont) {
      cont.classList.add('hidden');
      const t = setTimeout(() => {
        cont.style.display = 'none';
        hideTimers.delete(cont);
      }, 500);
      hideTimers.set(cont, t);
    }
    if (btn) {
      btn.classList.add('hidden');
      const t = setTimeout(() => {
        btn.style.display = 'none';
        hideTimers.delete(btn);
      }, 500);
      hideTimers.set(btn, t);
    }
    if (prog) {
      prog.classList.add('hidden');
      const t = setTimeout(() => {
        prog.style.display = 'none';
        hideTimers.delete(prog);
      }, 500);
      hideTimers.set(prog, t);
    }
    if (extra) extra.remove();
  }

  function resetDynamicBlocks(scope) {
    scope.querySelectorAll('.dynamic-modals').forEach(dm => {
      const blocks = dm.querySelectorAll('.modal-block');
      blocks.forEach((b, i) => {
        if (i === 0) b.classList.add('open');
        else b.classList.remove('open');
      });
    });
  }

  function setupDynamicBlocks(scope) {
    scope.querySelectorAll('.dynamic-modals').forEach(dm => {
      const blocks = dm.querySelectorAll('.modal-block');
      (dm.querySelector('.modal-block.open') || blocks[0])?.classList.add('open');
      blocks.forEach(block => {
        block.addEventListener('dblclick', () => {
          dm.querySelectorAll('.modal-block').forEach(b => b.classList.remove('open'));
          block.classList.add('open');
          const specId = block.closest('.spec-content')?.dataset.specId;
          const cls = Array.from(block.classList).find(c => c.startsWith('block'));
          const posInput = block.closest('.modalCONTEINERpost')?.querySelector('[data-field="pos_number"]');
          if (specId && cls && posInput) {
            block1OpenBlocks[specId] = { block: cls, pos: posInput.value };
          }
        });
      });
    });
  }
  function setupOverflowTooltips(scope) {
    scope.querySelectorAll('.styled_input_bar').forEach(input => {
      const updateOverflow = () => {
        const container = input.closest('.input-container');
        if (!container) return;
        if (input.scrollWidth > input.clientWidth) container.classList.add('overflow');
        else container.classList.remove('overflow');
      };
      updateOverflow();
      input.addEventListener('input', updateOverflow);
      input.addEventListener('mouseenter', () => {
        if (input.scrollWidth > input.clientWidth) {
          input.setAttribute('title', input.value || input.textContent || '');
        }
      });
      input.addEventListener('mouseleave', () => {
        input.removeAttribute('title');
      });
    });
  }
  function boolLabel(value) {
    return value ? 'да' : 'нет';
  }
  function padRow(row, length) {
    const source = Array.isArray(row) ? row : [];
    const result = source.slice(0, length);
    while (result.length < length) {
      result.push('');
    }
    return result;
  }
  function hideContextMenu() {
    if (!contextMenu) return;
    contextMenu.classList.remove('visible');
    contextMenu.style.display = 'none';
    contextMenu.dataset.specId = '';
    contextSpecContent = null;
  }
  function showContextMenuAt(event, specContent) {
    if (!contextMenu || !specContent) return;
    const specId = specContent.dataset.specId;
    if (!specId) return;
    contextSpecContent = specContent;
    contextMenu.dataset.specId = specId;
    contextMenu.classList.remove('visible');
    contextMenu.style.display = 'block';
    contextMenu.style.left = '0px';
    contextMenu.style.top = '0px';
    requestAnimationFrame(() => {
      const rootRect = root.getBoundingClientRect();
      const rect = contextMenu.getBoundingClientRect();
      let left = event.clientX - rootRect.left;
      let top = event.clientY - rootRect.top;
      const maxLeft = Math.max(0, rootRect.width - rect.width);
      const maxTop = Math.max(0, rootRect.height - rect.height);
      if (left < 0) left = 0;
      else if (left > maxLeft) left = maxLeft;
      if (top < 0) top = 0;
      else if (top > maxTop) top = maxTop;
      contextMenu.style.left = `${left}px`;
      contextMenu.style.top = `${top}px`;
      contextMenu.classList.add('visible');
    });
  }
  function collectSpecData(specId, specContent) {
    if (!specId) return null;
    const idStr = String(specId);
    const container = specContent
      || historyList.querySelector(`.spec-content[data-spec-id="${idStr}"]`)
      || block1List.querySelector(`.spec-content[data-spec-id="${idStr}"]`);
    if (!container) return null;
    const historyItem = historyList.querySelector(`.history-item[data-spec-id="${idStr}"]`);
    const historyEntry = history.find(h => String(h.id) === idStr);
    const readField = (field) => {
      if (historyItem) {
        const el = historyItem.querySelector(`[data-field="${field}"]`);
        if (el) {
          const raw = el.tagName === 'INPUT' ? el.value : el.textContent;
          if (typeof raw === 'string') return raw.trim();
        }
      }
      if (historyEntry) {
        if (field === 'created_at') {
          return historyEntry.created_at ? new Date(historyEntry.created_at).toLocaleString() : '';
        }
        const value = historyEntry[field];
        if (value != null) return String(value).trim();
      }
      return '';
    };
    const data = {
      id: idStr,
      header: {
        file_number: readField('file_number'),
        user_login: readField('user_login'),
        created_at: readField('created_at'),
        file_name: readField('file_name'),
        file_ext: readField('file_ext'),
        status: readField('status'),
        spec_id: idStr,
      },
      positions: [],
    };
    container.querySelectorAll('.modalCONTEINERpost').forEach(node => {
      const pos = {
        posNumber: node.querySelector('[data-field="pos_number"]')?.value?.trim() || '',
        name: node.querySelector('[data-field="name"]')?.value?.trim() || '',
        qty: node.querySelector('[data-field="qty"]')?.value?.trim() || '',
        unit: node.querySelector('[data-field="unit"]')?.value?.trim() || '',
        registries: {},
        block1: [],
        block2: [],
        block21: [],
        block3: [],
        block31: [],
      };
      node.querySelectorAll('.registry-checkboxes input[data-field]').forEach(chk => {
        if (chk.dataset.field) {
          pos.registries[chk.dataset.field] = !!chk.checked;
        }
      });
      const block1Content = node.querySelector('.block1 .modal-content');
      if (block1Content) {
        block1Content.querySelectorAll('.modalRow').forEach(row => {
          const paramEl = row.querySelector('.param-input');
          const valueEl = row.querySelector('.value-input');
          const param = (paramEl?.value || paramEl?.textContent || '').trim();
          const value = (valueEl?.value || valueEl?.textContent || '').trim();
          if (param || value) {
            pos.block1.push({ param, value });
          }
        });
      }
      const collectRows = (selector) => {
        const block = node.querySelector(selector);
        if (!block) return [];
        const rows = [];
        block.querySelectorAll('.modalRow').forEach(row => {
          const inputs = row.querySelectorAll('input');
          if (!inputs.length) return;
          const values = Array.from(inputs, input => (input.value || input.textContent || '').trim());
          rows.push(values);
        });
        return rows;
      };
      pos.block2 = collectRows('.block2 .modal-content');
      pos.block21 = collectRows('.block21 .modal-content');
      pos.block3 = collectRows('.block3 .modal-content');
      pos.block31 = collectRows('.block31 .modal-content');
      data.positions.push(pos);
    });
    return data;
  }
  function collectRepeatingRows(positions, key) {
    const rows = [];
    let maxLen = 0;
    positions.forEach(pos => {
      (pos[key] || []).forEach(row => {
        const values = Array.isArray(row) ? row.slice() : [];
        maxLen = Math.max(maxLen, values.length);
        rows.push({ posNumber: pos.posNumber || '', values });
      });
    });
    if (!rows.length || maxLen === 0) return null;
    const header = ['№ в ТЗ'];
    for (let i = 0; i < maxLen; i += 1) {
      const label = i % 2 === 0 ? 'артикул' : 'магазин';
      header.push(`${label} ${Math.floor(i / 2) + 1}`);
    }
    const normalized = rows.map(({ posNumber, values }) => {
      const row = [posNumber];
      for (let i = 0; i < maxLen; i += 1) {
        row.push(values[i] || '');
      }
      return row;
    });
    return { header, rows: normalized };
  }
  function formatSpecForClipboard(data) {
    if (!data) return '';
    const lines = [];
    const headerMap = [
      ['номер', 'file_number'],
      ['login', 'user_login'],
      ['дата', 'created_at'],
      ['файл', 'file_name'],
      ['ext', 'file_ext'],
      ['статус', 'status'],
      ['spec #', 'spec_id'],
    ];
    headerMap.forEach(([label, key]) => {
      const value = data.header?.[key] ?? '';
      lines.push(`${label}\t${value}`);
    });
    lines.push('');
    lines.push('BLOCK 1');
    lines.push(['№ в ТЗ', 'наименование', 'кол-во', 'ед. изм.', 'РПП 878', 'ТОРП', 'РРПО 1875'].join('\t'));
    data.positions.forEach(pos => {
      const regs = pos.registries || {};
      lines.push([
        pos.posNumber || '',
        pos.name || '',
        pos.qty || '',
        pos.unit || '',
        boolLabel(regs.rpp_878),
        boolLabel(regs.torp),
        boolLabel(regs.rrpo_1875),
      ].join('\t'));
      (pos.block1 || []).forEach(attr => {
        lines.push(`\t${attr.param || ''}\t${attr.value || ''}`);
      });
    });
    lines.push('');
    lines.push('BLOCK 2');
    lines.push(['№ в ТЗ', ...BLOCK2_COLUMNS].join('\t'));
    data.positions.forEach(pos => {
      const rows = (pos.block2 && pos.block2.length) ? pos.block2 : [[]];
      rows.forEach(row => {
        const values = [pos.posNumber || ''];
        const length = Math.max(BLOCK2_COLUMNS.length, row.length);
        padRow(row, length).forEach(cell => values.push(cell));
        lines.push(values.join('\t'));
      });
    });
    const block21 = collectRepeatingRows(data.positions, 'block21');
    if (block21) {
      lines.push('');
      lines.push('BLOCK 2.1');
      lines.push(block21.header.join('\t'));
      block21.rows.forEach(row => lines.push(row.join('\t')));
    }
    lines.push('');
    lines.push('BLOCK 3');
    lines.push(['№ в ТЗ', ...BLOCK3_COLUMNS].join('\t'));
    data.positions.forEach(pos => {
      const rows = (pos.block3 && pos.block3.length) ? pos.block3 : [[]];
      rows.forEach(row => {
        const values = [pos.posNumber || ''];
        const length = Math.max(BLOCK3_COLUMNS.length, row.length);
        padRow(row, length).forEach(cell => values.push(cell));
        lines.push(values.join('\t'));
      });
    });
    const block31 = collectRepeatingRows(data.positions, 'block31');
    if (block31) {
      lines.push('');
      lines.push('BLOCK 3.1');
      lines.push(block31.header.join('\t'));
      block31.rows.forEach(row => lines.push(row.join('\t')));
    }
    return lines.join('\n');
  }
  function escapeHtml(value) {
    return String(value ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
  function buildTableHtml(caption, headers, rows) {
    const head = headers.map(h => `<th>${escapeHtml(h)}</th>`).join('');
    const body = rows.length
      ? rows.map(row => `<tr>${row.map(cell => `<td>${escapeHtml(cell)}</td>`).join('')}</tr>`).join('')
      : `<tr>${headers.map(() => '<td></td>').join('')}</tr>`;
    const captionHtml = caption ? `<caption style="font-weight:600; text-align:left; padding:4px 0;">${escapeHtml(caption)}</caption>` : '';
    return `<table border="1" cellspacing="0" cellpadding="4" style="border-collapse:collapse; margin-bottom:12px;">${captionHtml}<thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>`;
  }
  function buildExcelHtml(data) {
    if (!data) return '';
    const tables = [];
    const headerRows = [
      ['номер', data.header?.file_number || ''],
      ['login', data.header?.user_login || ''],
      ['дата', data.header?.created_at || ''],
      ['файл', data.header?.file_name || ''],
      ['ext', data.header?.file_ext || ''],
      ['статус', data.header?.status || ''],
      ['spec #', data.header?.spec_id || ''],
    ];
    tables.push(buildTableHtml('Реквизиты файла', ['Поле', 'Значение'], headerRows));
    const block1MainRows = data.positions.map(pos => {
      const regs = pos.registries || {};
      return [
        pos.posNumber || '',
        pos.name || '',
        pos.qty || '',
        pos.unit || '',
        boolLabel(regs.rpp_878),
        boolLabel(regs.torp),
        boolLabel(regs.rrpo_1875),
      ];
    });
    tables.push(buildTableHtml('BLOCK 1', ['№ в ТЗ', 'наименование', 'кол-во', 'ед. изм.', 'РПП 878', 'ТОРП', 'РРПО 1875'], block1MainRows));
    const block1Attrs = [];
    data.positions.forEach(pos => {
      (pos.block1 || []).forEach(attr => {
        block1Attrs.push([pos.posNumber || '', attr.param || '', attr.value || '']);
      });
    });
    if (block1Attrs.length) {
      tables.push(buildTableHtml('BLOCK 1 параметры', ['№ в ТЗ', 'параметр', 'значение'], block1Attrs));
    }
    const block2Rows = [];
    data.positions.forEach(pos => {
      const rows = (pos.block2 && pos.block2.length) ? pos.block2 : [[]];
      rows.forEach(row => {
        const values = [pos.posNumber || ''];
        const length = Math.max(BLOCK2_COLUMNS.length, row.length);
        padRow(row, length).forEach(cell => values.push(cell));
        block2Rows.push(values);
      });
    });
    tables.push(buildTableHtml('BLOCK 2', ['№ в ТЗ', ...BLOCK2_COLUMNS], block2Rows));
    const block21 = collectRepeatingRows(data.positions, 'block21');
    if (block21) {
      tables.push(buildTableHtml('BLOCK 2.1', block21.header, block21.rows));
    }
    const block3Rows = [];
    data.positions.forEach(pos => {
      const rows = (pos.block3 && pos.block3.length) ? pos.block3 : [[]];
      rows.forEach(row => {
        const values = [pos.posNumber || ''];
        const length = Math.max(BLOCK3_COLUMNS.length, row.length);
        padRow(row, length).forEach(cell => values.push(cell));
        block3Rows.push(values);
      });
    });
    tables.push(buildTableHtml('BLOCK 3', ['№ в ТЗ', ...BLOCK3_COLUMNS], block3Rows));
    const block31 = collectRepeatingRows(data.positions, 'block31');
    if (block31) {
      tables.push(buildTableHtml('BLOCK 3.1', block31.header, block31.rows));
    }
    return tables.join('');
  }
  function createExcelBlob(data) {
    const html = buildExcelHtml(data);
    if (!html) return null;
    const content = `<!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>${html}</body></html>`;
    return new Blob(['\uFEFF', content], { type: 'application/vnd.ms-excel' });
  }
  function downloadSpecExcel(data, blob) {
    if (!blob) return;
    const url = URL.createObjectURL(blob);
    const baseName = data?.header?.file_number || data?.header?.spec_id || 'specification';
    const safeName = sanitize(String(baseName || 'specification')) || 'specification';
    const link = document.createElement('a');
    link.href = url;
    link.download = `spec_${safeName}.xls`;
    document.body.appendChild(link);
    link.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
      link.remove();
    }, 0);
  }
  if (!root.__contextMenuSetup) {
    root.addEventListener('contextmenu', event => {
      if (!contextMenu) return;
      const specContent = event.target.closest('.spec-content');
      if (!specContent || specContent.classList.contains('hidden')) {
        hideContextMenu();
        return;
      }
      if (!specContent.closest('.history-list') && !specContent.closest('.block1-wrapper')) {
        hideContextMenu();
        return;
      }
      const computed = window.getComputedStyle(specContent);
      if (computed.display === 'none' || computed.visibility === 'hidden' || Number(computed.opacity) === 0) {
        hideContextMenu();
        return;
      }
      event.preventDefault();
      showContextMenuAt(event, specContent);
    });
    window.addEventListener('click', event => {
      if (!contextMenu) return;
      if (contextMenu.style.display === 'block' && !contextMenu.contains(event.target)) {
        hideContextMenu();
      }
    });
    window.addEventListener('resize', hideContextMenu);
    root.addEventListener('scroll', hideContextMenu, true);
    window.addEventListener('keydown', event => {
      if (event.key === 'Escape') hideContextMenu();
    });
    if (contextMenu) {
      contextMenu.addEventListener('click', async event => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        event.preventDefault();
        event.stopPropagation();
        const action = button.dataset.action;
        const specId = contextMenu.dataset.specId;
        if (!specId) return;
        const specData = collectSpecData(specId, contextSpecContent);
        if (!specData) {
          hideContextMenu();
          return;
        }
        try {
          if (action === 'copy') {
            const text = formatSpecForClipboard(specData);
            if (text) {
              await navigator.clipboard.writeText(text);
              showCopyTip(button);
            }
          } else if (action === 'excel') {
            const blob = createExcelBlob(specData);
            if (blob) {
              downloadSpecExcel(specData, blob);
            }
          }
        } catch (err) {
          console.error('context menu action error:', err);
        } finally {
          hideContextMenu();
        }
      });
      contextMenu.addEventListener('contextmenu', event => event.preventDefault());
      contextMenu.addEventListener('mousedown', event => event.stopPropagation());
    }
    root.__contextMenuSetup = true;
  }
  function initProgressHandlers(progress, specId) {
    const buttons = progress.querySelectorAll('.refresh');
    if (buttons[0]) buttons[0].addEventListener('click', async e => {
      e.stopPropagation();
      const btn = e.currentTarget;
      btn.classList.add('loading');
      btn.disabled = true;
      try {
        await refreshParser(specId, progress);
      } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    });
    if (buttons[1]) buttons[1].addEventListener('click', async e => {
      e.stopPropagation();
      const btn = e.currentTarget;
      btn.classList.add('loading');
      btn.disabled = true;
      try {
        await refreshSelector(specId, progress);
        } catch (err) {
        console.error(err);
      } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    });
  }

  async function refreshParser(specId, progress) {
    try {
      await supabase.from(SELECT_TABLE).delete().eq('spec_id', specId);
      await supabase.from(POS_TABLE).delete().eq('spec_id', specId);
      await supabase.from(TABLE).update({ status: 'BLOCK 1 ( в работе )' }).eq('id', specId);
      await supabase.functions.invoke('modal9-parser', { body: { request_id: specId } });
      await loadHistory();
    } catch (err) {
      console.error('refreshParser error:', err);
    }
  }

  // === НОВАЯ ДВУХФАЗНАЯ ЛОГИКА ДЛЯ BLOCK 2 / 2.1 ===
  const delay = (ms) => new Promise(r => setTimeout(r, ms));

  async function trackSelectorProgress(specId, progressEl, statusEl, options = {}) {
    const { signal } = options;
    let lastStatus = null;
    for (;;) {
      if (signal?.aborted) throw new DOMException('Aborted', 'AbortError');
      const { sent, received, total } = await getSelectorProgress(specId);
      let status;
      if (total <= 0) status = 'BLOCK 2 ( готово )';
      else if (received >= total) status = 'BLOCK 2 ( готово )';
      else if (sent > 0) status = `BLOCK 2 ( ${sent} / ${received} / ${total} )`;
      else status = 'подготовка';
      if (statusEl) updateStatus(statusEl, status);
      setProgress(progressEl, { status, sent, received, total });
      if (status !== lastStatus) {
        lastStatus = status;
        try {
          await supabase.from(TABLE).update({ status }).eq('id', specId);
        } catch (err) {
          console.error('trackSelectorProgress status update error:', err);
        }
      }
      if (status === 'BLOCK 2 ( готово )') break;
      await delay(1000);
    }
}

  async function refreshSelector(specId, progress) {
    const { data: { session } = {} } = await supabase.auth.getSession();
    if (!session) return;

    const statusEl = historyList.querySelector(`.history-item[data-spec-id="${specId}"] [data-field="status"]`);
    updateStatus(statusEl, 'подготовка');
    setProgress(progress, 'подготовка');
    const controller = new AbortController();
    const trackerPromise = (async () => {
      try {
        await trackSelectorProgress(specId, progress, statusEl, { signal: controller.signal });
      } catch (err) {
        if (err?.name !== 'AbortError') console.error('trackSelectorProgress error:', err);
      }
    })();
    try {
      await supabase.from(TABLE).update({ status: 'подготовка' }).eq('id', specId);
      const { error } = await supabase.functions.invoke('modal9-selector', { body: { spec_id: specId } });
      if (error) throw error;
    } catch (err) {
      controller.abort();
      console.error('refreshSelector error:', err);
    } finally {
      try {
        await trackerPromise;
      } catch (err) {
        if (err?.name !== 'AbortError') console.error('trackerPromise error:', err);
      }
      await loadBlock1();
      await loadHistory();
    }
  }
  
  function setupRealtime() {
  if (!supabase) return;
  realtimeSub = supabase
    .channel('modal9-realtime')
    .on('postgres_changes', { event: '*', schema: 'public', table: TABLE }, () => {
      loadHistory();
      scheduleLoadBlock1();
    })
    .on('postgres_changes', { event: '*', schema: 'public', table: SELECT_TABLE }, () => scheduleLoadBlock1())
    .on('postgres_changes', { event: '*', schema: 'public', table: STATUS_TABLE }, () => scheduleLoadBlock1())
    .subscribe();
}

  function cleanupRealtime() {
    if (realtimeSub) {
      realtimeSub.unsubscribe();
      realtimeSub = null;
    }
  }

  window.cleanupRealtime = cleanupRealtime;
  
  function setProgress(progressEl, info) {
    if (!progressEl) return;
    let status = '', sent, received, total;
    if (typeof info === 'string') status = info;
    else if (info && typeof info === 'object') {
      status = info.status || '';
      sent = info.sent;
      received = info.received;
      total = info.total;
    }
    const s = String(status || '').toLowerCase();
    let active = -1;
    const m2 = s.match(/block\s*2\s*\(\s*(\d+)\s*\/\s*(\d+)\s*\/\s*(\d+)\s*\)/i);
    if (/block\s*2/i.test(s)) {
      if ((!Number.isFinite(sent) || !Number.isFinite(received) || !Number.isFinite(total)) && m2) {
        sent = Number(m2[1]);
        received = Number(m2[2]);
        total = Number(m2[3]);
      }
      if (/готово/.test(s) || (Number.isFinite(received) && Number.isFinite(total) && total > 0 && received >= total)) active = 2;
      else active = 1;
    } else if (/block\s*1/i.test(s)) {
      if (/готово/.test(s)) active = 0;
    } else if (s.includes('обработан') || s.includes('done')) {
      active = 2;
    } else if (s.includes('подбор')) {
      active = 1;
    } else if (s.includes('селекц')) {
      active = 0;
    }
    const steps = progressEl.querySelectorAll('.step');
    steps.forEach((step, idx) => {
      const icon = step.querySelector('.status');
      if (idx <= active) {
        step.classList.add('active');
        if (icon) icon.textContent = 'done_all';
      } else {
        step.classList.remove('active');
        if (icon) icon.textContent = 'indeterminate_check_box';
      }
    });
  }

  async function getSelectorProgress(specId) {
    const [totalRes, sentRes, selectRes] = await Promise.all([
      supabase
        .from(POS_TABLE)
        .select('id', { count: 'exact', head: true })
        .eq('spec_id', specId),
      supabase
        .from(STATUS_TABLE)
        .select('pos_id', { count: 'exact', head: true })
        .eq('spec_id', specId),
      supabase
        .from(SELECT_TABLE)
        .select('pos_id')
        .eq('spec_id', specId)
        .limit(5000),
    ]);

    const totalCount = typeof totalRes?.count === 'number' ? totalRes.count : 0;
    if (totalRes?.error) console.error('getSelectorProgress total error:', totalRes.error);

    const sentCount = typeof sentRes?.count === 'number' ? sentRes.count : 0;
    if (sentRes?.error) console.error('getSelectorProgress sent error:', sentRes.error);

    let receivedCount = 0;
    if (selectRes?.error) {
      console.error('getSelectorProgress received error:', selectRes.error);
    } else if (Array.isArray(selectRes?.data)) {
      const unique = new Set();
      selectRes.data.forEach(row => {
        const posId = row?.pos_id ?? row?.posId ?? row?.posid;
        if (posId !== null && posId !== undefined) {
          unique.add(String(posId));
        }
      });
      receivedCount = unique.size;
    }

    const normalizedSent = Math.max(sentCount, receivedCount);
    const normalizedTotal = Math.max(totalCount, normalizedSent, receivedCount);

    return {
      sent: normalizedSent,
      received: receivedCount,
      total: normalizedTotal,
    };
  }

  try {
    const {
      data: { session },
    } = await supabase.auth.getSession();
    if (session) {
      await supabase.functions.invoke('modal9-selector', { body: { mode: 'ping' } });
    }
  } catch (_) {}

  await loadBlock1();
  await loadHistory();
  setupRealtime();
}

initModal9();

</script>
