<!-- ========= modal5.html  (Проект 5) ========= -->
<div id="modal5-container" class="modal5-shell">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <style>
    #modal5-container {
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      width: 100%;
      height: 100vh;
      padding: 20px 0;
      margin: 0;
      box-sizing: border-box;
      color: var(--content-color, #212121);
      font-family: 'Comfortaa', sans-serif;
    }

    #modal5-container .glass-panel {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--content-color, #212121);
      border-radius: 12px;
      box-shadow:
        0 0 0.75px hsl(205 20% 10% / 0.24),
        0.7px 0.8px 1.2px -0.4px hsl(205 20% 10% / 0.16),
        1.3px 1.5px 2.2px -0.8px hsl(205 20% 10% / 0.16),
        2.3px 2.6px 3.9px -1.2px hsl(205 20% 10% / 0.16),
        3.9px 4.4px 6.6px -1.7px hsl(205 20% 10% / 0.16),
        6.5px 7.2px 10.9px -2.1px hsl(205 20% 10% / 0.18);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
    }

    #modal5-container .modal-top {
      width: 1930px;
      max-width: 90vw;
      min-height: 255px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      margin-top: -20px;
      padding: 20px;
      box-sizing: border-box;
      color: var(--black-color, var(--content-color, #212121));
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    #modal5-container .modal5-signature {
      position: absolute;
      top: 10px;
      left: 10px;
      margin-top: -20px;
      margin-left: -1450px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    #modal5-container .modal5-signature h2 {
      margin: 0;
      font-size: 1.4em;
      color: #212121;
      text-transform: uppercase;
      display: flex;
      gap: 2px;
    }

    #modal5-container .modal5-signature h2 span {
      transition: 1.5s;
      display: inline-block;
    }

    #modal5-container .modal5-signature h2:hover span {
      filter: blur(20px);
      opacity: 0;
      transform: scale(2);
    }

    #modal5-container .modal5-signature h2 span:nth-child(1) { transition-delay: 0s; }
    #modal5-container .modal5-signature h2 span:nth-child(2) { transition-delay: 0.1s; }
    #modal5-container .modal5-signature h2 span:nth-child(3) { transition-delay: 0.2s; }
    #modal5-container .modal5-signature h2 span:nth-child(4) { transition-delay: 0.3s; }
    #modal5-container .modal5-signature h2 span:nth-child(5) { transition-delay: 0.4s; }
    #modal5-container .modal5-signature h2 span:nth-child(6) { transition-delay: 0.5s; }
    #modal5-container .modal5-signature h2 span:nth-child(7) { transition-delay: 0.6s; }
    #modal5-container .modal5-signature h2 span:nth-child(8) { transition-delay: 0.7s; }
    #modal5-container .modal5-signature h2 span:nth-child(9) { transition-delay: 0.8s; }
    #modal5-container .modal5-signature h2 span:nth-child(10) { transition-delay: 0.9s; }
    #modal5-container .modal5-signature h2 span:nth-child(11) { transition-delay: 1s; }
    #modal5-container .modal5-signature h2 span:nth-child(12) { transition-delay: 1.1s; }
    #modal5-container .modal5-signature h2 span:nth-child(13) { transition-delay: 1.2s; }
    #modal5-container .modal5-signature h2 span:nth-child(14) { transition-delay: 1.3s; }
    #modal5-container .modal5-signature h2 span:nth-child(15) { transition-delay: 1.4s; }
    #modal5-container .modal5-signature h2 span:nth-child(16) { transition-delay: 1.5s; }
    #modal5-container .modal5-signature h2 span:nth-child(17) { transition-delay: 1.6s; }
    #modal5-container .modal5-signature h2 span:nth-child(18) { transition-delay: 1.7s; }
    #modal5-container .modal5-signature h2 span:nth-child(19) { transition-delay: 1.8s; }
    #modal5-container .modal5-signature h2 span:nth-child(20) { transition-delay: 1.9s; }
    #modal5-container .modal5-signature h2 span:nth-child(21) { transition-delay: 2.0s; }

    #modal5-container .modalRow {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 14px;
    }

    #modal5-container .stats-row {
      justify-content: space-between;
      gap: 16px;
    }

    #modal5-container .stat-card {
      flex: 1;
      min-width: 240px;
      padding: 18px 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.25);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #modal5-container .stat-title {
      text-transform: uppercase;
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: var(--content-color, #212121);
    }

    #modal5-container .stat-value {
      font-size: 32px;
      font-weight: 700;
      line-height: 1.2;
      color: var(--content-color, #212121);
    }

    #modal5-container .stat-subtitle {
      font-size: 12px;
      opacity: 0.75;
    }

    #modal5-container .form-row {
      align-items: stretch;
      gap: 18px;
    }

    #modal5-container .form-fields {
      flex: 1;
      padding: 18px 20px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #modal5-container .form-fields .modalRow {
      gap: 12px;
    }

    #modal5-container .form-fields .filters-hint {
      font-size: 11px;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    #modal5-container .radio-inputs {
      position: relative;
      display: flex;
      flex-wrap: wrap;
      border-radius: 0.5rem;
      background: var(--content-color, #212121);
      border: 1px solid var(--content-color, #212121);
      color: var(--fon, #f5f5f5);
      padding: 2px 2px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      box-sizing: border-box;
      box-shadow: 0 0 0px 1px rgba(0, 0, 0, 0.06);
      width: 300px;
      height: 30px;
      align-self: center;
      margin-top: 10px;
      gap: 0.25rem;
    }

    #modal5-container .radio-inputs .radio {
      flex: 1 1 auto;
      text-align: center;
    }

    #modal5-container .radio-inputs .radio input {
      display: none;
    }

    #modal5-container .radio-inputs .radio .name {
      display: flex;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      border-radius: 0.5rem;
      border: none;
      padding: .5rem 0;
      color: rgba(51, 65, 85, 1);
      transition: all .15s ease-in-out;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 500;
    }

    #modal5-container .radio-inputs .radio input:checked + .name {
      color: var(--content-color, #212121);
      background: rgba(255, 255, 255, 0.12);
    }

    #modal5-container .button-form {
      position: relative;
      min-width: 220px;
      height: 30px;
      background: var(--content-color, #212121);
      border: 1px solid var(--content-color, #212121);
      color: var(--fon, #f5f5f5);
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-top: 15px;
    }

    #modal5-container .button-form:hover {
      color: var(--content-color, #212121);
      background: rgba(255, 255, 255, 0.12);
    }

    #modal5-container .button-form.primary {
      min-width: 200px;
    }

    #modal5-container .modal5-scroll-wrapper {
      width: 1950px;
      max-width: 90vw;
      flex: 1;
      padding-bottom: 20px;
      overflow: visible;
    }

    #modal5-container .modal5-window {
      color: var(--black-color, var(--content-color, #212121));
      width: 1930px;
      max-width: 90vw;
      padding-top: 20px;
      padding-bottom: 20px;
      padding-left: 20px;
      padding-right: 10px;
      box-sizing: border-box;
      margin: 0;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 275px;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      max-height: calc(100vh - 220px);
      overflow-x: visible;
    }

    #modal5-container .modal5-content {
      width: 1930px;
      height: 100%;
      box-sizing: border-box;
      overflow-y: auto;
      padding-right: 10px;
      margin-right: -10px;
      transition: opacity 0.3s ease;
      opacity: 1;
    }

    #modal5-container .modal5-content::-webkit-scrollbar { width: 6px; }
    #modal5-container .modal5-content::-webkit-scrollbar-track { background: transparent; }
    #modal5-container .modal5-content::-webkit-scrollbar-thumb { background-color: var(--content-color, #212121); border-radius: 10px; }

    #modal5-container .modalVNUT-content .modalBLOCK {
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      margin-bottom: 12px;
      padding: 18px 20px;
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    #modal5-container .modalVNUT-content .modalBLOCK:hover {
      transform: translateY(-2px);
    }

    #modal5-container .recipe-card {
      border: 1px solid #212121;
      border-radius: 10px;
      padding: 18px 20px;
      margin-top: 16px;
      margin-left: 12px;
      background: rgba(255, 255, 255, 0.05);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #modal5-container .recipe-card__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }

    #modal5-container .recipe-card__body {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #modal5-container .recipe-card__visual {
      width: 100%;
    }

    #modal5-container .recipe-visual-card {
      width: 100%;
      padding: 10px;
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
      box-sizing: border-box;
    }

    #modal5-container .recipe-visual-card__inner {
      position: relative;
      width: 100%;
      height: 500px;
      background: #ffffff;
      border-bottom-right-radius: 0px;
    }

    #modal5-container .recipe-visual-card__box {
      position: relative;
      width: 100%;
      height: 100%;
      background: #ffffff;
      border-radius: 10px;
      overflow: hidden;
    }

    #modal5-container .recipe-visual-card__image {
      position: absolute;
      top: 0px;
      right: 0px;
      bottom: 0px;
      left: 0px;
    }

    #modal5-container .recipe-visual-card__image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      border-radius: 10px;
      transition: opacity 0.2s ease;
    }

    #modal5-container .recipe-visual-card__footer {
      position: absolute;
      bottom: -6px;
      right: 0px;
      width: 100%;
      height: 48px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #ffffff;
      pointer-events: none;
    }

    #modal5-container .recipe-visual-card__footer h3 {
      margin-left: 8px;
      text-transform: uppercase;
      font-size: 14px;
      color: #c8c8c8;
      font-weight: 400;
    }

    #modal5-container .recipe-visual-card__button {
      position: relative;
      margin-right: 20px;
      height: 28px;
      padding: 4px 14px;
      border-radius: 8px;
      background-color: #111111;
      color: #ffffff;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
      pointer-events: auto;
    }

    #modal5-container .recipe-visual-card__button:hover,
    #modal5-container .recipe-visual-card__button:focus {
      background-color: #2a2a2a;
      outline: none;
      transform: translateY(-1px);
    }

    #modal5-container .recipe-visual-card__input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      width: 0px;
      height: 0px;
    }

    #modal5-container .recipe-visual-card__footer::before {
      position: absolute;
      content: "";
      bottom: 6px;
      left: -20px;
      background: transparent;
      width: 20px;
      height: 20px;
      border-bottom-right-radius: 10px;
      box-shadow: 5px 5px 0px 5px #ffffff;
      pointer-events: none;
    }

    #modal5-container .recipe-visual-card__footer::after {
      position: absolute;
      content: "";
      top: -20px;
      right: 6px;
      background: transparent;
      width: 20px;
      height: 20px;
      border-bottom-right-radius: 10px;
      box-shadow: 5px 5px 0px 5px #ffffff;
      pointer-events: none;
    }

    @media screen and (min-width: 848px) {
      #modal5-container .recipe-visual-card {
        border-radius: 10px;
      }

      #modal5-container .recipe-visual-card__box {
        border-radius: 10px;
      }

      #modal5-container .recipe-visual-card__image img {
        border-radius: 10px;
      }

      #modal5-container .recipe-visual-card__footer {
        width: 288px;
        right: -6px;
        border-top-left-radius: 10px;
      }

      #modal5-container .recipe-visual-card__footer h3 {
        margin-left: 16px;
      }

      #modal5-container .recipe-visual-card__footer::before {
        bottom: 6px;
        left: -20px;
        width: 20px;
        height: 20px;
        border-bottom-right-radius: 10px;
      }

      #modal5-container .recipe-visual-card__footer::after {
        top: -20px;
        right: 6px;
        width: 20px;
        height: 20px;
        border-bottom-right-radius: 10px;
      }
    }

    #modal5-container .recipe-card__controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    #modal5-container .recipe-card__picker {
      display: none;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      border: 1px solid #212121;
      border-radius: 8px;
      padding: 14px;
      background: rgba(255, 255, 255, 0.04);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
    }

    #modal5-container .recipe-card__picker.is-visible {
      display: flex;
    }

    #modal5-container .recipe-card__search {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #212121;
      background: rgba(255, 255, 255, 0.08);
      color: var(--content-color, #212121);
      font-size: 12px;
      font-weight: 500;
    }

    #modal5-container .recipe-card__list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 240px;
      overflow-y: auto;
      padding-right: 4px;
    }

    #modal5-container .recipe-card__list::-webkit-scrollbar {
      width: 6px;
    }

    #modal5-container .recipe-card__list::-webkit-scrollbar-thumb {
      background: var(--content-color, #212121);
      border-radius: 10px;
    }

    #modal5-container .recipe-card__items {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #modal5-container .recipe-item-row {
      border: 1px solid #212121;
      border-radius: 10px;
      padding: 14px 16px;
      background: rgba(255, 255, 255, 0.03);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: visible;
    }

    #modal5-container .recipe-item-row .modalRow {
      margin-left: 0;
      align-items: center;
      gap: 14px;
    }

    #modal5-container .recipe-item-suggestions {
      position: absolute;
      left: 16px;
      right: 16px;
      top: calc(100% - 4px);
      z-index: 5;
      display: none;
      flex-direction: column;
      gap: 6px;
      padding: 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(33, 33, 33, 0.6);
      box-shadow:
        0 8px 18px rgba(0, 0, 0, 0.18),
        0 2px 8px rgba(0, 0, 0, 0.12);
      max-height: 260px;
      overflow-y: auto;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }

    #modal5-container .recipe-item-suggestions.is-visible {
      display: flex;
    }

    #modal5-container .recipe-item-suggestions::-webkit-scrollbar {
      width: 6px;
    }

    #modal5-container .recipe-item-suggestions::-webkit-scrollbar-thumb {
      background: rgba(33, 33, 33, 0.6);
      border-radius: 10px;
    }

    #modal5-container .recipe-item-suggestion {
      display: flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(33, 33, 33, 0.65);
      border-radius: 8px;
      padding: 8px 10px;
      background: rgba(248, 248, 248, 0.92);
      color: #212121;
      font-size: 12px;
      font-weight: 600;
      text-transform: none;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    #modal5-container .recipe-item-suggestion:hover,
    #modal5-container .recipe-item-suggestion:focus {
      background: rgba(230, 230, 230, 0.95);
      transform: translateY(-1px);
      outline: none;
    }

    #modal5-container .recipe-item-suggestion__code {
      min-width: 90px;
      font-weight: 700;
    }

    #modal5-container .recipe-item-suggestion__name {
      flex: 1;
      font-weight: 500;
    }

    #modal5-container .recipe-item-suggestion__category {
      font-weight: 500;
      opacity: 0.75;
    }

    #modal5-container .recipe-item-suggestions__empty {
      font-size: 12px;
      font-weight: 500;
      text-align: center;
      color: rgba(33, 33, 33, 0.7);
      padding: 6px 0;
    }

    #modal5-container .recipe-picker__item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      border: 1px solid #212121;
      border-radius: 8px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--content-color, #212121);
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
      font-size: 12px;
      text-align: left;
      outline: none;
      text-decoration: none;
    }

    #modal5-container .recipe-picker__item:hover,
    #modal5-container .recipe-picker__item:focus {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-1px);
    }

    #modal5-container .recipe-picker__item span {
      pointer-events: none;
    }

    #modal5-container .recipe-picker__item span.recipe-picker__code {
      font-weight: 600;
      min-width: 90px;
    }

    #modal5-container .recipe-picker__item span.recipe-picker__name {
      flex: 1;
      white-space: normal;
    }

    #modal5-container .recipe-card__empty {
      font-size: 12px;
      opacity: 0.75;
      text-align: center;
      padding: 8px 0;
    }

    #modal5-container .button-remove {
      align-self: flex-end;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: none;
      background: transparent;
      color: var(--content-color, #212121);
      cursor: pointer;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 4px 6px;
      border-radius: 6px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    #modal5-container .button-remove:hover,
    #modal5-container .button-remove:focus {
      background: rgba(255, 255, 255, 0.12);
    }

    #modal5-container .button-form.secondary {
      background: transparent;
      color: var(--content-color, #212121);
      border-color: #212121;
    }

    #modal5-container .button-form.secondary:hover {
      background: rgba(255, 255, 255, 0.12);
      color: var(--content-color, #212121);
    }

    #modal5-container .input--error {
      border-color: #c62828;
      box-shadow: 0 0 0 1px rgba(198, 40, 40, 0.35);
    }

    #modal5-container .inputT,
    #modal5-container .input,
    #modal5-container .inputSUM {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid #212121;
      outline: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--content-color, #212121);
      transition: border-color 0.3s ease, transform 0.2s ease;
      font-variant-numeric: tabular-nums;
    }

    #modal5-container .inputT:focus,
    #modal5-container .input:focus,
    #modal5-container .inputSUM:focus {
      border-color: var(--content-color, #30333C);
      background: rgba(255, 255, 255, 0.12);
    }

    #modal5-container .inputSUM {
      text-align: right;
      width: 116px;
    }

    #modal5-container .code-field { width: 130px; text-transform: uppercase; }
    #modal5-container .name-field { width: 340px; }
    #modal5-container .url-field { width: 200px; }
    #modal5-container .supplier-field { width: 220px; }
    #modal5-container .select-wrapper {
      width: 100px;
      position: relative;
    }

    #modal5-container .select-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
      transition: border-color 0.3s ease, background 0.3s ease;
    }

    #modal5-container .select-input:focus {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.32);
    }

    #modal5-container label.checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #modal5-container .checkbox input[type="checkbox"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid var(--content-color, #212121);
      border-radius: 4px;
      position: relative;
      cursor: pointer;
      background: transparent;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    #modal5-container .checkbox input[type="checkbox"]:checked {
      background: var(--content-color, #212121);
    }

    #modal5-container .checkbox input[type="checkbox"]::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 6px;
      width: 4px;
      height: 10px;
      border: solid #f5f5f5;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    #modal5-container .checkbox input[type="checkbox"]:checked::after {
      opacity: 1;
    }

    #modal5-container .recipe-notes {
      padding-left: 40px;
      font-size: 12px;
      line-height: 1.6;
      opacity: 0.85;
      color: var(--content-color, #212121);
    }

    #modal5-container .spec-icon {
      color: var(--content-color, #212121);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    #modal5-container .spec-icon:hover {
      color: rgba(98, 90, 86, 0.85);
      transform: scale(1.05);
    }
  </style>
  
  <div class="modal-top glass-panel">
    <section class="modal5-signature">
      <h2>
        <span>R</span>
        <span>I</span>
        <span>V</span>
        <span>A</span>
        <span>&nbsp;&nbsp;</span>
        <span>D</span>
        <span>E</span>
        <span>V</span>
        <span>E</span>
        <span>L</span>
        <span>O</span>
        <span>P</span>
        <span>M</span>
        <span>E</span>
        <span>N</span>
        <span>T</span>
        <span>&nbsp;&nbsp;</span>
        <span class="warehouse-letter">R</span>
        <span class="warehouse-letter">E</span>
        <span class="warehouse-letter">C</span>
        <span class="warehouse-letter">I</span>
        <span class="warehouse-letter">P</span>
        <span class="warehouse-letter">E</span>
        <span class="warehouse-letter">S</span>
        <span>&nbsp;&nbsp;</span>
        <span class="warehouse-letter">H</span>
        <span class="warehouse-letter">U</span>
        <span class="warehouse-letter">B</span>
      </h2>
    </section>

    <div class="modalRow form-row" style="margin-top: 35px;">
      <div class="modalBLOCK form-fields">
        <div class="modalRow" style="margin-left: -20px;">
            <input id="recipe-code" class="inputT code-field" type="text" placeholder="RCP-0001" autocomplete="off"/>
            <input id="recipe-category" class="input name-field" type="text" placeholder="категория рецепта" autocomplete="off" />
            <input id="recipe-name" class="input name-field" type="text" placeholder="наименование рецепта" autocomplete="off" />
          </div>
      </div>
      <button class="button-form primary" style="margin-top: 23px;" id="create-recipe" type="button">создать рецепт</button>
    </div>
  </div>

  <div class="modal5-scroll-wrapper">
    <div class="modal-bottom glass-panel modal5-window">
      <div class="modalVNUT-content modal5-content" id="recipe-list"></div>

        <template id="recipe-card-template">
        <div class="recipe-card" data-recipe-id="">
          <div class="modalRow recipe-card__header">
            <input class="inputT code-field" data-field="recipe_code" readonly />
            <input class="input name-field" data-field="recipe_category" readonly />
            <input class="input name-field" data-field="recipe_name" readonly />
            <div class="input date-time-field" style="width: 200px;" data-field="date-time" aria-label="дата и время">
              <span class="date-time-field__time"></span>
              <span class="date-time-field__date"></span>
            </div>
            <button class="button-form secondary recipe-card__delete" type="button">удалить рецепт</button>
          </div>
          <div class="recipe-card__body">

            
            <div class="recipe-card__visual" style="width: 520px;">
              <div class="recipe-visual-card">
                <div class="recipe-visual-card__inner">
                  <div class="recipe-visual-card__box">
                    <div class="recipe-visual-card__image">
                      <img src="https://images.unsplash.com/photo-1601049676869-702ea24cfd58?q=80&w=2073&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" data-placeholder="https://images.unsplash.com/photo-1601049676869-702ea24cfd58?q=80&w=2073&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="визуал рецепта">
                    </div>
                    <div class="recipe-visual-card__footer">
                      <h3>визуал рецепта</h3>
                      <button class="recipe-visual-card__button" type="button">загрузить</button>
                      <input class="recipe-visual-card__input" type="file" accept="image/*" aria-label="загрузить изображение рецепта" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            
            <div class="recipe-card__controls">
              <button class="button-form primary recipe-card__add" type="button">добавить позицию</button>
              <div class="recipe-card__picker" aria-hidden="true">
                <input class="recipe-card__search" type="search" placeholder="Поиск по коду или наименованию" />
                <div class="recipe-card__list"></div>
                <button class="button-form secondary recipe-card__picker-close" type="button">закрыть</button>
              </div>
            </div>
            <div class="recipe-card__items"></div>
          </div>
        </div>
      </template>

      <template id="recipe-item-template">
        <div class="recipe-item-row" style="width: 1080px; padding: 0px; border: none" data-item-id="">
          <div class="modalRow">
            <label class="checkbox"><input type="checkbox" /></label>
            <input class="inputT code-field" data-field="order_code" style="width: 110px;" placeholder="RIV-0881" />
            <input class="input name-field" data-field="item_name" style="width: 280px;" placeholder="наименование" />
            <input class="input category-field" data-field="item_category" style="width: 200px;" placeholder="категория" />
            <input class="input" style="width: 60px; text-align: center;" data-field="base_unit" placeholder="изм." readonly />
            <input class="inputSUM" style="width: 70px;" data-field="base_qty" placeholder="000 000" />
            <input class="inputSUM" style="width: 70px;" data-field="base_price" placeholder="000 000 000" readonly />
            <input class="inputSUM" style="width: 100px;" data-field="total" placeholder="000 000 000" readonly />
            <button class="button-remove" type="button"><i class="material-symbols-outlined">delete</i></button>
          </div>
          <div class="recipe-item-suggestions" aria-hidden="true"></div>
        </div>
      </template>

    </div>
  </div>
</div>
<script type="module">

  const MONTHS_RU = [
  'января',
  'февраля',
  'марта',
  'апреля',
  'мая',
  'июня',
  'июля',
  'августа',
  'сентября',
  'октября',
  'ноября',
  'декабря',
];
  
export function initModal5() {
  const modal = document.getElementById('modal5-container');
  if (!modal) return;

  const supabaseClient = window.supabase ?? null;

  const recipeCodeInput = modal.querySelector('#recipe-code');
  const recipeCategoryInput = modal.querySelector('#recipe-category');
  const recipeNameInput = modal.querySelector('#recipe-name');
  const createButton = modal.querySelector('#create-recipe');
  const recipeList = modal.querySelector('#recipe-list');
  const cardTemplate = modal.querySelector('#recipe-card-template');
  const itemTemplate = modal.querySelector('#recipe-item-template');

  if (!(recipeCodeInput instanceof HTMLInputElement)
    || !(recipeCategoryInput instanceof HTMLInputElement)
    || !(recipeNameInput instanceof HTMLInputElement)
    || !(createButton instanceof HTMLButtonElement)
    || !(recipeList instanceof HTMLElement)
    || !(cardTemplate instanceof HTMLTemplateElement)
    || !(itemTemplate instanceof HTMLTemplateElement)) {
    console.warn('[modal5.html] не найдены необходимые элементы для работы рецептов');
    return;
  }

  let stockItems = [];
  let stockMap = new Map();
  let stocksLoaded = false;
  let isLoadingStocks = false;
  let refreshTimerId = null;
  const MAX_SUGGESTIONS = 20;

  const getSuggestionsContainer = row =>
    row instanceof HTMLElement ? row.querySelector('.recipe-item-suggestions') : null;

  const hideRowSuggestions = row => {
    const container = getSuggestionsContainer(row);
    if (!(container instanceof HTMLElement)) return;
    container.innerHTML = '';
    container.classList.remove('is-visible');
    container.setAttribute('aria-hidden', 'true');
  };

  const ensureSuggestionContainer = row => {
    const container = getSuggestionsContainer(row);
    if (!(container instanceof HTMLElement)) return;
    if (container.dataset.bound === '1') return;
    container.addEventListener('mousedown', event => {
      event.preventDefault();
    });
    container.dataset.bound = '1';
  };

  const scheduleHideSuggestions = row => {
    if (!(row instanceof HTMLElement)) return;
    setTimeout(() => {
      const active = document.activeElement;
      if (active instanceof Node && row.contains(active)) return;
      hideRowSuggestions(row);
    }, 120);
  };

  const clearRowStockData = row => {
    if (!(row instanceof HTMLElement)) return;
    row.dataset.itemId = '';
    row.dataset.price = '';
    const baseUnit = row.querySelector('[data-field="base_unit"]');
    if (baseUnit instanceof HTMLInputElement) {
      baseUnit.value = '';
    }
    const priceInput = row.querySelector('[data-field="base_price"]');
    if (priceInput instanceof HTMLInputElement) {
      priceInput.value = '';
      delete priceInput.dataset.raw;
    }
    const totalInput = row.querySelector('[data-field="total"]');
    if (totalInput instanceof HTMLInputElement) {
      totalInput.value = '';
    }
  };

  const renderRowSuggestions = (card, row, items) => {
    const container = getSuggestionsContainer(row);
    if (!(container instanceof HTMLElement)) return;
    container.innerHTML = '';

    const limited = items.slice(0, MAX_SUGGESTIONS);
    if (!limited.length) {
      const empty = document.createElement('div');
      empty.className = 'recipe-item-suggestions__empty';
      empty.textContent = 'Позиции не найдены';
      container.appendChild(empty);
      container.classList.add('is-visible');
      container.setAttribute('aria-hidden', 'false');
      return;
    }

    limited.forEach(item => {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = 'recipe-item-suggestion';
      const codeSpan = document.createElement('span');
      codeSpan.className = 'recipe-item-suggestion__code';
      codeSpan.textContent = item.order_code;
      const nameSpan = document.createElement('span');
      nameSpan.className = 'recipe-item-suggestion__name';
      nameSpan.textContent = item.item_name;
      const categorySpan = document.createElement('span');
      categorySpan.className = 'recipe-item-suggestion__category';
      categorySpan.textContent = item.item_category;
      button.append(codeSpan, nameSpan, categorySpan);
      button.addEventListener('click', () => {
        addItemToCard(card, item, { targetRow: row });
        hideRowSuggestions(row);
        const qtyInput = row.querySelector('[data-field="base_qty"]');
        if (qtyInput instanceof HTMLInputElement) {
          qtyInput.focus();
        }
      });
      container.appendChild(button);
    });

    container.classList.add('is-visible');
    container.setAttribute('aria-hidden', 'false');
  };

  const fmtNum = (value, { minimumFractionDigits = 0, maximumFractionDigits = minimumFractionDigits } = {}) => {
    if (value === null || value === undefined || value === '') return '';
    const num = Number(value);
    if (!Number.isFinite(num)) return '';
    const maxDigits = Math.max(minimumFractionDigits, maximumFractionDigits);
    return num.toLocaleString('ru-RU', {
      minimumFractionDigits,
      maximumFractionDigits: maxDigits,
    });
  };

  const parseNumber = value => {
    if (value === null || value === undefined) return null;
    const normalized = String(value)
      .replace(/[\s\u202f]/g, '')
      .replace(',', '.')
      .trim();
    if (!normalized) return null;
    const parsed = Number(normalized);
    return Number.isFinite(parsed) ? parsed : null;
  };

  const formatDateTime = value => {
    if (!value) return { time: '', date: '' };
    const date = value instanceof Date ? value : new Date(value);
    if (Number.isNaN(date.getTime())) return { time: '', date: '' };
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const month = MONTHS_RU[date.getMonth()] ?? '';
    const year = date.getFullYear();
    return {
      time: `${hours}:${minutes}`,
      date: month ? `${day} ${month} ${year} г.` : '',
    };
  };

  const applyDateTime = (target, value) => {
    if (!(target instanceof HTMLElement)) return;
    const { time, date } = formatDateTime(value);
    const timeEl = target.querySelector('.date-time-field__time');
    const dateEl = target.querySelector('.date-time-field__date');
    if (timeEl) timeEl.textContent = time;
    if (dateEl) dateEl.textContent = date;
    target.dataset.time = time;
    target.dataset.date = date;
  };

  const normalizeStockRow = row => {
    if (!row) return null;
    const id = row.id ?? row.order_code;
    if (!id) return null;
    const price = parseNumber(row.avg_price);
    return {
      id: String(id),
      order_code: row.order_code ?? '',
      item_name: row.item_name ?? '',
      item_category: row.item_category ?? '',
      base_unit: row.modification ?? '',
      price: price ?? null,
      url: row.url ?? '',
      supplier: row.supplier ?? '',
    };
  };

  const filterStockItems = query => {
    const normalized = String(query ?? '').trim().toLowerCase();
    if (!normalized) return stockItems;
    return stockItems.filter(item =>
      item.order_code.toLowerCase().includes(normalized)
      || item.item_name.toLowerCase().includes(normalized)
      || item.item_category.toLowerCase().includes(normalized));
  };

  const applyStockFields = (row, stock) => {
    if (!(row instanceof HTMLElement) || !stock) return;
    const setField = (field, value) => {
      const target = row.querySelector(`[data-field="${field}"]`);
      if (target instanceof HTMLInputElement) {
        target.value = value ?? '';
      }
    };
    setField('order_code', stock.order_code);
    setField('item_name', stock.item_name);
    setField('item_category', stock.item_category);
    setField('base_unit', stock.base_unit);

    const priceInput = row.querySelector('[data-field="base_price"]');
    const price = Number.isFinite(stock.price) ? stock.price : null;
    if (priceInput instanceof HTMLInputElement) {
      if (price !== null) {
        priceInput.dataset.raw = String(price);
        priceInput.value = fmtNum(price, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      } else {
        priceInput.value = '';
        delete priceInput.dataset.raw;
      }
    }
    row.dataset.price = price !== null ? String(price) : '';
  };

  const getRowPrice = row => {
    if (!(row instanceof HTMLElement)) return null;
    let price = parseNumber(row.dataset.price ?? '');
    if (price !== null) return price;
    const priceInput = row.querySelector('[data-field="base_price"]');
    if (priceInput instanceof HTMLInputElement) {
      price = parseNumber(priceInput.dataset.raw ?? priceInput.value);
    }
    return price;
  };

  const updateTotalUsingRaw = (row, qtyRaw, { formatQty = false } = {}) => {
    if (!(row instanceof HTMLElement)) return;
    const qtyInput = row.querySelector('[data-field="base_qty"]');
    const totalInput = row.querySelector('[data-field="total"]');

    if (qtyInput instanceof HTMLInputElement && formatQty) {
      if (qtyRaw === null) {
        qtyInput.value = '';
        delete qtyInput.dataset.raw;
      } else {
        qtyInput.dataset.raw = String(qtyRaw);
        qtyInput.value = fmtNum(qtyRaw, { maximumFractionDigits: 3 });
      }
    }

    if (!(totalInput instanceof HTMLInputElement)) return;
    const price = getRowPrice(row);
    if (qtyRaw === null || !Number.isFinite(price)) {
      totalInput.value = '';
      return;
    }
    const total = qtyRaw * price;
    totalInput.value = fmtNum(total, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  };

  const handleQtyInput = event => {
    const input = event.currentTarget;
    if (!(input instanceof HTMLInputElement)) return;
    const row = input.closest('.recipe-item-row');
    if (!(row instanceof HTMLElement)) return;
    const raw = parseNumber(input.value);
    updateTotalUsingRaw(row, raw, { formatQty: false });
  };

  const handleQtyFocus = event => {
    const input = event.currentTarget;
    if (!(input instanceof HTMLInputElement)) return;
    if (input.dataset.raw) {
      input.value = input.dataset.raw;
    }
  };

  const handleQtyBlur = event => {
    const input = event.currentTarget;
    if (!(input instanceof HTMLInputElement)) return;
    const row = input.closest('.recipe-item-row');
    if (!(row instanceof HTMLElement)) return;
    const raw = parseNumber(input.value);
    updateTotalUsingRaw(row, raw, { formatQty: true });
  };

  const bindQtyHandlers = row => {
    const qtyInput = row.querySelector('[data-field="base_qty"]');
    if (!(qtyInput instanceof HTMLInputElement)) return;
    if (qtyInput.dataset.boundQty === '1') return;
    qtyInput.addEventListener('input', handleQtyInput);
    qtyInput.addEventListener('focus', handleQtyFocus);
    qtyInput.addEventListener('blur', handleQtyBlur);
    qtyInput.dataset.boundQty = '1';
  };

  const bindRemoveHandler = row => {
    const removeButton = row.querySelector('.button-remove');
    if (!(removeButton instanceof HTMLButtonElement)) return;
    if (removeButton.dataset.boundRemove === '1') return;
    removeButton.addEventListener('click', () => {
      hideRowSuggestions(row);
      row.remove();
    });
    removeButton.dataset.boundRemove = '1';
  };

  const handleLookupInput = event => {
    const input = event.currentTarget;
    if (!(input instanceof HTMLInputElement)) return;
    const row = input.closest('.recipe-item-row');
    if (!(row instanceof HTMLElement)) return;
    const card = row.closest('.recipe-card');
    if (!(card instanceof HTMLElement)) return;

    clearRowStockData(row);
    input.dataset.lookupQuery = input.value;

    ensureStocksLoaded().then(() => {
      if (input.dataset.lookupQuery !== input.value) return;
      const query = input.value.trim();
      const results = query ? filterStockItems(query) : stockItems;
      renderRowSuggestions(card, row, results);
    }).catch(err => {
      console.error('[modal5.html] ошибка подстановки подсказок рецепта:', err);
    });
  };

  const handleLookupFocus = event => {
    const input = event.currentTarget;
    if (!(input instanceof HTMLInputElement)) return;
    const row = input.closest('.recipe-item-row');
    if (!(row instanceof HTMLElement)) return;
    const card = row.closest('.recipe-card');
    if (!(card instanceof HTMLElement)) return;

    ensureSuggestionContainer(row);
    ensureStocksLoaded().then(() => {
      const query = input.value.trim();
      const results = query ? filterStockItems(query) : stockItems;
      renderRowSuggestions(card, row, results);
    }).catch(err => {
      console.error('[modal5.html] ошибка показа подсказок рецепта:', err);
    });
  };

  const handleLookupBlur = event => {
    const input = event.currentTarget;
    if (!(input instanceof HTMLInputElement)) return;
    const row = input.closest('.recipe-item-row');
    if (!(row instanceof HTMLElement)) return;
    scheduleHideSuggestions(row);
  };

  const bindLookupHandlers = row => {
    const inputs = row.querySelectorAll('.code-field, .name-field, .category-field');
    inputs.forEach(field => {
      if (!(field instanceof HTMLInputElement)) return;
      if (field.dataset.boundLookup === '1') return;
      field.addEventListener('focus', handleLookupFocus);
      field.addEventListener('input', handleLookupInput);
      field.addEventListener('blur', handleLookupBlur);
      field.dataset.boundLookup = '1';
    });
    ensureSuggestionContainer(row);
  };

  const setupRecipeRow = (row, card) => {
    if (!(row instanceof HTMLElement)) return;
    bindQtyHandlers(row);
    bindRemoveHandler(row);
    bindLookupHandlers(row);
    if (card instanceof HTMLElement) {
      row.dataset.recipeId = card.dataset.recipeId ?? row.dataset.recipeId ?? '';
    }
  };

  const focusFirstEditableField = row => {
    if (!(row instanceof HTMLElement)) return;
    const field = row.querySelector('.code-field');
    if (field instanceof HTMLInputElement) {
      field.focus();
      field.select();
    }
  };

  const createRecipeItemRow = card => {
    const templateContent = itemTemplate.content?.firstElementChild;
    if (!(templateContent instanceof HTMLElement)) return null;
    const row = templateContent.cloneNode(true);
    if (!(row instanceof HTMLElement)) return null;
    row.dataset.itemId = '';
    clearRowStockData(row);
    const qtyInput = row.querySelector('[data-field="base_qty"]');
    if (qtyInput instanceof HTMLInputElement) {
      qtyInput.value = '';
      delete qtyInput.dataset.raw;
    }
    setupRecipeRow(row, card);
    const itemsContainer = card.querySelector('.recipe-card__items');
    if (!(itemsContainer instanceof HTMLElement)) return null;
    itemsContainer.appendChild(row);
    focusFirstEditableField(row);
    return row;
  };

  const addItemToCard = (card, stock, { targetRow = null } = {}) => {
    if (!(card instanceof HTMLElement)) return null;
    const itemsContainer = card.querySelector('.recipe-card__items');
    if (!(itemsContainer instanceof HTMLElement)) return null;
    const safeId = typeof CSS !== 'undefined' && typeof CSS.escape === 'function'
      ? CSS.escape(stock.id)
      : String(stock.id).replace(/"/g, '\\"');
    let row = targetRow instanceof HTMLElement ? targetRow : null;
    const existing = itemsContainer.querySelector(`.recipe-item-row[data-item-id="${safeId}"]`);
    if (existing instanceof HTMLElement && existing !== row) {
      row = existing;
      if (targetRow instanceof HTMLElement && targetRow !== existing) {
        targetRow.remove();
      }
    }

    if (!(row instanceof HTMLElement)) {
      const templateContent = itemTemplate.content?.firstElementChild;
      if (!(templateContent instanceof HTMLElement)) return null;
      row = templateContent.cloneNode(true);
      if (!(row instanceof HTMLElement)) return null;
      itemsContainer.appendChild(row);
    }

    setupRecipeRow(row, card);
    row.dataset.itemId = stock.id;
    applyStockFields(row, stock);

    const qtyInput = row.querySelector('[data-field="base_qty"]');
    if (qtyInput instanceof HTMLInputElement) {
      const hasStoredRaw = Boolean(qtyInput.dataset.raw);
      const qtyRaw = hasStoredRaw
        ? parseNumber(qtyInput.dataset.raw)
        : parseNumber(qtyInput.value);
      updateTotalUsingRaw(row, qtyRaw, { formatQty: hasStoredRaw });
    }

    return row;
  };

  const setupCardVisual = card => {
    if (!(card instanceof HTMLElement)) return () => {};
    const fileInput = card.querySelector('.recipe-visual-card__input');
    const triggerButton = card.querySelector('.recipe-visual-card__button');
    const previewImage = card.querySelector('.recipe-visual-card__image img');

    if (!(fileInput instanceof HTMLInputElement) || !(previewImage instanceof HTMLImageElement)) {
      return () => {};
    }

    const placeholder = previewImage.getAttribute('data-placeholder') || previewImage.src || '';

    const revokePreview = () => {
      const currentUrl = fileInput.dataset.previewUrl;
      if (currentUrl) {
        URL.revokeObjectURL(currentUrl);
        delete fileInput.dataset.previewUrl;
      }
    };

    const resetPreview = () => {
      if (placeholder) {
        previewImage.src = placeholder;
      } else {
        previewImage.removeAttribute('src');
      }
      try {
        fileInput.value = '';
      } catch (err) {
        /* ignore resetting file input */
      }
    };

    const updatePreview = () => {
      const file = fileInput.files && fileInput.files[0];
      revokePreview();
      if (file) {
        const objectUrl = URL.createObjectURL(file);
        fileInput.dataset.previewUrl = objectUrl;
        previewImage.src = objectUrl;
      } else {
        resetPreview();
      }
    };

    if (triggerButton instanceof HTMLButtonElement) {
      triggerButton.addEventListener('click', () => {
        try {
          fileInput.value = '';
        } catch (err) {
          /* ignore resetting file input before open */
        }
        fileInput.click();
      });
    }

    fileInput.addEventListener('change', updatePreview);

    return () => {
      revokePreview();
      resetPreview();
    };
  };
  

  const setupAddButton = card => {
    const addButton = card.querySelector('.recipe-card__add');
    if (!(addButton instanceof HTMLButtonElement)) return;
    if (addButton.dataset.boundAdd === '1') return;
    addButton.addEventListener('click', () => {
      ensureStocksLoaded().then(() => {
        createRecipeItemRow(card);
      }).catch(err => {
        console.error('[modal5.html] ошибка при добавлении строки рецепта:', err);
      });
    });
    addButton.dataset.boundAdd = '1';
  };

  const updateAllRecipeItems = () => {
    const rows = recipeList.querySelectorAll('.recipe-item-row');
    rows.forEach(row => {
      if (!(row instanceof HTMLElement)) return;
      const card = row.closest('.recipe-card');
      if (card instanceof HTMLElement) {
        setupRecipeRow(row, card);
      }
      const itemId = row.dataset.itemId;
      if (!itemId) return;
      const latest = stockMap.get(itemId);
      if (!latest) return;
      applyStockFields(row, latest);
      const qtyInput = row.querySelector('[data-field="base_qty"]');
      const hasStoredRaw = qtyInput instanceof HTMLInputElement && qtyInput.dataset.raw;
      const qtyRaw = hasStoredRaw
        ? parseNumber(qtyInput.dataset.raw)
        : parseNumber(qtyInput instanceof HTMLInputElement ? qtyInput.value : null);
      updateTotalUsingRaw(row, qtyRaw, { formatQty: Boolean(hasStoredRaw) });
    });
  };

  const createRecipeCard = data => {
    const templateContent = cardTemplate.content?.firstElementChild;
    if (!(templateContent instanceof HTMLElement)) {
      throw new Error('[modal5.html] шаблон карточки рецепта недоступен');
    }
    const card = templateContent.cloneNode(true);
    if (!(card instanceof HTMLElement)) {
      throw new Error('[modal5.html] не удалось создать карточку рецепта');
    }

    const generatedId = typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function'
      ? crypto.randomUUID()
      : `recipe-${Date.now()}-${Math.random().toString(16).slice(2)}`;
    card.dataset.recipeId = generatedId;

    const setField = (field, value) => {
      const target = card.querySelector(`[data-field="${field}"]`);
      if (target instanceof HTMLInputElement) {
        target.value = value ?? '';
      }
    };

    setField('recipe_code', data.code);
    setField('recipe_category', data.category);
    setField('recipe_name', data.name);

    const cleanupVisual = setupCardVisual(card);

    const dateField = card.querySelector('[data-field="date-time"]');
    if (dateField) {
      applyDateTime(dateField, data.createdAt);
    }

    const deleteButton = card.querySelector('.recipe-card__delete');
    if (deleteButton instanceof HTMLButtonElement) {
      deleteButton.addEventListener('click', () => {
        cleanupVisual();
        card.remove();
      });
    }

    setupAddButton(card);
    const initialRows = card.querySelectorAll('.recipe-item-row');
    initialRows.forEach(row => {
      if (row instanceof HTMLElement) {
        setupRecipeRow(row, card);
      }
    });
    return card;
  };

  const clearForm = () => {
    [recipeCodeInput, recipeCategoryInput, recipeNameInput].forEach(input => {
      input.value = '';
      input.classList.remove('input--error');
    });
  };

  const createRecipeFromForm = () => {
    const code = recipeCodeInput.value.trim();
    const category = recipeCategoryInput.value.trim();
    const name = recipeNameInput.value.trim();

    const inputs = [
      { el: recipeCodeInput, value: code },
      { el: recipeCategoryInput, value: category },
      { el: recipeNameInput, value: name },
    ];

    let hasError = false;
    inputs.forEach(({ el, value }) => {
      const empty = !value;
      el.classList.toggle('input--error', empty);
      if (empty) hasError = true;
    });

    if (hasError) return;

    const createdAt = new Date();
    const card = createRecipeCard({ code, category, name, createdAt });
    recipeList.prepend(card);
    clearForm();
  };

  const refreshStocks = async ({ silent = false } = {}) => {
    if (!supabaseClient) {
      stocksLoaded = true;
      if (!silent) {
        console.warn('[modal5.html] Supabase недоступен, складские позиции не будут загружены');
      }
      return stockItems;
    }

    if (isLoadingStocks) return stockItems;
    isLoadingStocks = true;

    try {
      const { data, error } = await supabaseClient
        .from('modal4_orders_uni')
        .select('order_code, item_name, item_category, modification, avg_price, url, supplier');

      if (error) {
        if (!silent) {
          console.error('[modal5.html] ошибка загрузки modal4_orders_uni:', error);
        }
        return stockItems;
      }

      const normalized = Array.isArray(data)
        ? data.map(normalizeStockRow).filter(Boolean)
        : [];

      stockItems = normalized;
      stockMap = new Map(normalized.map(item => [item.id, item]));
      stocksLoaded = true;
      updateAllRecipeItems();
      return stockItems;
    } finally {
      isLoadingStocks = false;
    }
  };

  const ensureStocksLoaded = async () => {
    if (stocksLoaded) return stockItems;
    return refreshStocks({ silent: true });
  };

  const scheduleStocksRefresh = () => {
    if (!supabaseClient) return;
    if (refreshTimerId) clearInterval(refreshTimerId);
    refreshTimerId = setInterval(() => {
      refreshStocks({ silent: true }).catch(err => {
        console.error('[modal5.html] ошибка фонового обновления складских позиций:', err);
      });
    }, 60_000);
  };

  const preloadedCards = recipeList.querySelectorAll('.recipe-card');
  preloadedCards.forEach(card => {
    if (!(card instanceof HTMLElement)) return;
    setupCardVisual(card);
    setupAddButton(card);
    const rows = card.querySelectorAll('.recipe-item-row');
    rows.forEach(row => {
      if (row instanceof HTMLElement) {
        setupRecipeRow(row, card);
      }
    });
  });

  createButton.addEventListener('click', createRecipeFromForm);

  [recipeCodeInput, recipeCategoryInput, recipeNameInput].forEach(input => {
    input.addEventListener('input', () => {
      input.classList.remove('input--error');
    });
  });

  if (supabaseClient) {
    refreshStocks({ silent: true }).catch(err => {
      console.error('[modal5.html] ошибка первоначальной загрузки склада:', err);
    });
    scheduleStocksRefresh();
    window.addEventListener('focus', () => {
      refreshStocks({ silent: true }).catch(err => {
        console.error('[modal5.html] ошибка обновления склада при возвращении на вкладку:', err);
      });
    });
  }

  console.log('[modal5.html] PAGE 5 активирован');
}
  
initModal5();
</script>
