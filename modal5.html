<!-- ========= modal5.html  (Проект 5) ========= -->
<div id="modal5-container">
  <style>
    #modal5-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .tab {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    .tab.active {
      background: #212121;
      color: #fff;
    }
    .page {
      width: 100%;
    }
    .page:not(.active) {
      display: none;
    }
    .history-list {
      width: 100%;
      max-width: 600px;
      margin-top: 10px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 8px;
      border-bottom: 1px solid #ddd;
    }
    .info-icon {
      margin-left: 8px;
      cursor: pointer;
      color: #007bff;
    }
    .info-icon.disabled {
      color: #6c757d;
      pointer-events: none;
    }
    #file-upload { width: 100%; max-width: 600px; margin-bottom: 10px; }
    #upload-progress { width: 100%; margin-top: 6px; }
    .under-construction {
      text-align: center;
    }
  </style>
 <div class="tabs">
    <div class="tab active" data-page="1">Page 1</div>
   <div class="tab" data-page="2">подбор попозиционный</div>
    <div class="tab" data-page="3">написание ТЗ</div>
  </div>
  <div id="page1" class="page active">
    <div id="file-upload">
      <input type="file" id="file-input" />
      <button id="upload-btn">Upload</button>
      <progress id="upload-progress" value="0" max="100" style="width:100%;display:none;"></progress>
      <div id="upload-status"></div>
    </div>
    <div id="history-list" class="history-list"></div>
  </div>
  <div id="page2" class="page">
    <p class="under-construction">страница в разработке</p>
  </div>
  <div id="page3" class="page">
    <p class="under-construction">страница в разработке</p>
  </div>
  </div>
<script type="module">
export async function initModal5() {
  console.log('[modal5.html] PAGE 5 активирован');
  const root = document.getElementById('modal5-container');
  const tabs = root.querySelectorAll('.tab');
  const pages = root.querySelectorAll('.page');
  const historyList = root.querySelector('#history-list');
  const fileInput = root.querySelector('#file-input');
  const uploadBtn = root.querySelector('#upload-btn');
  const uploadProgress = root.querySelector('#upload-progress');
  const uploadStatus = root.querySelector('#upload-status');

  // AUTH_ID уже должен быть установлен после входа

   function sanitize(name) {
    return name.replace(/[^a-z0-9.-]/gi, '_');
  }

  let selectedFile = null;
  fileInput.addEventListener('change', () => {
    selectedFile = fileInput.files[0] || null;
    console.log('[modal5] file selected:', selectedFile);
    uploadStatus.textContent = selectedFile ? `Selected: ${selectedFile.name}` : '';
  });

  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile || !window.supabase) return;
    const { data } = await supabase.auth.getSession();
    if (!data.session) {
      uploadStatus.textContent = 'Необходимо авторизоваться';
      return;
    }
    const uid = data.session.user.id;
    uploadProgress.style.display = 'block';
    uploadProgress.value = 0;
    uploadStatus.textContent = 'Uploading...';
    const safeName = sanitize(selectedFile.name);
    const safeFolder = sanitize(window.AUTH_ID || window.USER_KEY || 'anon');
    const filePath = `${safeFolder}/${Date.now()}_${safeName}`;
    const { data: upData, error } = await window.supabase.storage
      .from('user-uploads')
      .upload(filePath, selectedFile, { upsert: true });
    if (error) {
      console.error('[modal5] upload error:', error);
      uploadStatus.textContent = 'Upload error: ' + error.message;
      return;
    }
    console.log('[modal5] upload complete:', upData);
    uploadProgress.value = 100;
    uploadStatus.textContent = 'Файл загружен';
    await insertRequestRow(upData.path, uid);
  });

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      if (tab.classList.contains('active')) return;
      const id = tab.dataset.page;
      const nextPage = root.querySelector('#page' + id);
      const activeTab = root.querySelector('.tab.active');
      const activePage = root.querySelector('.page.active');
      const switchPage = () => {
        activeTab && activeTab.classList.remove('active');
        activePage && activePage.classList.remove('active');
        tab.classList.add('active');
        nextPage.classList.add('active');
      };
      if (document.startViewTransition) {
        document.startViewTransition(switchPage);
      } else {
        switchPage();
      }
    });
  });
  let history = [];

  async function loadHistory() {
    if (!window.supabase || !window.AUTH_ID) return;
    const { data } = await window.supabase
     .from('requests')
      .select('id, file_path, response_path, status')
      .eq('user_id', window.AUTH_ID)
      .order('created_at', { ascending: false });
    console.log('[modal5] history loaded:', data);
    history = Array.isArray(data) ? data : [];
    renderHistory();
  }

  function renderHistory() {
    if (!historyList) return;
    historyList.innerHTML = '';
    for (const item of history) {
      const row = document.createElement('div');
      row.className = 'history-item';
      const left = document.createElement('div');
      const nameEl = document.createElement('span');
      nameEl.textContent = item.file_path.split('/').pop();
      const statusEl = document.createElement('span');
      statusEl.style.marginLeft = '8px';
      statusEl.textContent = item.response_path ? 'завершено' : 'в работе';
      left.appendChild(nameEl);
      left.appendChild(statusEl);
      const icon = document.createElement('span');
      icon.className = 'info-icon';
      icon.textContent = 'ⓘ';
      if (!item.response_path) {
        icon.classList.add('disabled');
      } else {
        icon.addEventListener('mouseenter', async () => {
          if (icon.dataset.answer) return;
          const { data } = await window.supabase.storage
            .from('user-uploads')
            .download(item.response_path);
          if (data) {
            const text = await data.text();
            icon.dataset.answer = text;
            icon.title = text;
            icon.classList.remove('disabled');
            console.log('[modal5] answer loaded for', item.file_path);
          }
        }, { once: true });
      }
      icon.addEventListener('click', () => {
        if (icon.dataset.answer) {
          navigator.clipboard.writeText(icon.dataset.answer);
        }
      }, { once: true });
      row.appendChild(left);
      row.appendChild(icon);
      historyList.appendChild(row);
    }
  }

 async function insertRequestRow(filePath, uid) {
    if (!window.supabase) return;
    if (!uid) return;
    try {
      const { data, error } = await window.supabase
        .from('requests')
        .insert({ user_id: uid, file_path: filePath, status: 'uploaded' })
        .select('id')
        .single();
      console.log('[modal5] db insert:', data, error);
      if (error) {
        uploadStatus.textContent = 'Insert error: ' +
          (error.message || error.description || JSON.stringify(error));
        return;
      }
      if (data) {
        uploadStatus.textContent = 'Загрузка завершена, запрос сохранён';
        await invokeEquipSelector(data.id);
        await loadHistory();
      }
    } catch (err) {
      console.log('[modal5] insertRequestRow error:', err);
    }
  }

  async function invokeEquipSelector(requestId) {
    try {
      console.log('[modal5] invoking equip-selector', requestId);
      const { data, error } = await window.supabase.functions.invoke('equip-selector', {
        body: { request_id: requestId, save: true }
      });
      console.log('[modal5] equip-selector result:', data, error);
      if (error) {
        uploadStatus.textContent = 'Function error';
        return;
      }
      uploadStatus.textContent = 'Файл обработан успешно';
    } catch (err) {
      console.log('[modal5] invokeEquipSelector error:', err);
    }
  }

  await loadHistory();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initModal5);
} else {
  initModal5();
}
</script>
