<!-- ========= modal5.html  (Проект 5) ========= -->
<div id="modal5-container">
  <style>
    #modal5-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .tab {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    .tab.active {
      background: #212121;
      color: #fff;
    }
    .page {
      width: 100%;
    }
    .page:not(.active) {
      display: none;
    }
    .history-list {
      width: 100%;
      max-width: 600px;
      margin-top: 10px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 8px;
      border-bottom: 1px solid #ddd;
    }
    .history-item .status {
      margin-left: 8px;
      color: #6c757d;
    }
    .info-icon {
      margin-left: 8px;
      cursor: pointer;
      color: #007bff;
    }
    .info-icon.disabled {
      color: #6c757d;
      pointer-events: none;
    }
    #file-upload { width: 100%; max-width: 600px; margin-bottom: 10px; }
    #prompt-input { width: 100%; max-width: 600px; margin: 6px 0; }
    #upload-progress { width: 100%; margin-top: 6px; }
    .under-construction {
      text-align: center;
    }
  </style>
 <div class="tabs">
    <div class="tab active" data-page="1">Page 1</div>
   <div class="tab" data-page="2">подбор попозиционный</div>
    <div class="tab" data-page="3">написание ТЗ</div>
  </div>
  <div id="page1" class="page active">
    <div id="file-upload">
      <input type="file" id="file-input" />
      <button id="upload-btn">Upload</button>
      <progress id="upload-progress" value="0" max="100" style="width:100%;display:none;"></progress>
      <div id="upload-status"></div>
    </div>
    <div id="history-list" class="history-list"></div>
  </div>
  <div id="page2" class="page">
    <p class="under-construction">страница в разработке</p>
  </div>
  <div id="page3" class="page">
    <p class="under-construction">страница в разработке</p>
  </div>
  </div>
<script type="module">
/* ------------- глобальный supabase берём из window ------------ */
const supabase = window.supabase;

/* -------------------- DOM ------------------- */
const root            = document.getElementById('modal5-container');
const tabs            = root.querySelectorAll('.tab');
const pages           = root.querySelectorAll('.page');
const historyList     = root.querySelector('#history-list');
const fileInput       = root.querySelector('#file-input');
const uploadBtn       = root.querySelector('#upload-btn');
const uploadProgress  = root.querySelector('#upload-progress');
const uploadStatus    = root.querySelector('#upload-status');

/* -------------- helpers --------------------- */
const sanitize = (s) => s
  .normalize('NFKD')
  .replace(/[\u0300-\u036f]/g, '')
  .replace(/[^a-z0-9._-]/gi, '_');

let selectedFile = null;
fileInput.addEventListener('change', () => {
  selectedFile = fileInput.files[0] || null;
  uploadStatus.textContent = selectedFile ? `Выбран: ${selectedFile.name}` : '';
});

/* ------- загрузка файла + insert + invoke --- */
uploadBtn.addEventListener('click', async () => {
  if (!selectedFile) return;

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) { uploadStatus.textContent = 'Необходим вход'; return; }

  const safeName   = sanitize(selectedFile.name);
  const safeFolder = sanitize(session.user.id);
  const filePath   = `${safeFolder}/${Date.now()}_${safeName}`;

  uploadProgress.style.display = 'block';
  uploadProgress.value   = 0;
  uploadStatus.textContent = 'Загружаю…';


 /* 1. Storage */
  const { error: upErr } = await supabase
    .storage
    .from('user-uploads')
    .upload(filePath, selectedFile, { upsert: true });

  if (upErr) { uploadStatus.textContent = 'Ошибка upload: ' + upErr.message; return; }
  uploadProgress.value = 100;

  /* 2. INSERT */
  const { data: reqRow, error: insErr } = await supabase
    .from('requests')
    .insert({ user_id: session.user.id, file_path: filePath, status: 'pending' })
    .select('*')
    .single();

  if (insErr) { uploadStatus.textContent = 'Ошибка insert'; return; }

  /* 3. INVOKE (без prompt) */
  uploadStatus.textContent = 'GPT обрабатывает…';

  const { data: funcRes, error: funcErr } = await supabase.functions.invoke(
    'equip-selector',
    { body: { request_id: reqRow.id, save: true } }
  );

  if (funcErr) {
    console.error('[modal5] function error:', funcErr);
    uploadStatus.textContent = 'Ошибка функции: ' + funcErr.message;
  } else {
    uploadStatus.textContent = 'Готово!';
    console.log('[modal5] GPT answer:', funcRes?.csv);
  }

  /* 4. Перезагружаем историю */
  await loadHistory();
});

/* -------------- история --------------------- */
let history = [];
async function loadHistory() {
  const { data, error } = await supabase
    .from('requests')
    .select('id, file_path, response_path, status')
    .eq('user_id', window.AUTH_ID)
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  history = data || [];
  renderHistory();
}

function renderHistory() {
  historyList.innerHTML = '';
  history.forEach(item => {
    const row   = document.createElement('div');
    row.className = 'history-item';

    const left  = document.createElement('div');
    const name  = document.createElement('span');
    name.textContent = item.file_path.split('/').pop();
    const status = document.createElement('span');
    status.className = 'status';

    const isDone = (item.status === 'done') || !!item.response_path;
    status.textContent = isDone ? 'завершено' : 'в работе';
    left.append(name, status);

    /* info-icon */
    const icon = document.createElement('span');
    icon.className = 'info-icon';
    icon.textContent = 'ⓘ';
    if (!isDone) icon.classList.add('disabled');

    icon.addEventListener('click', async () => {
      if (!isDone) return;
      if (!icon.dataset.answer) {
        const { data } = await supabase
          .storage
          .from('user-uploads')
          .download(item.response_path);
        icon.dataset.answer = data ? await data.text() : 'Ответ недоступен';
      }
      alert(icon.dataset.answer);
      await navigator.clipboard.writeText(icon.dataset.answer);
    });

    row.append(left, icon);
    historyList.appendChild(row);
  });
}

/* -------------- вкладки --------------------- */
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.classList.contains('active')) return;
    tabs.forEach(t => t.classList.remove('active'));
    pages.forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    root.querySelector('#page' + tab.dataset.page).classList.add('active');
  });
});

/* -------------- init ------------------------ */
await loadHistory();
</script>
