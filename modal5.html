<!-- ========= modal5.html  (Проект 5) ========= -->
<div id="modal5-container">
  <style>
    #modal5-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .tab {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    .tab.active {
      background: #212121;
      color: #fff;
    }
    .page {
      width: 100%;
    }
    .page:not(.active) {
      display: none;
    }
    #chat-window {
      width: 100%;
      max-width: 600px;
      height: 400px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      overflow-y: auto;
      margin-bottom: 10px;
      background: #fafafa;
    }
    .msg {
      margin-bottom: 8px;
      padding: 6px 8px;
      border-radius: 6px;
      max-width: 90%;
    }
    .msg.user { background: #dcf8c6; align-self: flex-end; }
    .msg.assistant { background: #f1f0f0; align-self: flex-start; }
    #chat-form {
      width: 100%;
      max-width: 600px;
      display: flex;
      gap: 8px;
    }
    #chat-input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #chat-send {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: #212121;
      color: #fff;
      cursor: pointer;
    }
    #file-upload { width: 100%; max-width: 600px; margin-bottom: 10px; }
    #upload-progress { width: 100%; margin-top: 6px; }
    .under-construction {
      text-align: center;
    }
  </style>
 <div class="tabs">
    <div class="tab active" data-page="1">Page 1</div>
   <div class="tab" data-page="2">подбор попозиционный</div>
    <div class="tab" data-page="3">написание ТЗ</div>
  </div>
  <div id="page1" class="page active">
    <div id="file-upload">
      <input type="file" id="file-input" />
      <button id="upload-btn">Upload</button>
      <progress id="upload-progress" value="0" max="100" style="width:100%;display:none;"></progress>
      <div id="upload-status"></div>
    </div>
    <div id="chat-window"></div>
    <form id="chat-form">
      <input type="text" id="chat-input" placeholder="Ваш вопрос" autocomplete="off" />
      <button id="chat-send">Send</button>
    </form>
    <textarea id="csv-result" placeholder="CSV result will appear here" style="width:100%;height:120px;margin-top:10px" readonly></textarea>
  </div>
  <div id="page2" class="page">
    <p class="under-construction">страница в разработке</p>
  </div>
  <div id="page3" class="page">
    <p class="under-construction">страница в разработке</p>
  </div>
  </div>
<script type="module">
export async function initModal5() {
  console.log('[modal5.html] PAGE 5 активирован');
  const root = document.getElementById('modal5-container');
  const tabs = root.querySelectorAll('.tab');
  const pages = root.querySelectorAll('.page');
  const chatWindow = root.querySelector('#chat-window');
  const form = root.querySelector('#chat-form');
  const input = root.querySelector('#chat-input');
  const fileInput = root.querySelector('#file-input');
  const uploadBtn = root.querySelector('#upload-btn');
  const uploadProgress = root.querySelector('#upload-progress');
  const uploadStatus = root.querySelector('#upload-status');
  const csvResult = root.querySelector('#csv-result');

  // Получаем текущую сессию пользователя для определения AUTH_ID
  if (window.supabase) {
    try {
      const { data: { session } } = await window.supabase.auth.getSession();
      if (session?.user?.id) {
        window.AUTH_ID = session.user.id;
      } else {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (user?.id) {
          window.AUTH_ID = user.id;
        }
      }
    } catch (e) {
      console.log('[modal5] auth session error:', e);
    }
  }

   function sanitize(name) {
    return name.replace(/[^a-z0-9.-]/gi, '_');
  }

  let selectedFile = null;
  fileInput.addEventListener('change', () => {
    selectedFile = fileInput.files[0] || null;
    console.log('[modal5] file selected:', selectedFile);
    uploadStatus.textContent = selectedFile ? `Selected: ${selectedFile.name}` : '';
  });

  uploadBtn.addEventListener('click', async () => {
    if (!selectedFile || !window.supabase) return;
    uploadProgress.style.display = 'block';
    uploadProgress.value = 0;
    uploadStatus.textContent = 'Uploading...';
    const safeName = sanitize(selectedFile.name);
    const filePath = `${window.USER_KEY || 'anon'}/${Date.now()}_${safeName}`;
    const { data, error } = await window.supabase.storage
      .from('user-uploads')
      .upload(filePath, selectedFile, { upsert: true });
    if (error) {
      console.log('[modal5] upload error:', error);
      uploadStatus.textContent = 'Upload error';
      return;
    }
    console.log('[modal5] upload complete:', data);
    uploadProgress.value = 100;
    uploadStatus.textContent = 'File uploaded';
    await insertRequestRow(data.path);
  });

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      if (tab.classList.contains('active')) return;
      const id = tab.dataset.page;
      const nextPage = root.querySelector('#page' + id);
      const activeTab = root.querySelector('.tab.active');
      const activePage = root.querySelector('.page.active');
      const switchPage = () => {
        activeTab && activeTab.classList.remove('active');
        activePage && activePage.classList.remove('active');
        tab.classList.add('active');
        nextPage.classList.add('active');
      };
      if (document.startViewTransition) {
        document.startViewTransition(switchPage);
      } else {
        switchPage();
      }
    });
  });
  let history = [];

  async function loadHistory() {
    console.log('[modal5] loadHistory start');
    if (!window.supabase || !window.USER_KEY) return;
    const { data } = await window.supabase
      .from('chat_messages')
      .select('*')
      .eq('user_key', window.USER_KEY)
      .order('created_at');
    if (Array.isArray(data)) {
      history = data;
      console.log('[modal5] loadHistory data:', history);
      render();
    }
  }

  function render() {
    console.log('[modal5] render', history);
    chatWindow.innerHTML = '';
    for (const m of history) {
      const div = document.createElement('div');
      div.className = `msg ${m.role}`;
      div.textContent = m.content;
      chatWindow.appendChild(div);
    }
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  async function saveMessage(role, content) {
    console.log('[modal5] saveMessage', role, content);
    if (!window.supabase || !window.USER_KEY) return;
    const { data } = await window.supabase
      .from('chat_messages')
      .insert({ user_key: window.USER_KEY, role, content })
      .select('*')
      .single();
    if (data) {
      history.push(data);
      console.log('[modal5] saveMessage stored', data);
    }
  }

  async function askGpt(question) {
    console.log('[modal5] askGpt', question);
    const { data, error } = await window.supabase.functions.invoke('ask-gpt', {
      body: {
        question,
        history: history.map(h => ({ role: h.role, content: h.content }))
      }
    });
    if (error) {
      console.error('[modal5] askGpt error', error);
      return '';
    }
    const answer = data?.answer || '';
    console.log('[modal5] askGpt reply', answer);
    return answer;
  }

  async function insertRequestRow(filePath) {
    if (!window.supabase || !window.AUTH_ID) return;
    try {
      const { data, error } = await window.supabase
        .from('requests')
        .insert({ user_id: window.AUTH_ID, file_path: filePath, status: 'uploaded' })
        .select('id')
        .single();
      console.log('[modal5] db insert:', data, error);
      if (error) {
        uploadStatus.textContent = 'Insert error';
        throw error;
      }
      if (data) {
        uploadStatus.textContent = 'Request saved';
        await invokeEquipSelector(data.id);
      }
    } catch (err) {
      console.log('[modal5] insertRequestRow error:', err);
    }
  }

  async function invokeEquipSelector(requestId) {
    try {
      console.log('[modal5] invoking equip-selector', requestId);
      const { data, error } = await window.supabase.functions.invoke('equip-selector', {
        body: { request_id: requestId }
      });
      console.log('[modal5] equip-selector result:', data, error);
      if (error) {
        uploadStatus.textContent = 'Function error';
        return;
      }
      if (csvResult) {
        csvResult.value = typeof data === 'string' ? data : JSON.stringify(data);
      }
    } catch (err) {
      console.log('[modal5] invokeEquipSelector error:', err);
    }
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;
    input.value = '';
    await saveMessage('user', text);
    render();
    let reply = '...';
    render();
    try {
      reply = await askGpt(text);
    } catch (e) {
      reply = 'Ошибка обращения к API';
    }
    await saveMessage('assistant', reply);
    render();
  });

  await loadHistory();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initModal5);
} else {
  initModal5();
}
</script>
