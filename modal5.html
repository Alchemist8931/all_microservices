<!-- ========= modal5.html  (Проект 5) ========= -->
<div id="modal5-container" class="spec-modal">
  <style>
    .spec-modal {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      padding: 10px;
      box-sizing: border-box;
    }
    .spec-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    .spec-tab {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    .spec-page:not(.active) {
      background: #212121;
      color: #fff;
    }
    .spec-page {
      width: 100%;
    }
    .page:not(.active) {
      display: none;
    }
    .spec-history-list {
      width: 100%;
      max-width: 600px;
      margin-top: 10px;
    }
    .spec-history-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 8px;
      border-bottom: 1px solid #ddd;
    }
    .spec-history-item .status {
      margin-left: 8px;
      color: #6c757d;
    }
    .spec-info-icon {
      margin-left: 8px;
      cursor: pointer;
      color: #007bff;
    }
    .spec-info-icon.disabled {
      color: #6c757d;
      pointer-events: none;
    }
    .spec-row {
      width: 100%;
      max-width: 600px;
      margin-bottom: 10px;
    }
    .spec-input-group {
      display: flex;
      gap: 8px;
    }
    .spec-upload-progress {
      width: 100%;
      margin-top: 6px;
    }
    .spec-under-construction {
      text-align: center;
    }
    .spec-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .spec-box {
      background: #fff;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
      padding: 24px;
      border-radius: 10px;
      position: relative;
    }
    .spec-close {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 24px;
      background: none;
      border: none;
      cursor: pointer;
    }
    .spec-table {
      border-collapse: collapse;
      width: 100%;
    }
    .spec-table th,
    .spec-table td {
      border: 1px solid #ddd;
      padding: 4px 8px;
    }
  </style>
 <div class="tabs spec-tabs">
    <div class="tab spec-tab active" data-page="1">Page 1</div>
    <div class="tab spec-tab" data-page="2">подбор попозиционный</div>
    <div class="tab spec-tab" data-page="3">написание ТЗ</div>
  </div>
  <div class="page spec-page active" data-page="1">
    <div class="file-upload spec-row">
      <div class="spec-input-group">
        <input type="file" class="file-input" />
        <button class="upload-btn">Upload</button>
      </div>
      <progress class="upload-progress spec-upload-progress" value="0" max="100" style="width:100%;display:none;"></progress>
      <div class="upload-status"></div>
    </div>
    <div class="history-list spec-history-list"></div>
  </div>
  <div class="page spec-page" data-page="2">
    <p class="under-construction spec-under-construction">страница в разработке</p>
  </div>
  <div class="page spec-page" data-page="3">
    <p class="under-construction spec-under-construction">страница в разработке</p>
  </div>
  </div>
<script type="module">
/* ------------- глобальный supabase берём из window ------------ */
const supabase = window.supabase;

/* -------------------- DOM ------------------- */
const root            = document.getElementById('modal5-container');
const tabs            = root.querySelectorAll('.tab');
const pages           = root.querySelectorAll('.page');
const historyList     = root.querySelector('.history-list');
const fileInput       = root.querySelector('.file-input');
const uploadBtn       = root.querySelector('.upload-btn');
const uploadProgress  = root.querySelector('.upload-progress');
const uploadStatus    = root.querySelector('.upload-status');

/* -------------- helpers --------------------- */
const sanitize = (s) => s
  .normalize('NFKD')
  .replace(/[\u0300-\u036f]/g, '')
  .replace(/[^a-z0-9._-]/gi, '_');

  /* ----------- CSV -> DOM спецификация ----------- */
function parseCsvToSpec(csvText = '') {
  const rows = csvText.trim().split(/\r?\n/);
  const wrapper = document.createElement('div');
  wrapper.className = 'spec-content';

  const table = document.createElement('table');
  table.className = 'spec-table';

  rows.forEach((rowText, rowIndex) => {
    if (!rowText.trim()) return;
    const tr = document.createElement('tr');
    rowText.split(';').forEach(cellText => {
      const cell = document.createElement(rowIndex === 0 ? 'th' : 'td');
      cell.textContent = cellText.trim();
      tr.appendChild(cell);
    });
    table.appendChild(tr);
  });

  wrapper.appendChild(table);
  return wrapper;
}

let selectedFile = null;
fileInput.addEventListener('change', () => {
  selectedFile = fileInput.files[0] || null;
  uploadStatus.textContent = selectedFile ? `Выбран: ${selectedFile.name}` : '';
});

/* ------- загрузка файла + insert + invoke --- */
uploadBtn.addEventListener('click', async () => {
  if (!selectedFile) return;

  const { data: { session } } = await supabase.auth.getSession();
  if (!session) { uploadStatus.textContent = 'Необходим вход'; return; }

  const safeName   = sanitize(selectedFile.name);
  const safeFolder = sanitize(session.user.id);
  const filePath   = `${safeFolder}/${Date.now()}_${safeName}`;

  uploadProgress.style.display = 'block';
  uploadProgress.value   = 0;
  uploadStatus.textContent = 'Загружаю…';


 /* 1. Storage */
  const { error: upErr } = await supabase
    .storage
    .from('user-uploads')
    .upload(filePath, selectedFile, { upsert: true });

  if (upErr) { uploadStatus.textContent = 'Ошибка upload: ' + upErr.message; return; }
  uploadProgress.value = 100;

  /* 2. INSERT */
  const { data: reqRow, error: insErr } = await supabase
    .from('requests')
    .insert({ user_id: session.user.id, file_path: filePath, status: 'pending' })
    .select('*')
    .single();

  if (insErr) { uploadStatus.textContent = 'Ошибка insert'; return; }

  /* 3. INVOKE (без prompt) */
  uploadStatus.textContent = 'GPT обрабатывает…';

  const { data: funcRes, error: funcErr } = await supabase.functions.invoke(
    'equip-selector',
    { body: { request_id: reqRow.id, save: true } }
  );

  if (funcErr) {
    console.error('[modal5] function error:', funcErr);
    uploadStatus.textContent = 'Ошибка функции: ' + funcErr.message;
  } else {
    uploadStatus.textContent = 'Готово!';
    console.log('[modal5] GPT answer:', funcRes?.csv);
  }

  /* 4. Перезагружаем историю */
  await loadHistory();
});

/* -------------- история --------------------- */
let history = [];
async function loadHistory() {
  const { data, error } = await supabase
    .from('requests')
    .select('id, file_path, response_path, status')
    .eq('user_id', window.AUTH_ID)
    .order('created_at', { ascending: false });

  if (error) { console.error(error); return; }
  history = data || [];
  renderHistory();
}

/* ---------- отрисовка истории запросов ---------- */
function renderHistory() {
  historyList.innerHTML = '';

  /* маленький helper для модального окна со спецификацией */
  const showAnswerModal = (csvText) => {
    document.querySelectorAll('.spec-overlay').forEach(el => el.remove());


    const overlay = document.createElement('div');
    overlay.className = 'spec-overlay';
    const box = document.createElement('div');
    box.className = 'spec-box';
    const content = parseCsvToSpec(csvText || '');
    const close = document.createElement('button');
    close.className = 'spec-close';
    close.textContent = '×';
    close.addEventListener('click', () => overlay.remove());
    box.appendChild(close);
    box.appendChild(content);
    overlay.appendChild(box);
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) overlay.remove();
    });

    document.body.appendChild(overlay);
  };

  /* цикл по запросам */
  history.forEach((item) => {
    const isDone = item.status === 'done' || !!item.response_path;

    /* строка истории */
    const row = document.createElement('div');
    row.className = 'history-item spec-history-item';

    /* левая часть: имя файла + статус */
    const left  = document.createElement('div');

    const name  = document.createElement('span');
    name.textContent = item.file_path.split('/').pop();

    const status = document.createElement('span');
    status.className = 'status';
    status.textContent = isDone ? 'завершено' : 'в работе';

    left.append(name, status);

    /* иконка info */
    const icon = document.createElement('span');
     icon.className = 'info-icon spec-info-icon';
    icon.textContent = 'ⓘ';
    if (!isDone) icon.classList.add('disabled');

    icon.addEventListener('click', async () => {
      if (!isDone) return;

      /* кэшируем ответ, чтобы не качать повторно */
      if (!icon.dataset.answer) {
        const { data } = await supabase
          .storage
          .from('user-uploads')
          .download(item.response_path);

        icon.dataset.answer = data ? await data.text() : 'Ответ недоступен';
      }

      /* показываем модальное окно */
      showAnswerModal(icon.dataset.answer);
    });

    row.append(left, icon);
    historyList.appendChild(row);
  });
}
  
/* -------------- вкладки --------------------- */
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    if (tab.classList.contains('active')) return;
    tabs.forEach(t => t.classList.remove('active'));
    pages.forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    root.querySelector(`[data-page="${tab.dataset.page}"]`).classList.add('active');
  });
});

/* -------------- init ------------------------ */
await loadHistory();
</script>
